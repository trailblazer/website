<!DOCTYPE html>
<html class="no-js" lang="en">
  <head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<title>Trailblazer: Operation API</title>
<meta name="description" content="Operation API - Trailblazer">
<meta name="viewport" content="width=device-width, initial-scale=1">
<meta name="keywords" content=", ">

<!-- style -->
<link rel="shortcut icon" href="../../../favicon.ico">
<link href="http://fonts.googleapis.com/css?family=Open+Sans:300,%20400,700,800%7CRaleway:400,200,700" rel="stylesheet" type="text/css">
<link rel="stylesheet" href="../../../css/application.css">

<!-- script -->
<script src="../../../javascripts/jquery.min.js"></script>
<script src="../../../javascripts/application.min.js"></script>
<script>
  jQuery(document).ready(function($) {
    $(document).foundation();

    anchors.add("article h2");
    anchors.add("article h3");

    hljs.configure({
      languages: ['ruby', 'haml']
    });

    hljs.initHighlightingOnLoad();

    // $('#code-slider').slick({arrows: true, dots: true});
    $('.carousel').slick({arrows: true, dots: true});
  });
</script>


<meta property="og:title" content="Operation API">
<meta property="og:site_name" content="Trailblazer">
<meta property="og:url" content="http://trailblazer.to/gems/operation/2.0/api.html">
<meta property="og:description" content="">
<meta property="og:image" content="http://trailblazer.to/images/go-trailblazer.jpg">
<meta name="twitter:card" content="summary">
<meta name="twitter:site" content="@apotonick">
<meta name="twitter:title" content="Operation API">
<meta name="twitter:description" content="">
<meta name="twitter:image" content="http://trailblazer.to/images/go-trailblazer.jpg">

  </head>
  <body>


  <!--
    <div class="secondary callout" data-closable>
      <strong>TRB JOBS:</strong> Deutschsprachiger Ruby Developer in Hannover - <a href="/inc/jobs.html">Jaaaa!</a>
      <button class="close-button" aria-label="Dismiss alert" type="button" data-close>
        <span aria-hidden="true">&times;</span>
      </button>
    </div>
  -->

      <a class="notice" style="display: block; overflow: hidden; position: relative; width: 100%; padding: 0.6rem 0; background-color: #3b5998;" href="http://fb.me/trailblazer.to">
    <div class="info" style="text-align: center;">
      <h5 style="font-size: 0.9rem; color: white; font-weight: bold;">
        <i class="fa fa-facebook-square" aria-hidden="true" style="font-size: 1.2rem;"></i>
        LIKE US FOR UPDATES + GET A FREE STICKER PACK!
      </h5>
    </div>
  </a>


    <div data-sticky-container class="top-navbar">
  <div class="top-bar sticky" data-sticky data-options="marginTop:0;" style="width:100%">
    <div class="top-bar-title">
      <ul class="menu horizontal">
        <li>
          <a href="../../../index.html"><img style="height: 25px;" src="../../../images/logo-top.svg"></a>
        </li>
        <li>
        <span data-responsive-toggle="responsive-menu" data-hide-for="medium">
          <button class="menu-icon" type="button" data-toggle></button>
        </span>
        </li>
      </ul>
    </div>

    <div id="responsive-menu">
      <div class="top-bar-right">
        <ul class="dropdown menu     vertical medium-horizontal" data-dropdown-menu>
          <li><a href="../../../blog/2017-12-trailblazer-2-1-what-you-need-to-know.html">TRB 2.1 IS COMING!</a></li>
          <li><a href="https://trbpro.herokuapp.com/">PREMIUM SUPPORT <img alt="Premium Support" src="../../../images/pro-white.png"></a></li>
          <li><a href="../../../newsletter.html">NEWSLETTER</a></li>
          <li><a href="https://gitter.im/trailblazer/chat" onclick="trackOutboundLink('https://gitter.im/trailblazer/chat'); return false;">CHAT</a></li>
          <li><a href="../../../guides.html">LEARN</a></li>
          <li>
            <a href="api.html#">GEMS</a>
            <ul class="menu vertical">
              <li class=""><a href="../../cells.html">CELLS</a></li>
              <li class=""><a href="index.html">OPERATION</a></li>
              <li class=""><a href="../../reform.html">REFORM</a></li>
              <li class=""><a href="../../representable.html">REPRESENTABLE</a></li>
              <li class=""><a href="../../roar.html">ROAR</a></li>
              <li class=""><a href="../../formular.html">FORMULAR</a></li>
              <li class=""><a href="../../disposable.html">DISPOSABLE</a></li>
            </ul>
          </li>
          <li>
            <a href="https://leanpub.com/trailblazer" class="button secondary" onclick="trackOutboundLink('https://leanpub.com/trailblazer'); return false;">GET THE BOOK</a>
          </li>
        </ul>
      </div>
    </div>
  </div>
</div>


    <!-- Hero -->
<div class="hero gems-hero operation2-hero">
  <div class="hero-unit">
    <div class="expanded row">
      <div class="columns">
        <h1 id="project_title">
          Operation
        </h1>
      </div>
    </div>
  </div>
</div>


    <div class="expanded row">
      <div class="medium-9 large-10 medium-push-3 large-push-2 columns">
        <article class="operation2-body">

          
            <header id="doc-header">
  <h1 class="doc-page-title">Operation API</h1>
  <span class="doc-last-updated"><i class="fa fa-clock-o" aria-hidden="true"></i> Last updated 29 August 2017</span>

  
    <span class="doc-last-updated">
      <i class="fa fa-diamond" aria-hidden="true"></i>
      <a href="https://github.com/trailblazer/trailblazer">trailblazer</a>

      <a href="api.html">
      <span class="version">v2.0</span>
      </a>

    
      <a href="../1.1/api.html">
        <span class="version other">v1.1</span>
      </a>
    

    </span>
  

  <hr>

</header>

          

          <div class="row"> <!-- nach doc header -->
            <div class="large-9 columns" id="docs">   <!-- actual docs -->
              <p>This document describes Trailblazer’s <code class="highlighter-rouge">Operation</code> API.</p>

<div class="callout">
  
<p>The generic implementation can be found in the <a href="https://github.com/trailblazer/trailblazer-operation">trailblazer-operation gem</a>. This gem only provides the pipe and dependency handling.</p>

<p>Higher-level abstractions, such as form object or policy integration, are implemented in the <a href="https://github.com/trailblazer/trailblazer">trailblazer gem</a>.</p>

</div>

<h2 id="invocation" data-magellan-target="invocation">Invocation</h2>

<p>An operation is designed like a function and it can only be invoked in one way: via <code class="highlighter-rouge">Operation::call</code>.</p>

<div class="highlighter-rouge">
<pre class="highlight"><code>Song::Create.call( name: "Roxanne" )
</code></pre>
</div>

<p>Ruby allows a shorthand for this which is commonly used throughout Trailblazer.</p>

<div class="highlighter-rouge">
<pre class="highlight"><code>Song::Create.( name: "Roxanne" )
</code></pre>
</div>

<p>The absence of a method name here is per design: this object does only one thing, and hence <em>what it does is reflected in the class name</em>.</p>

<p>Running an operation will always return its <a href="api.html#result-object">→ result object</a>. It is up to you to interpret the content of it or push data onto the result object during the operation’s cycle.</p>

<div class="highlighter-rouge">
<pre class="highlight"><code>result = Create.call( name: "Roxanne" )

result["model"] #=&gt; #&lt;Song name: "Roxanne"&gt;
</code></pre>
</div>

<h3 id="invocation-dependencies">Invocation: Dependencies</h3>

<p>Dependencies other than the params input, such as a current user, are passed via the second argument.</p>

<pre><code>result = Create.( { title: "Roxanne" }, "current_user" =&gt; current_user )
</code></pre>

<p>External dependencies will be accessible via <code class="highlighter-rouge">options</code> in every step.</p>

<pre><code>class Create &lt; Trailblazer::Operation
  step     Model( Song, :new )
  step     :assign_current_user!
  # ..
  def assign_current_user!(options)
    options["model"].created_by = options["current_user"]
  end
end
</code></pre>

<p>They are also readable in the result.</p>

<pre><code>result["current_user"] #=&gt; #&lt;User name="Ema"&gt;
result["model"]        #=&gt; #&lt;Song id=nil, title=nil, created_by=#&lt;User name="Ema"&gt;&gt;
</code></pre>

<p>Keep in mind that there is <strong>no global state</strong> in Trailblazer, anything you need in the operation has to be injected via the second <code class="highlighter-rouge">call</code> argument. This also applies to tests.</p>

<h2 id="flow-control" data-magellan-target="flow-control">Flow Control</h2>

<p>The operation’s sole purpose is to define the pipe with its steps that are executed when the operation <a href="api.html#invocation">is run</a>. While traversing the pipe, each step orchestrates all necessary stakeholders like policies, contracts, models and callbacks.</p>

<p>The flow of an operation is defined by a two-tracked pipeline.</p>

<section>
  <div class="row">
    <div class="column medium-4">
      <img src="../../../images/diagrams/overview-flow-animated.gif">
    </div>

    <div class="column medium-8">
      <pre><code>class Song::Create &lt; Trailblazer::Operation
  step    Model( Song, :new )
  step    :assign_current_user!
  step    Contract::Build( constant: MyContract )
  step    Contract::Validate()
  failure :log_error!
  step    Contract::Persist()

  def log_error!(options)
    # ..
  end

  def assign_current_user!(options)
    options["model"].created_by =
      options["current_user"]
  end
end
</code></pre>

    </div>
  </div>

</section>

<p>Per default, the right track will be run from top to bottom. If an error occurs, it will deviate to the left track and continue executing error handler steps on this track.</p>

<p>The flow pipetree is a mix of the <a href="http://dry-rb.org/gems/dry-monads/"><code class="highlighter-rouge">Either</code> monad</a> and <a href="http://fsharpforfunandprofit.com/rop/">“Railway-oriented programming”</a>, but not entirely the same.</p>

<p>The following high-level API is available.</p>

<ul>
  <li>
<code class="highlighter-rouge">step</code> adds a step to the right track. If its return value is <code class="highlighter-rouge">falsey</code>, the pipe deviates to the left track. Can be called with macros, which will run their own insertion logic.</li>
  <li>
<code class="highlighter-rouge">success</code> always add step to the right. The return value is ignored.</li>
  <li>
<code class="highlighter-rouge">failure</code> always add step to the left for error handling. The return value is ignored.</li>
</ul>

<h3 id="flow-control-outcome">Flow Control: Outcome</h3>

<p>If the operation ends on the right track, the <a href="api.html#result-object">result object</a> will return true on <code class="highlighter-rouge">success?</code>.</p>

<div class="highlighter-rouge">
<pre class="highlight"><code>result = Song::Create.({ title: "The Feeling Is Alright" }, "current_user": current_user)
result.success? #=&gt; true
</code></pre>
</div>

<p>Otherwise, when the run ends on the left track, <code class="highlighter-rouge">failure?</code> will return true.</p>

<div class="highlighter-rouge">
<pre class="highlight"><code>result = Song::Create.({ })
result.success? #=&gt; false
result.failure? #=&gt; true
</code></pre>
</div>

<p>Incredible, we know.</p>

<h3 id="flow-control-step">Flow Control: Step</h3>

<p>The <code class="highlighter-rouge">step</code> method adds your step to the <strong>right</strong> track. The return value decides about track deviation.</p>

<div class="highlighter-rouge">
<pre class="highlight"><code>class Create &lt; Trailblazer::Operation
  step :model!

  def model!(options, **)
    options["model"] = Song.new # return value evals to true.
  end
end
</code></pre>
</div>

<p>The <strong>return value of <code class="highlighter-rouge">model!</code> is evaluated</strong>.</p>

<p>Since the above example will always return something “truthy”, the pipe will stay on the right track after <code class="highlighter-rouge">model!</code>.</p>

<p>However, if the step returns <code class="highlighter-rouge">falsey</code>, the pipe will change to the left track.</p>

<div class="highlighter-rouge">
<pre class="highlight"><code>class Update &lt; Trailblazer::Operation
  step :model!

  def model!(options, params:, **)
    options["model"] = Song.find_by(params[:id]) # might return false!
  end
end
</code></pre>
</div>

<p>In the above example, it deviates to the left should the respective model <strong>not</strong> be found.</p>

<p>When adding <a href="api.html#step-macros">step macros</a> with <code class="highlighter-rouge">step</code>, the behavior changes a bit. Macros can command <code class="highlighter-rouge">step</code> to internally use other operators to attach their step(s).</p>

<div class="highlighter-rouge">
<pre class="highlight"><code>class Create &lt; Trailblazer::Operation
  step Model( Song, :find_by )
end
</code></pre>
</div>

<p>However, most macro will internally use <code class="highlighter-rouge">step</code>, too. Note that some macros, such as <code class="highlighter-rouge">Contract::Validate</code> might add several steps in a row.</p>

<h3 id="flow-control-success">Flow Control: Success</h3>

<p>If you don’t care about the result, and want to stay on the right track, use <code class="highlighter-rouge">success</code>.</p>

<div class="highlighter-rouge">
<pre class="highlight"><code>class Update &lt; Trailblazer::Operation
  success :model!

  def model!(options, params:, **)
    options["model"] = Song.find_by(params[:id]) # return value ignored!
  end
end
</code></pre>
</div>

<p>Here, if <code class="highlighter-rouge">model!</code> returns <code class="highlighter-rouge">false</code> or <code class="highlighter-rouge">nil</code>, the pipe stays on right track.</p>

<h3 id="flow-control-failure">Flow Control: Failure</h3>

<p>Error handlers on the left track can be added with <code class="highlighter-rouge">failure</code>.</p>

<div class="highlighter-rouge">
<pre class="highlight"><code>class Create &lt; Trailblazer::Operation
  step    :model!
  failure :error!

  # ...

  def error!(options, params:, **)
    options["result.model"] = "Something went wrong with ID #{params[:id]}!"
  end
end
</code></pre>
</div>

<p>Just as in right-tracked steps, you may add failure information to the <a href="api.html#result-object">result object</a> that you want to communicate to the caller.</p>

<div class="highlighter-rouge">
<pre class="highlight"><code>def error!(options, params:, **)
  options["result.model"] = "Something went wrong with ID #{params[:id]}!"
end
</code></pre>
</div>

<p>Note that you can add as many error handlers as you want, at any position in the pipe. They will be executed in that order, just as it works on the right track.</p>

<h3 id="flow-control-fail-fast-option">Flow Control: Fail Fast Option</h3>

<p>If you don’t want left track steps to be executed after a specific step, use the <code class="highlighter-rouge">:fail_fast</code> option.</p>

<pre><code>class Update &lt; Trailblazer::Operation
  step    Model( Song, :find_by )
  failure :abort!,                                fail_fast: true
  step    Contract::Build( constant: MyContract )
  step    Contract::Validate( )
  failure :handle_invalid_contract!  # won't be executed if #abort! is executed.

  def abort!(options, params:, **)
    options["result.model.song"] = "Something went wrong with ID #{params[:id]}!"
  end
  # ..
end
</code></pre>

<p>This will <strong>not</strong> execute any <code class="highlighter-rouge">failure</code> steps after <code class="highlighter-rouge">abort!</code>.</p>

<pre><code>  result = Update.(id: 1)
  result["result.model.song"] #=&gt; "Something went wrong with ID 1!"
</code></pre>

<p>Note that this option in combination with <code class="highlighter-rouge">failure</code> will always fail fast once its reached, regardless of the step’s return value.</p>

<p><code class="highlighter-rouge">:fail_fast</code> also works with <code class="highlighter-rouge">step</code>.</p>

<pre><code>class Update &lt; Trailblazer::Operation
  step :empty_id?,             fail_fast: true
  step Model( Song, :find_by )
  failure :handle_empty_db!   # won't be executed if #empty_id? returns falsey.

  def empty_id?(options, params:, **)
    params[:id] # returns false if :id missing.
  end
end
</code></pre>

<p>Here, if <code class="highlighter-rouge">step</code> returns a falsey value, the rest of the pipe is skipped, returning a failed result. Again, this will <strong>not</strong> execute any <code class="highlighter-rouge">failure</code> steps after <code class="highlighter-rouge">:empty_id?</code>.</p>

<pre><code>  result = Update.({ id: nil })

  result.failure? #=&gt; true
  result["model"] #=&gt; nil
</code></pre>

<!-- ### Flow Control: Pass Fast Option



The `:pass_fast` option also works with `success` and will always skip the remaining pipe returning a successful result, should the `success` step be reached. -->

<h3 id="flow-control-fail-fast">Flow Control: Fail Fast</h3>

<p>Instead of <a href="api.html#flow-control-fail-fast-option">hardcoding the flow behavior</a> you can have a dynamic skipping of left track steps based on some condition. This works with the <code class="highlighter-rouge">fail_fast!</code> method.</p>

<pre><code>class Update &lt; Trailblazer::Operation
  step :filter_params!         # emits fail_fast!
  step Model( Song, :find_by )
  failure :handle_fail!

  def filter_params!(options, params:, **)
    unless params[:id]
      options["result.params"] = "No ID in params!"
      return Railway.fail_fast!
    end
  end

  def handle_fail!(options, **)
    options["my.status"] = "Broken!"
  end
end
</code></pre>

<p>This will <strong>not</strong> execute any steps on either track, but will result in a failed operation.</p>

<pre><code>  result = Update.(id: 1)
  result["result.params"] #=&gt; "No ID in params!"
  result["my.status"]     #=&gt; nil
</code></pre>

<p>Note that you have to <strong>return</strong> <code class="highlighter-rouge">Railway.fail_fast!</code> from the track. You can use this signal from any step, e.g. <code class="highlighter-rouge">step</code> or <code class="highlighter-rouge">failure</code>.</p>

<!-- ### Flow Control: Pass Fast

Sometimes it might be necessary to skip the rest of the pipe and return a successful result. Use `pass_fast!` for this.

<pre><code>class Create &lt; Trailblazer::Operation
  step Model( Song, :new )
  step :empty_model!                           # emits pass_fast!
  step Contract::Build( constant: MyContract )
  # ..

  def empty_model!(options, is_empty:, model:, **)
    return unless is_empty
    model.save
    Railway.pass_fast!
  end
end
</code></pre>


After **returning** the signal from a step, the remaining steps will be skipped.

<pre><code>  result = Create.({}, "is_empty" =&gt; true)
  result["model"] #=&gt; #&lt;Song id=nil, title=nil&gt;
</code></pre>


Note that this works on both right and left track. -->

<h2 id="step-implementation" data-magellan-target="step-implementation">Step Implementation</h2>

<p>A step can be added via <code class="highlighter-rouge">step</code>, <code class="highlighter-rouge">success</code> and <code class="highlighter-rouge">failure</code>. It can be implemented as an instance method.</p>

<div class="highlighter-rouge">
<pre class="highlight"><code>class Create &lt; Trailblazer::Operation
  step :model!

  def model!(options, **)
    options["model"] = Song.new
  end
end
</code></pre>
</div>

<p>Note that you can use modules to share steps across operations.</p>

<h3 id="step-implementation-lambda">Step Implementation: Lambda</h3>

<p>Or as a proc.</p>

<div class="highlighter-rouge">
<pre class="highlight"><code>class Create &lt; Trailblazer::Operation
  step -&gt;(options, **) { options["model"] = Song.new }
end
</code></pre>
</div>

<h3 id="step-implementation-callable">Step Implementation: Callable</h3>

<p>Or, for more reusability, as a <code class="highlighter-rouge">Callable</code>.</p>

<div class="highlighter-rouge">
<pre class="highlight"><code>class MyModel
  extend Uber::Callable
  def self.call(options, **)
    options["model"] = Song.new
  end
end
</code></pre>
</div>

<p>Simply pass the class (or stateless instance) to the step operator.</p>

<div class="highlighter-rouge">
<pre class="highlight"><code>class Create &lt; Trailblazer::Operation
  step MyModel
end
</code></pre>
</div>

<h2 id="step-arguments" data-magellan-target="step-arguments">Step Arguments</h2>

<p>Each step receives the <a href="api.html#dependencies">context object</a> as a positional argument. All <em>runtime</em> data is also passed as keyword arguments to the step. Whether method, proc or callable object, use the positional options to write, and make use of kw args wherever possible.</p>

<p>For example, you can use kw args with a proc.</p>

<div class="highlighter-rouge">
<pre class="highlight"><code>class Create &lt; Trailblazer::Operation
  step -&gt;(options, params:, current_user:, **) {  }
end
</code></pre>
</div>

<p>Or with an instance method.</p>

<div class="highlighter-rouge">
<pre class="highlight"><code>class Create &lt; Trailblazer::Operation
  step :setup!

  def setup!(options, params:, current_user:, **)
    # ...
  end
end
</code></pre>
</div>

<p>The first <code class="highlighter-rouge">options</code> is the positional argument and ideal to write new data onto the context. This is the <strong>mutable</strong> part which transports mutable state from one step to the next.</p>

<p>After that, only extract the parameters you need (such as <code class="highlighter-rouge">params:</code>). Any unspecified keyword arguments can be ignored using <code class="highlighter-rouge">**</code>.</p>

<div class="callout">
  
<p>Keyword arguments work fine in Ruby 2.1 and &gt;=2.2.3. They are broken in Ruby 2.2.2 and have a to-be-confirmed unexpected behavior in 2.0.</p>


</div>

<h2 id="result-object" data-magellan-target="result-object">Result Object</h2>

<p>Calling an operation returns a <code class="highlighter-rouge">Result</code> object. Sometimes we also called it a <em>context object</em> as it’s available throughout the call. It is passed from step to step, and the steps can read and write to it.</p>

<p>Consider the following operation.</p>

<pre><code>class Song::Create &lt; Trailblazer::Operation
  step     :model!
  step     :assign!
  step     :validate!

  def model!(options, current_user:, **)
    options["model"] = Song.new
    options["model"].created_by = current_user
  end

  def assign!(*, params:, model:, **)
    model.title= params[:title]
  end

  def validate!(options, model:, **)
    options["result.validate"] = ( model.created_by &amp;&amp; model.title )
  end
end
</code></pre>

<p>All three steps add data to the <code class="highlighter-rouge">options</code> object. That data can be used in the following steps.</p>

<pre><code>def validate!(options, model:, **)
  options["result.validate"] = ( model.created_by &amp;&amp; model.title )
end
</code></pre>

<p>It is a convention to use a <code class="highlighter-rouge">"namespaced.key"</code> on the result object. This will help you structure and manage the data. It’s clever to namespace your data with something like <code class="highlighter-rouge">my.</code>.</p>

<div class="callout">
  In future versions of Trailblazer, the <em>Hash Explore API™</em> will allow to search for fragments or namespace paths on the result object. That's why it's a good idea to follow our namespacing convention.
</div>

<p>Some steps, such as <a href="contract.html"><code class="highlighter-rouge">Contract</code></a> or <a href="policy.html"><code class="highlighter-rouge">Policy</code></a> will add nested result objects under their own keys, like <code class="highlighter-rouge">["result.policy"]</code>. It’s a convention to add binary <code class="highlighter-rouge">Result</code> objects to the “global” result under the <code class="highlighter-rouge">["result.XXX"]</code> key.</p>

<h3 id="result-api">Result: API</h3>

<p>After running the operation, the result object can be used for reading state.</p>

<pre><code>result = Song::Create.({ title: "Roxanne" }, "current_user" =&gt; current_user)

result["model"] #=&gt; #&lt;Song title="Roxanne", "created_by"=&lt;User ...&gt;
result["result.validate"] #=&gt; true
</code></pre>

<p>You can ask about the outcome of the operation via <code class="highlighter-rouge">success?</code> and <code class="highlighter-rouge">failure?</code>.</p>

<pre><code>result.success? #=&gt; true
result.failure? #=&gt; falsee
</code></pre>

<p>Please note that the result object is also used to transport externally <a href="api.html#dependencies">injected dependencies and class dependencies.</a>.</p>

<pre><code>result["current_user"] #=&gt; &lt;User ...&gt;
</code></pre>

<p>Use <code class="highlighter-rouge">Result#inspect</code> to test a number of dependencies.</p>

<pre><code>result.inspect("current_user", "model") #=&gt; "&lt;Result:true [#&lt;User email=\"nick@tra... "
</code></pre>

<h3 id="result-interpretation">Result: Interpretation</h3>

<p>The result object represents the interface between the operation’s inner happenings and the outer world, or, in other words, between implementation and user.</p>

<p>It’s up to you how you interpret all this available data. The binary state will help you, but arbitrary state can be transported. For a generic handling in HTTP context (Rails controllers or Rack routes), see <a href="endpoint.html">→ <code class="highlighter-rouge">Endpoint</code></a>.</p>

<h2 id="dependencies" data-magellan-target="dependencies">Dependencies</h2>

<p>In an operation, there is only one way to manage dependencies and state: the <code class="highlighter-rouge">options</code> object (sometimes also called <em>skills</em> hash or context object) is what gives access to class, runtime and injected runtime data.</p>

<p>State can be added on the class layer.</p>

<pre><code>class Song::Create &lt; Trailblazer::Operation
  self["my.model.class"] = Song

  # ...
end
</code></pre>

<p>Unsurprisingly, this is also readable on the class layer.</p>

<pre><code>Song::Create["my.model.class"] #=&gt; Song
</code></pre>

<p>This mechanism is used by all DSL methods such as <code class="highlighter-rouge">contract</code> and by almost all step macros (e.g. <code class="highlighter-rouge">Contract::Build</code>) to save and access class-wide data.</p>

<p>Class data is also readable at runtime in steps.</p>

<pre><code>class Song::Create &lt; Trailblazer::Operation
  self["my.model.class"] = Song

  step :model!

  def model!(options, **)
    options["my.model"] =           # setting runtime data.
      options["my.model.class"].new # reading class data at runtime.
  end
end
</code></pre>

<p>In steps, you can set runtime data (e.g. <code class="highlighter-rouge">my.model</code>).</p>

<p>After running the operation, this <code class="highlighter-rouge">options</code> object turns into the <a href="api.html#result-object">result object</a>.</p>

<pre><code>result = Song::Create.({})

result["my.model.class"] #=&gt; Song
result["my.model"] #=&gt; #&lt;Song title=nil&gt;
</code></pre>

<h2 id="dependency-injection" data-magellan-target="dependency-injection">Dependency Injection</h2>

<p>Both class data as well as runtime data <a href="api.html#dependencies">described above</a> can be overridden using dependency injection.</p>

<pre><code>result = Song::Create.({}, "my.model.class" =&gt; Hit)

result["my.model"] #=&gt; #&lt;Hit id=nil&gt;
</code></pre>

<p>Note that injected dependencies need to be in the second argument to <code class="highlighter-rouge">Operation::call</code>.</p>

<div class="callout">
Since all step macros, i.e. <code>Policy::Pundit</code> or <code>Contract::Validate</code> use the same mechanism, you can override hard-coded dependencies such as policies or contracts from the outside at runtime.
</div>

<p>Be careful, though, with DI: It couples your operation to the caller and should be properly unit-tested or further encapsulated in e.g. <a href="endpoint.html"><code class="highlighter-rouge">Endpoint</code></a>.</p>

<h3 id="dependency-injection-autoinject">Dependency Injection: Auto_inject</h3>

<p>The operation supports Dry.RB’s <a href="http://dry-rb.org/gems/dry-auto_inject/">auto_inject</a>.</p>

<div class="highlighter-rouge">
<pre class="highlight"><code># this happens somewhere in your Dry system.
my_container = Dry::Container.new
my_container.register("repository.song", Song::Repository)

require "trailblazer/operation/auto_inject"
AutoInject = Trailblazer::Operation::AutoInject(my_container)

class Song::Create &lt; Trailblazer::Operation
  include AutoInject["repository.song"]

  step :model!

  def model!(options, params:, **)
    options["model"] =
      options["repository.song"].find_or_create( params[:id] )
  end
end
</code></pre>
</div>

<p>Including the <code class="highlighter-rouge">AutoInject</code> module will make sure that the specified dependencies are injected (using <a href="api.html#dependency-injection">dependency injection</a>) into the <a href="api.html#dependencies">operation’s context</a> at instantiation time.</p>

<h2 id="inheritance" data-magellan-target="inheritance">Inheritance</h2>

<p>To share code and pipe, use class inheritance.</p>

<div class="callout">
  
<p>Try to avoid inheritance and use <a href="api.html#nested">composition</a> instead.</p>

</div>

<p>You can inherit from any kind of operation.</p>

<pre><code>class New &lt; Trailblazer::Operation
  step Model( Song, :new )
  step Contract::Build( constant: MyContract )
end
</code></pre>

<p>In this example, the <code class="highlighter-rouge">New</code> class will have a pipe as follows.</p>

<pre><code> 0 =======================&gt;&gt;operation.new
 1 ==========================&amp;model.build
 2 =======================&gt;contract.build
</code></pre>

<p>In addition to Ruby’s normal class inheritance semantics, the operation will also copy the pipe. You may then add further steps to the subclass.</p>

<pre><code>class Create &lt; New
  step Contract::Validate()
  step Contract::Persist()
end
</code></pre>

<p>This results in the following pipe.</p>

<pre><code> 0 =======================&gt;&gt;operation.new
 1 ==========================&amp;model.build
 2 =======================&gt;contract.build
 3 ==============&amp;contract.default.params
 4 ============&amp;contract.default.validate
 5 =========================&amp;persist.save
</code></pre>

<p>Inheritance is great to eliminate redundancy. Pipes and step code can easily be shared amongst groups of operations.</p>

<p>Be weary, though, that you are tightly coupling flow and implementation to each other. Once again, try to use Trailblazer’s <a href="api.html#nested">compositional</a> semantics over inheritance.</p>

<h3 id="inheritance-override">Inheritance: Override</h3>

<p>When using inheritance, use <code class="highlighter-rouge">:override</code> to replace existing steps in  subclasses.</p>

<p>Consider the following base operation.</p>

<pre><code>module MyApp::Operation
  class New &lt; Trailblazer::Operation
    extend Contract::DSL

    contract do
      property :title
    end

    step Model( nil, :new )
    step Contract::Build()
  end
end
</code></pre>

<p>Subclasses can now override predefined steps.</p>

<pre><code>class Song::New &lt; MyApp::Operation::New
  step Model( Song, :new ), override: true
end
</code></pre>

<p>The pipe flow will remain the same.</p>

<pre><code>Song::New["pipetree"].inspect(style: :row)
 0 =======================&gt;&gt;operation.new
 1 ==========================&amp;model.build
 2 =======================&gt;contract.build
</code></pre>

<p>Refrain from using the <code class="highlighter-rouge">:override</code> option if you want to add steps.</p>

<h2 id="options" data-magellan-target="options">Options</h2>

<p>When adding steps using <code class="highlighter-rouge">step</code>, <code class="highlighter-rouge">failure</code> and <code class="highlighter-rouge">success</code>, you may name steps explicitly or specify the position.</p>

<h3 id="options-name">Options: Name</h3>

<section class=" ">
  <div class="row">
    <div class="column medium-6 ">
        <p>A step macro will name itself.</p>

<pre><code>class New &lt; Trailblazer::Operation
  step Model( Song, :new )
end
</code></pre>


      </div>
    <div class="column medium-6 ">
        <p>You can find out the name by inspecting the pipe.</p>

<pre><code> 0 =======================&gt;&gt;operation.new
 1 ==========================&amp;model.build
</code></pre>


      </div>
</div></section>

<p>For every kind of step, whether it’s a macro or a custom step, use <code class="highlighter-rouge">:name</code> to specify a name.</p>

<pre><code>class New &lt; Trailblazer::Operation
  step Model( Song, :new ), name: "build.song.model"
  step :validate_params!,   name: "my.params.validate"
  # ..
end
</code></pre>

<p>When inspecting the pipe, you will see your names.</p>

<pre><code> 0 =======================&gt;&gt;operation.new
 1 =====================&amp;build.song.model
 2 ===================&amp;my.params.validate
</code></pre>

<p>Assign manual names to steps when using macros multiple times, or when planning to alter the pipe in subclasses.</p>

<h3 id="options-position">Options: Position</h3>

<p>Whenever inserting a step, you may provide the position in the pipe using <code class="highlighter-rouge">:before</code> or <code class="highlighter-rouge">:after</code>.</p>

<pre><code>class New &lt; Trailblazer::Operation
  step Model( Song, :new )
  step :validate_params!,   before: "model.build"
  # ..
end
</code></pre>

<p>This will insert the custom step before the model builder.</p>

<pre><code> 0 =======================&gt;&gt;operation.new
 1 =====================&amp;validate_params!
 2 ==========================&amp;model.build
</code></pre>

<div class="callout">
  
<p>Naturally, <code>:after</code> will insert the step after an existing one.</p>

</div>

<h3 id="options-inheritance">Options: Inheritance</h3>

<p>The position options are extremely helpful with inheritance.</p>

<pre><code>class Create &lt; New
  step :policy!, after: "operation.new"
end
</code></pre>

<p>It allows inserting new steps without repeating the existing pipe.</p>

<pre><code> 0 =======================&gt;&gt;operation.new
 1 ==============================&amp;policy!
 2 =====================&amp;validate_params!
 3 ==========================&amp;model.build
</code></pre>

<h3 id="options-replace">Options: Replace</h3>

<p>Replace existing (or inherited) steps using <code class="highlighter-rouge">:replace</code>.</p>

<pre><code>class Update &lt; New
  step Model(Song, :find_by), replace: "model.build"
end
</code></pre>

<p>The existing step will be discarded with the newly provided one.</p>

<pre><code> 0 =======================&gt;&gt;operation.new
 2 ==========================&amp;model.build
</code></pre>

<h3 id="options-delete">Options: Delete</h3>

<h2 id="step-macros" data-magellan-target="step-macros">Step Macros</h2>

<p>Trailblazer provides predefined steps to for all kinds of business logic.</p>

<!-- * [Builder](#builder) allows writing and using polymorphic factories to create different operations based on different input. -->
<ul>
  <li>
<a href="contract.html">Contract</a> implements contracts, validation and persisting verified data using the model layer.</li>
  <li>
<a href="api.html#nested"><code class="highlighter-rouge">Nested</code></a>, <a href="api.html#wrap"><code class="highlighter-rouge">Wrap</code></a> and <a href="api.html#rescue"><code class="highlighter-rouge">Rescue</code></a> are step containers that help with transactional features for a group of steps per operation.</li>
  <li>All <a href="policy.html"><code class="highlighter-rouge">Policy</code>-related</a> macros help with authentication and making sure users only execute what they’re supposed to.</li>
  <li>The <a href="api.html#model"><code class="highlighter-rouge">Model</code></a> macro can create and find models based on input.</li>
</ul>

<h2 id="macro-api" data-magellan-target="macro-api">Macro API</h2>

<p>Implementing your own macros helps to create reusable code.</p>

<p>It’s advised to put macro code into namespaces to not pollute the global namespace.</p>

<pre><code>module Macro
  def self.MyPolicy(allowed_role: "admin")
    step = -&gt;(input, options) { options["current_user"].type == allowed_role }

    [ step, name: "my_policy.#{allowed_role}" ] # :before, :replace, etc. work, too.
  end
end
</code></pre>

<p>The macro itself is a function. Per convention, the name is capitalized. You can specify any set of arguments (e.g. using kw args), and it returns a 2-element array with the actual step to be inserted into the pipe and default options.</p>

<p>Note that in the macro, the code design is up to you. You can delegate to other functions, objects, etc.</p>

<p>The macro step receives <code class="highlighter-rouge">(input, options)</code> where <code class="highlighter-rouge">input</code> is usually the operation instance and <code class="highlighter-rouge">options</code> is the context object passed from step to step. It’s your macro’s job to read and write to <code class="highlighter-rouge">options</code>. It is not advisable to interact with the operation instance.</p>

<p>Operations can then use your macro the way you’ve done it with our Trailblazer macros.</p>

<pre><code>class Create &lt; Trailblazer::Operation
  step Macro::MyPolicy( allowed_role: "manager" )
  # ..
end
</code></pre>

<p>When looking at the operation’s pipe, you can see how, in our example, the default options provide a convenient step name.</p>

<pre><code>  puts Create["pipetree"].inspect(style: :rows) #=&gt;
   0 ========================&gt;operation.new
   1 ====================&gt;my_policy.manager
</code></pre>

<p>It is not advised to test macros in isolation. Note that it <em>is</em> possible by simply calling your macro in a test case. However, macros should be tested via an operation unit test to make sure the wiring is correct.</p>

<div class="callout">
  
<p>In future versions (TRB 2.0.2+) we will have public APIs for creating nested pipes, providing temporary arguments to steps and allowing injectable options.</p>

</div>

<h2 id="model" data-magellan-target="model">Model</h2>

<p>An operation can automatically find or create a model for you depending on the input, with the <code class="highlighter-rouge">Model</code> macro.</p>

<pre><code>class Create &lt; Trailblazer::Operation
  step Model( Song, :new )
  # ..
end
</code></pre>

<p>After this step, there is a fresh model instance under <code class="highlighter-rouge">options["model"]</code> that can be used in all following steps.</p>

<pre><code>result = Create.({})
result["model"] #=&gt; #&lt;struct Song id=nil, title=nil&gt;
</code></pre>

<p>Internally, <code class="highlighter-rouge">Model</code> macro will simply invoke <code class="highlighter-rouge">Song.new</code> to populate <code class="highlighter-rouge">"model"</code>.</p>

<h3 id="model-findby">Model: Find_by</h3>

<p>You can also find models using <code class="highlighter-rouge">:find_by</code>. This is helpful for <code class="highlighter-rouge">Update</code> or <code class="highlighter-rouge">Delete</code> operations.</p>

<pre><code>class Update &lt; Trailblazer::Operation
  step Model( Song, :find_by )
  # ..
end
</code></pre>

<p>The <code class="highlighter-rouge">Model</code> macro will invoke the following code for you.</p>

<div class="highlighter-rouge">
<pre class="highlight"><code>options["model"] = Song.find_by( params[:id] )
</code></pre>
</div>

<p>This will assign <code class="highlighter-rouge">["model"]</code> for you by invoking <code class="highlighter-rouge">find_by</code>.</p>

<pre><code>result = Update.({ id: 1 })
result["model"] #=&gt; #&lt;struct Song id=1, title="Roxanne"&gt;
</code></pre>

<p>If <code class="highlighter-rouge">Song.find_by</code> returns <code class="highlighter-rouge">nil</code>, this will deviate to the left track, skipping the rest of the operation.</p>

<pre><code>result = Update.({})
result["model"] #=&gt; nil
result.success? #=&gt; false
</code></pre>

<p>Note that you may also use <code class="highlighter-rouge">:find</code>. This is not recommended, though, since it raises an exception, which is not the preferred way of flow control in Trailblazer.</p>

<h3 id="model-arbitrary-finder">Model: Arbitrary Finder</h3>

<p>It’s possible to specify any finder method, which is helpful with ROMs such as Sequel.</p>

<pre><code>class Show &lt; Trailblazer::Operation
  step Model( Song, :[] )
  # ..
end
</code></pre>

<p>The provided method will be invoked and Trailblazer passes it the <code class="highlighter-rouge">params[:id]</code> value.</p>

<div class="language-ruby highlighter-rouge">
<pre class="highlight"><code><span class="no">Song</span><span class="p">[</span> <span class="n">params</span><span class="p">[</span><span class="ss">:id</span><span class="p">]</span> <span class="p">]</span>
</code></pre>
</div>

<p>Given your database gem provides that finder, it will result in a successful query.</p>

<pre><code>result = Show.({ id: 1 })
result["model"] #=&gt; #&lt;struct Song id=1, title="Roxanne"&gt;
</code></pre>

<h2 id="nested" data-magellan-target="nested">Nested</h2>

<p>It is possible to nest operations, as in running an operation in another. This is the common practice for “presenting” operations and “altering” operations, such as <code class="highlighter-rouge">Edit</code> and <code class="highlighter-rouge">Update</code>.</p>

<pre><code>class Edit &lt; Trailblazer::Operation
  extend Contract::DSL

  contract do
    property :title
  end

  step Model( Song, :find )
  step Contract::Build()
end
</code></pre>

<p>Note how <code class="highlighter-rouge">Edit</code> only defines the model builder (via <code class="highlighter-rouge">:find</code>) and builds the contract.</p>

<p>Running <code class="highlighter-rouge">Edit</code> will allow you to grab the model and contract, for presentation and rendering the form.</p>

<pre><code>result = Edit.(id: 1)

result["model"]            #=&gt; #&lt;Song id=1, title=\"Bristol\"&gt;
result["contract.default"] #=&gt; #&lt;Reform::Form ..&gt;
</code></pre>

<p>This operation could now be leveraged in <code class="highlighter-rouge">Update</code>.</p>

<pre><code>class Update &lt; Trailblazer::Operation
  step Nested( Edit )
  step Contract::Validate()
  step Contract::Persist( method: :sync )
end
</code></pre>

<p>The <code class="highlighter-rouge">Nested</code> macro helps you invoking an operation at any point in the pipe.</p>

<h3 id="nested-data">Nested: Data</h3>

<p>The nested operation (<code class="highlighter-rouge">Edit</code>) will, per default, only receive runtime data from the composing operation (<code class="highlighter-rouge">Update</code>). Mutable data is not available to protect the nested operation from unsolicited input.</p>

<p>After running the nested <code class="highlighter-rouge">Edit</code> operation its runtime data (e.g. <code class="highlighter-rouge">"model"</code>) is available in the <code class="highlighter-rouge">Update</code> operation.</p>

<pre><code>result = Update.(id: 1, title: "Call It A Night")

result["model"]            #=&gt; #&lt;Song id=1 , title=\"Call It A Night\"&gt;
result["contract.default"] #=&gt; #&lt;Reform::Form ..&gt;
</code></pre>

<p>Should the nested operation fail, for instance because its model couldn’t be found, then the outer pipe will also jump to the left track.</p>

<h3 id="nested-callable">Nested: Callable</h3>

<p>If you need to pick the nested operation dynamically at runtime, use a callable object instead.</p>

<pre><code>class Delete &lt; Trailblazer::Operation
  step Nested( MyBuilder )
  # ..
end
</code></pre>

<p>The object’s <code class="highlighter-rouge">call</code> method has the exact same interface as any other step.</p>

<pre><code>class MyBuilder
  extend Uber::Callable

  def self.call(options, current_user:nil, **)
    current_user.admin? ? Create::Admin : Create::NeedsModeration
  end
end
</code></pre>

<p>Note that <code class="highlighter-rouge">Nested</code> also works with <code class="highlighter-rouge">:instance_method</code> and lambdas.</p>

<pre><code>class Update &lt; Trailblazer::Operation
  step Nested( :build! )

  def build!(options, current_user:nil, **)
    current_user.admin? ? Create::Admin : Create::NeedsModeration
  end
end
</code></pre>

<h3 id="nested-input">Nested: Input</h3>

<p>Per default, only the runtime data will be passed into the nested operation. You can use <code class="highlighter-rouge">:input</code> to change the data getting passed on.</p>

<p>The following operation multiplies two factors.</p>

<pre><code>class Multiplier &lt; Trailblazer::Operation
  step -&gt;(options, x:, y:, **) { options["product"] = x*y }
end
</code></pre>

<p>It is <code class="highlighter-rouge">Nested</code> in another operation.</p>

<pre><code>class MultiplyByPi &lt; Trailblazer::Operation
  step -&gt;(options) { options["pi_constant"] = 3.14159 }
  step Nested( Multiplier, input: -&gt;(options, mutable_data:, runtime_data:, **) do
    { "y" =&gt; mutable_data["pi_constant"],
      "x" =&gt; runtime_data["x"] }
  end )
end
</code></pre>

<p>The examplary composing operation uses both runtime and mutable data. Its invocation could look as follows.</p>

<pre><code>result = MultiplyByPi.({}, "x" =&gt; 9)
result["product"] #=&gt; [28.27431]
</code></pre>

<p>The <code class="highlighter-rouge">:input</code> option for <code class="highlighter-rouge">Nested</code> allows to specify what options will go into the nested operation. It passes <code class="highlighter-rouge">mutable_data</code> and <code class="highlighter-rouge">runtime_data</code> to the option for your convenience.</p>

<p>While the runtime data normally gets passed on to nested operations automatically, mutual data won’t. <code class="highlighter-rouge">:input</code> has to compile all data being passed on to the nested operation and return that hash.</p>

<p>Use a <code class="highlighter-rouge">Callable</code> to share mapping code.</p>

<pre><code>class MyInput
  extend Uber::Callable

  def self.call(options, mutable_data:, runtime_data:, **)
    {
      "y" =&gt; mutable_data["pi_constant"],
      "x" =&gt; runtime_data["x"]
    }
  end
end
</code></pre>

<p>It will improve readability.</p>

<pre><code>class MultiplyByPi &lt; Trailblazer::Operation
  step -&gt;(options) { options["pi_constant"] = 3.14159 }
  step Nested( Multiplier, input: MyInput )
end
</code></pre>

<h3 id="nested-output">Nested: Output</h3>

<p>After running a nested operation, its mutable data gets copied into the <code class="highlighter-rouge">options</code> of the composing operation.</p>

<p>Use <code class="highlighter-rouge">:output</code> to change that, should you need only specific values.</p>

<pre><code>class Update &lt; Trailblazer::Operation
  step Nested( Edit, output: -&gt;(options, mutable_data:, **) do
    {
      "contract.my" =&gt; mutable_data["contract.default"],
      "model"       =&gt; mutable_data["model"]
    }
  end )
  step Contract::Validate( name: "my" )
  step Contract::Persist( method: :sync, name: "my" )
end
</code></pre>

<p>This works with lambdas, <code class="highlighter-rouge">:method</code> and <code class="highlighter-rouge">Callable</code>.</p>

<h2 id="wrap" data-magellan-target="wrap">Wrap</h2>

<p>Steps can be wrapped by an embracing step. This is necessary when defining a set of steps to be contained in a database transaction or a database lock.</p>

<pre><code>class Create &lt; Trailblazer::Operation
  class MyContract &lt; Reform::Form
    property :title
  end

  step Wrap -&gt;(*, &amp;block) { Sequel.transaction do block.call end } {
    step Model( Song, :new )
    step Contract::Build( constant: MyContract )
    step Contract::Validate( )
    step Contract::Persist( method: :sync )
  }
  failure :error! # handle all kinds of errors.
  step :notify!

  def error!(options)
    # handle errors after the wrap
  end

  def notify!(options)
    MyNotifier.mail
  end
end
</code></pre>

<p>The <code class="highlighter-rouge">Wrap</code> macro helps you to define the wrapping code (such as a <code class="highlighter-rouge">Sequel.transaction</code> call) and allows you to define the wrapped steps. (Because of the precedence works in Ruby, you need to use <code class="highlighter-rouge"><span class="p">{</span><span class="err">...</span><span class="p">}</span></code> instead of <code class="highlighter-rouge">do...end</code>.)</p>

<pre><code>class Create &lt; Trailblazer::Operation
  # ...
  step Wrap -&gt;(*, &amp;block) { Sequel.transaction do block.call end } {
    step Model( Song, :new )
    # ...
  }
  failure :error! # handle all kinds of errors.
  # ...
end
</code></pre>

<p>As always, you can have steps before and after <code class="highlighter-rouge">Wrap</code> in the pipe.</p>

<p>The proc passed to <code class="highlighter-rouge">Wrap</code> will be called when the pipe is executed, and receives <code class="highlighter-rouge">block</code>. <code class="highlighter-rouge">block.call</code> will execute the nested pipe.</p>

<p>You may have any amount of <code class="highlighter-rouge">Wrap</code> nesting.</p>

<h3 id="wrap-return-value">Wrap: Return Value</h3>

<p>All nested steps will simply be executed as if they were on the “top-level” pipe, but within the wrapper code. Steps may deviate to the left track, and so on.</p>

<p>However, the last signal of the wrapped pipe is not simply passed on to the “outer” pipe. The return value of the actual <code class="highlighter-rouge">Wrap</code> block is crucial: If it returns falsey, the pipe will deviate to left after <code class="highlighter-rouge">Wrap</code>.</p>

<div class="highlighter-rouge">
<pre class="highlight"><code>step Wrap -&gt;(*, &amp;block) { Sequel.transaction do block.call end; false } {
</code></pre>
</div>

<p>In the above example, regardless of <code class="highlighter-rouge">Sequel.transaction</code>’s return value, the outer pipe will deviate to the left track as the <code class="highlighter-rouge">Wrap</code>’s return value is always <code class="highlighter-rouge">false</code>.</p>

<h3 id="wrap-callable">Wrap: Callable</h3>

<p>For reusable wrappers, you can also use a <code class="highlighter-rouge">Callable</code> object.</p>

<pre><code>class MyTransaction
  extend Uber::Callable

  def self.call(options, *)
    Sequel.transaction { yield } # yield runs the nested pipe.
    # return value decides about left or right track!
  end
end
</code></pre>

<p>This can then be passed to <code class="highlighter-rouge">Wrap</code>, making the pipe extremely readable.</p>

<pre><code>class Create &lt; Trailblazer::Operation
  # ...
  step Wrap( MyTransaction ) {
    step Model( Song, :new )
    # ...
  }
  failure :error! # handle all kinds of errors.
  # ...
end
</code></pre>

<h2 id="rescue" data-magellan-target="rescue">Rescue</h2>

<p>While you can write your own <code class="highlighter-rouge">begin/rescue/end</code> mechanics using <a href="api.html#wrap"><code class="highlighter-rouge">Wrap</code></a>, Trailblazer offers you the <code class="highlighter-rouge">Rescue</code> macro to catch and handle exceptions that might occur while running the pipe.</p>

<pre><code>class Create &lt; Trailblazer::Operation
  class MyContract &lt; Reform::Form
    property :title
  end

  step Rescue {
    step Model(Song, :find)
    step Contract::Build( constant: MyContract )
  }
  step Contract::Validate()
  step Contract::Persist( method: :sync )
end
</code></pre>

<p>Any exception raised during a step in the <code class="highlighter-rouge">Rescue</code> block will stop the nested pipe from being executed, and continue after the block on the left track.</p>

<p>You can specify what exceptions to catch and an optional handler that is called when an exception is encountered.</p>

<pre><code>class Create &lt; Trailblazer::Operation
  step Rescue( RecordNotFound, KeyError, handler: :rollback! ) {
    step Model( Song, :find )
    step Contract::Build( constant: MyContract )
  }
  step Contract::Validate()
  step Contract::Persist( method: :sync )

  def rollback!(exception, options)
    options["x"] = exception.class
  end
end
</code></pre>

<p>Alternatively, you can use a  <code class="highlighter-rouge">Callable</code> object for <code class="highlighter-rouge">:handler</code>.</p>

<h2 id="full-example" data-magellan-target="full-example">Full Example</h2>

<p>The  <code class="highlighter-rouge">Nested</code>, <code class="highlighter-rouge">Wrap</code> and <code class="highlighter-rouge">Rescue</code> macros can also be nested, allowing an easily extendable business workflow with error handling along the way.</p>

<pre><code>class Create &lt; Trailblazer::Operation
  class MyContract &lt; Reform::Form
    property :title
  end

  step Rescue( RecordNotFound, handler: :rollback! ) {
    step Wrap -&gt;(*, &amp;block) { Sequel.transaction do block.call end } {
      step Model( Song, :find )
      step -&gt;(options) { options["model"].lock! } # lock the model.
      step Contract::Build( constant: MyContract )
      step Contract::Validate( )
      step Contract::Persist( method: :sync )
    }
  }
  failure :error! # handle all kinds of errors.

  def rollback!(exception, options)
    # ...
  end

  def error!(options)
    # ...
  end
end
</code></pre>


            </div>

            <div class="large-3 columns sticky-container" data-sticky-container>

              
                <nav class="sticky columns docs-toc-wrap sticky is-anchored is-at-top side-nav" data-sticky data-anchor="docs" data-sticky-on="large" data-margin-top="5">
  
        <ul class="vertical menu" data-magellan id="page-toc">
          <li class="page-toc-heading">ON THIS PAGE:</li>
          <li><a href="api.html#invocation">Invocation</a></li>
<li><a href="api.html#flow-control">Flow Control</a></li>
<li><a href="api.html#step-implementation">Step Implementation</a></li>
<li><a href="api.html#step-arguments">Step Arguments</a></li>
<li><a href="api.html#result-object">Result Object</a></li>
<li><a href="api.html#dependencies">Dependencies</a></li>
<li><a href="api.html#dependency-injection">Dependency Injection</a></li>
<li><a href="api.html#inheritance">Inheritance</a></li>
<li><a href="api.html#options">Options</a></li>
<li><a href="api.html#step-macros">Step Macros</a></li>
<li><a href="api.html#macro-api">Macro API</a></li>
<li><a href="api.html#model">Model</a></li>
<li><a href="api.html#nested">Nested</a></li>
<li><a href="api.html#wrap">Wrap</a></li>
<li><a href="api.html#rescue">Rescue</a></li>
<li><a href="api.html#full-example">Full Example</a></li>
        </ul>
      
</nav>

              

            </div>
          </div>
        </article>
      </div>

      <div class="medium-3 large-2 medium-pull-9 large-pull-10 columns">
        <ul id="sidebar" class="side-nav accordion" data-accordion>
  <li class="accordion-item" data-accordion-item>
    <a href="api.html#" class="accordion-title">
      <i class="fa fa-caret-square-o-right" aria-hidden="true"></i>
      <strong>OPERATION</strong>
    </a>
    <div class="accordion-content" data-tab-content>
      <ul class="vertical menu">
        <li><a href="index.html">Overview</a></li>
        <li><a href="api.html" class="active">API</a></li>
        <li><a href="contract.html">Contract</a></li>
        <!--<li><a href="/gems/operation/2.0/representer.html">Representer</a></li>-->
        <li><a href="policy.html">Policy</a></li>
        <li><a href="representer.html">Representer</a></li>
        <!--<li><a href="/gems/operation/2.0/pipetree.html">Pipetree</a></li>-->
        <li><a href="endpoint.html">Endpoint</a></li>
        <li>
<a href="../1.1/index.html">
            <span class="sidebar-info">→ v1.1</span>
          </a>
        </li>
      </ul>
    </div>
  </li>

  <li class="accordion-item" data-accordion-item>
    <a href="api.html#" class="accordion-title">
      <i class="fa fa-caret-square-o-right" aria-hidden="true"></i>
      <strong>TRAILBLAZER</strong>
    </a>
    <div class="accordion-content" data-tab-content>
      <ul class="vertical menu">
        <li><a href="../../trailblazer/index.html">Overview</a></li>
        <li><a href="../../trailblazer/2.0/rails.html">Rails</a></li>
        <li><a href="../../trailblazer/2.0/test.html">Test</a></li>
        <li><a href="../../trailblazer/loader.html">Loader</a></li>
        <li><a href="../../trailblazer/upgrading-1-to-2.html">Upgrading</a></li>
      </ul>
    </div>
  </li>

  <li class="accordion-item" data-accordion-item>
    <a href="api.html#" class="accordion-title">
      <i class="fa fa-caret-square-o-right" aria-hidden="true"></i>
      <strong>CELLS</strong>
    </a>
    <div class="accordion-content" data-tab-content>
      <ul class="vertical menu">
        <li><a href="../../cells.html">Overview</a></li>
        <li><a href="../../cells/getting-started.html">Getting Started<span class="sidebar-info">NEW</span></a></li>
        <li><a href="../../cells/api.html">API</a></li>
        <li><a href="../../cells/trailblazer.html">Trailblazer::Cell</a></li>
        <li><a href="../../cells/testing.html">Testing</a></li>
        <li><a href="../../cells/render.html">Rendering</a></li>
        <li><a href="../../cells/rails.html">Rails</a></li>
        <li><a href="../../cells/templates.html">Templates</a></li>
        <li><a href="../../cells/troubleshooting.html">Troubleshooting</a></li>
      </ul>
    </div>
  </li>

  <li class="accordion-item" data-accordion-item>
    <a href="api.html#" class="accordion-title">
      <i class="fa fa-caret-square-o-right" aria-hidden="true"></i>
      <strong>REFORM</strong>
    </a>
    <div class="accordion-content" data-tab-content>
      <ul class="vertical menu">
        <li><a href="../../reform/index.html">Overview</a></li>
        <li><a href="../../reform/api.html">API</a></li>
        <li><a href="../../reform/options.html">Options</a></li>
        <li><a href="../../reform/data-types.html">Data Types</a></li>
        <li><a href="../../reform/populator.html">Populator</a></li>
        <li><a href="../../reform/prepopulator.html">Prepopulator</a></li>
        <li><a href="../../reform/validation.html">Validation</a></li>
        <li><a href="../../reform/rails.html">Rails</a></li>
        <li><a href="../../reform/debugging.html">Debugging</a></li>
        <li><a href="../../reform/upgrading-guide.html">Upgrading Guide</a></li>
      </ul>
    </div>
  </li>

  <li class="accordion-item" data-accordion-item>
    <a href="api.html#" class="accordion-title">
      <i class="fa fa-caret-square-o-right" aria-hidden="true"></i>
      <strong>REPRESENTABLE</strong>
    </a>
    <div class="accordion-content" data-tab-content>
      <ul class="vertical menu">
        <li><a href="../../representable.html">Overview</a></li>
        <li><a href="../../representable/getting-started.html">Getting Started</a></li>
        <li><a href="../../representable/3.0/api.html">API</a></li>
        <li><a href="../../representable/3.0/function-api.html">Function API</a></li>
        <li><a href="../../representable/3.0/populator.html">Populator</a></li>
        <!--<li><a href="/gems/representable/architecture.html">Architecture</a></li>-->
        <li><a href="../../representable/3.0/xml.html">XML</a></li>
        <li><a href="../../representable/3.0/yaml.html">YAML</a></li>
        <li><a href="../../representable/upgrading-guide.html">Upgrading Guide</a></li>
      </ul>
    </div>
  </li>

  <li class="accordion-item" data-accordion-item>
    <a href="api.html#" class="accordion-title">
      <i class="fa fa-caret-square-o-right" aria-hidden="true"></i>
      <strong>ROAR</strong>
    </a>
    <div class="accordion-content" data-tab-content>
      <ul class="vertical menu">
        <li><a href="../../roar/index.html">Overview</a></li>
        <li><a href="../../roar/jsonapi.html">JSON API</a></li>
      </ul>
    </div>
  </li>

  <li class="accordion-item" data-accordion-item>
    <a href="api.html#" class="accordion-title">
      <i class="fa fa-caret-square-o-right" aria-hidden="true"></i>
      <strong>FORMULAR</strong>
    </a>
    <div class="accordion-content" data-tab-content>
      <ul class="vertical menu">
        <!-- <li><a href="/gems/formular/index.html">Overview</a></li> -->
        <li><a href="../../formular/bootstrap.html">Bootstrap</a></li>
      </ul>
    </div>
  </li>

  <li class="accordion-item" data-accordion-item>
    <a href="api.html#" class="accordion-title">
      <i class="fa fa-caret-square-o-right" aria-hidden="true"></i>
      <strong>DISPOSABLE</strong>
    </a>
    <div class="accordion-content" data-tab-content>
      <ul class="vertical menu">
        <li><a href="../../disposable/index.html">Overview</a></li>
        <li><a href="../../disposable/api.html">API</a></li>
        <li><a href="../../disposable/default.html">Default</a></li>
        <li><a href="../../disposable/callback.html">Callback</a></li>
      </ul>
    </div>
  </li>

  <li class="accordion-item" data-accordion-item>
    <a href="api.html#" class="accordion-title">
      <i class="fa fa-caret-square-o-right" aria-hidden="true"></i>
      <strong>GUIDES</strong>
    </a>
    <div class="accordion-content" data-tab-content>
      <ul class="vertical menu">
        <li><a href="../../../guides/index.html">Overview</a></li>
        <li><a href="http://trailblazer.to/guides/trailblazer/2.0/01-operation-basics.html">01 - Operation Basics</a></li>
        <li><a href="http://trailblazer.to/guides/trailblazer/2.0/02-trailblazer-basics.html">02 - Trailblazer Basics</a></li>
        <li><a href="../../../guides/trailblazer/2.0/03-rails-basics.html">03 - Rails Basics</a></li>
      </ul>
    </div>
  </li>

  <!--
  <li class="accordion-item" data-accordion-item>
    <a href="#" class="accordion-title">
      <i class="fa fa-caret-square-o-right" aria-hidden="true"></i>
      <strong></strong>
    </a>
    <div class="accordion-content" data-tab-content>
      <ul class="vertical menu">
        <li><a href="">Overview</a></li>
        
      </ul>
    </div>
  </li>

  -->
</ul>

<script>
  (function (document, window) {
    var $sidebar = $('#sidebar');
    var $items = $sidebar.find('.accordion-item')
    var currentPath = window.location.pathname;

    $items.each(function (i, elem) {
      var $elem = $(elem);
      var linkHref = $elem
        .find('.accordion-content li:first-child a')
        .attr('href')
        .replace('index.html', '');

      if (currentPath.indexOf(linkHref) !== -1) {
        $elem.addClass('is-active')
      }
    })
  })(document, window);
</script>

      </div>
    </div>


    <section class="top-footer">
  <div class="row">
    <div class="columns medium-6">
      <h3>Newsletter</h3>
      <p>
        Stay on top of what’s happening in Trailblazer.
      </p>
        <div class="row">
          <div id="mc_embed_signup">
            <form action="http://trailblazerb.us8.list-manage.com/subscribe/post?u=bbe5021ab6fbdc94a16f0d036&amp;id=a69f6e4652" method="post" id="mc-embedded-subscribe-form" name="mc-embedded-subscribe-form" class="validate" target="_blank" novalidate>

              <div class="columns large-9 medium-12 ">
                <div class="row collapse prefix-radius">
                  <div class="small-8 medium-7 large-8 columns">
                    <div id="mc_embed_signup_scroll">
                      <div class="mc-field-group">
                        <input type="email" value="" name="EMAIL" class="required email" id="mce-EMAIL" placeholder="youremail@trailblazer.to">
                      </div>
                      <div id="mce-responses" class="clear">
                        <div class="response" id="mce-error-response" style="display:none"></div>
                        <div class="response" id="mce-success-response" style="display:none"></div>
                      </div>    <!-- real people should not fill this in and expect good things - do not remove this or risk form bot signups-->
                      <div style="position: absolute; left: -5000px;" aria-hidden="true"><input type="text" name="b_bbe5021ab6fbdc94a16f0d036_a69f6e4652" tabindex="-1" value=""></div>

                    </div>
                  </div>
                  <div class="small-4 medium-5 large-4 columns">
                    <input type="submit" value="Subscribe" name="subscribe" id="mc-embedded-subscribe" class="button postfix secondary">
                  </div>
                </div>
              </div>
            </form>
          </div>
          <script type="text/javascript" src="http://s3.amazonaws.com/downloads.mailchimp.com/js/mc-validate.js"></script><script type="text/javascript">(function($) {window.fnames = new Array(); window.ftypes = new Array();fnames[0]='EMAIL';ftypes[0]='email';fnames[1]='FNAME';ftypes[1]='text';fnames[2]='LNAME';ftypes[2]='text';}(jQuery));var $mcj = jQuery.noConflict(true);</script>
        </div>
      <p>
        And check out the <a href="../../../newsletter.html">archive of newsletters</a>!
      </p>


    </div>
    <div class="columns medium-6">
      <h3>The Book</h3>
      <p>Learn how to build a Rails app with Trailblazer, step-by-step.</p>
      <a href="https://leanpub.com/trailblazer" class="button secondary">Get the book!</a>
    </div>
  </div>
</section>

<footer>
  <div class="row">
    <div class="columns medium-4">
      <div class="logo-box">
        <a href="../../../index.html"><img src="../../../images/icon_trb.png">
        </a>
      </div>
    </div>
    <div class="columns medium-8">
      <div class="row">
        <div class="columns medium-6">
          <h4>
            Trailblazer
          </h4>
          <ul class="no-bullet">
            <li><a href="https://gitter.im/trailblazer/chat">Gitter chat</a></li>
            <li><a href="https://leanpub.com/trailblazer" onclick="trackOutboundLink('https://leanpub.com/trailblazer'); return false;">The book</a></li>
          </ul>
        </div>
        <div class="columns medium-6">
          <h4>
            Follow Us
          </h4>
          <ul class="menu">
            <li>
              <a href="https://github.com/trailblazer">
                <i class="footer-icon github-icon"></i>
              </a>
            </li>
            <li>
              <a href="https://twitter.com/trailblazer_to">
                <i class="footer-icon twitter-icon"></i>
              </a>
            </li>
            <li>
              <a href="https://facebook.com/trailblazer.to">
                <i class="footer-icon facebook-icon"></i>
              </a>
            </li>
          </ul>
        </div>
      </div>
      <p class="copyright">
        Trailblazer is created by <a href="../../../inc/index.html">Trailblazer GmbH</a> and awesome friends.
      </p>
      <p class="copyright">
        Site designed and handcoded with love by <a href="https://twitter.com/noeliacabane">Noelia Cabane</a>
      </p>
    </div>
  </div>
</footer>

<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-69514939-1', 'auto');
  ga('send', 'pageview');

  /**
  * Function that tracks a click on an outbound link in Analytics.
  * This function takes a valid URL string as an argument, and uses that URL string
  * as the event label. Setting the transport method to 'beacon' lets the hit be sent
  * using 'navigator.sendBeacon' in browser that support it.
  */
  var trackOutboundLink = function(url) {
     ga('send', 'event', 'outbound', 'click', url, {
       'transport': 'beacon',
       'hitCallback': function(){document.location = url;}
     });
  }
</script>



  </body>
</html>
