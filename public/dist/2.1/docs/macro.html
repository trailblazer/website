<!DOCTYPE html>
<html lang="en" data-theme="dark">
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, shrink-to-fit=no">

    <title>Trailblazer - Macro</title>

    
    <script src="/vite/assets/documentation.5622eff8.js" crossorigin="anonymous" type="module"></script><link rel="modulepreload" href="/vite/assets/main.8edf4e21.js" as="script" crossorigin="anonymous">
<link rel="modulepreload" href="/vite/assets/initAnchor.90976c72.js" as="script" crossorigin="anonymous"><link rel="stylesheet" href="/vite/assets/main.dca914e8.css" media="screen" />
<link rel="stylesheet" href="/vite/assets/initAnchor.22f475c1.css" media="screen" />

    <link
      href="https://fonts.googleapis.com/css?family=Raleway:200,300,400,500,600,700,800"
      rel="stylesheet"
    >
    <link
      href="https://fonts.googleapis.com/icon?family=Material+Icons"
      rel="stylesheet"
    >
    <link
      rel="preconnect"
      href="https://R2IYF7ETH7-dsn.algolia.net" crossorigin
    >
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/@docsearch/css@3"
    >

    
      <!-- Global site tag (gtag.js) - Google Analytics -->
      <script
        async
        src="https://www.googletagmanager.com/gtag/js?id=UA-69514939-1"
      ></script>
      <script>
        window.dataLayer = window.dataLayer || [];
        function gtag() {
          dataLayer.push(arguments);
        }
        gtag("js", new Date());

        gtag("config", "UA-69514939-1");
      </script>
    

    <link rel="icon" type="image/png" sizes="32x32" href="/vite/assets/favicon.39e9303e.ico">
  </head>
  <body>
    <div class="alert alert-primary m-0 rounded-0 text-center" role="alert">
      <span class="alert-text text-center">
        <!-- The new TRB 2.1 book series has begun - 82 pages are <a class="alert-link" href="https://leanpub.com/buildalib">waiting for you</a>! -->
        Dear Russian friends, please watch President Zelenskyy's
        <a href="https://twitter.com/PMoelleken/status/1496941845812760577">speech addressed to you</a>.
        🇺🇦 Help our brave mates in Ukraine
        <a
          href="https://actions.sumofus.org/a/give-to-ukrainians-who-need-an-urgent-lifeline"
        >
          with a donation
        </a>.
      </span>
    </div>

    <div class="lg-bg">
      <!-- Add class="session-show" if you need a header with dark background -->
      <header
        id="header"
        class="trailblazer-header documentation-navbar navbar navbar-expand-lg flex-column flex-md-row"
      >
        <h1 class="m-2">
          <a class="navbar-brand mr-0 mr-md-2" href="/2.1/index.html">Trailblazer</a>
        </h1>

        <div class="navbar-nav-scroll ml-md-auto">
          <ul class="navbar-nav documentation-nav-items">
  <li>
    <a class="nav-item nav-link active" href="/2.1/docs/trailblazer.html">
      <i class="fas fa-arrow-right"></i>
      DOCS
    </a>
  </li>

  <li>
    <a class="nav-item nav-link " href="https://dev.to/trailblazer">BLOG</a>
  </li>

  <li class="d-none d-md-block">
    <a class="nav-item nav-link " href="/2.1/about_us.html">ABOUT US</a>
  </li>

  <li>
    <a class="nav-item nav-link " href="/2.1/learn.html">LEARN</a>
  </li>

  <li class="d-none d-md-block">
    <a class="nav-item nav-link" href="/2.0/index.html">
      <i class="fas fa-arrow-right"></i>
      2.0
    </a>
  </li>

  <li>
    <a class="nav-item nav-link" href="https://trailblazer.zulipchat.com" target="_blank">
      <i class="fas fa-comments"></i>
      CHAT
    </a>
  </li>

  <!--
  
    <li>
      <div id="docsearch"></div> https://docsearch.algolia.com/docs/DocSearch-v3
    </li>
  
  -->
</ul>

        </div>
      </header>

      <main>
        <section class="documentation-main">
          <div class="container-fluid">
            <div class="row flex-xl-nowrap">
              <div class="col-md-3 col-xl-2 border-bottom order-1 sidebar-accordion sidebar-scroll">
                <form class="d-md-none d-flex align-items-center position-relative py-3 mx-n3 border-bottom">
                  <button
                    class="navbar-toggler collapsed"
                    type="button"
                    data-toggle="collapse"
                    data-target="#navBarTrailBlazer"
                    aria-controls="navBarTrailBlazer"
                    aria-expanded="false"
                    aria-label="Toggle navigation"
                  >
                    <i class="far fa-lg fa-bars"></i>
                  </button>
                </form>
                <div class="collapse d-md-block py-3 mx-n3" id="navBarTrailBlazer">
                  <div class="border-bottom">
  <div class="my-4">
    <div class="sidebar-accordion-wrapper">
  <div id="trailblazer">
    <h2 class="mb-0 mt-1 sidebar-accordion-item">
      <a href="/2.1/docs/trailblazer.html">
        <button
          class="collapsed"
          data-toggle="collapse"
          data-target="#trailblazer-collapse"
          aria-expanded="false"
          aria-controls="trailblazer-collapse"
        >
          <i class="fas fa-chevron-right"></i>
          <i class="fas fa-times"></i>
          <span>Trailblazer</span>
        </button>
      </a>
    </h2>
  </div>

  
</div>

<div class="sidebar-accordion-wrapper">
  <div id="rails-integration">
    <h2 class="mb-0 mt-1 sidebar-accordion-item">
      <a href="/2.1/docs/rails.html">
        <button
          class="collapsed"
          data-toggle="collapse"
          data-target="#rails-integration-collapse"
          aria-expanded="false"
          aria-controls="rails-integration-collapse"
        >
          <i class="fas fa-chevron-right"></i>
          <i class="fas fa-times"></i>
          <span>Rails Integration</span>
        </button>
      </a>
    </h2>
  </div>

  
</div>

<div class="sidebar-accordion-wrapper">
  <div id="test">
    <h2 class="mb-0 mt-1 sidebar-accordion-item">
      <a href="/2.1/docs/test.html">
        <button
          class="collapsed"
          data-toggle="collapse"
          data-target="#test-collapse"
          aria-expanded="false"
          aria-controls="test-collapse"
        >
          <i class="fas fa-chevron-right"></i>
          <i class="fas fa-times"></i>
          <span>Test</span>
        </button>
      </a>
    </h2>
  </div>

  
</div>

  </div>
</div>

<div class="border-bottom">
  <div class="my-4">
    <div class="sidebar-accordion-wrapper">
  <div id="activity">
    <h2 class="mb-0 mt-1 sidebar-accordion-item">
      <a href="/2.1/docs/activity.html">
        <button
          class="collapsed"
          data-toggle="collapse"
          data-target="#activity-collapse"
          aria-expanded="false"
          aria-controls="activity-collapse"
        >
          <i class="fas fa-chevron-right"></i>
          <i class="fas fa-times"></i>
          <span>Activity</span>
        </button>
      </a>
    </h2>
  </div>

  
</div>

<div class="sidebar-accordion-wrapper">
  <div id="macro">
    <h2 class="mb-0 mt-1 sidebar-accordion-item">
      <a href="/2.1/docs/macro.html">
        <button
          class=""
          data-toggle="collapse"
          data-target="#macro-collapse"
          aria-expanded="true"
          aria-controls="macro-collapse"
        >
          <i class="fas fa-chevron-right"></i>
          <i class="fas fa-times"></i>
          <span>Macro</span>
        </button>
      </a>
    </h2>
  </div>

  
    <div
      id="macro-collapse"
      class="collapse show"
      aria-labelledby="macro"
      data-parent="#accordion"
    >
      <ul class="nav vertical menu navbar-light">
        
          <li class="nav-item">
            <a class="nav-link active" href="#macro-overview">
              Overview
            </a>
          </li>
        
          <li class="nav-item">
            <a class="nav-link " href="#macro-nested">
              Nested
            </a>
          </li>
        
          <li class="nav-item">
            <a class="nav-link " href="#macro-wrap">
              Wrap
            </a>
          </li>
        
          <li class="nav-item">
            <a class="nav-link " href="#macro-each">
              Each
            </a>
          </li>
        
          <li class="nav-item">
            <a class="nav-link " href="#macro-model">
              Model
            </a>
          </li>
        
          <li class="nav-item">
            <a class="nav-link " href="#macro-rescue">
              Rescue
            </a>
          </li>
        
          <li class="nav-item">
            <a class="nav-link " href="#macro-policy">
              Policy
            </a>
          </li>
        
      </ul>
    </div>
  
</div>

<div class="sidebar-accordion-wrapper">
  <div id="operation">
    <h2 class="mb-0 mt-1 sidebar-accordion-item">
      <a href="/2.1/docs/operation.html">
        <button
          class="collapsed"
          data-toggle="collapse"
          data-target="#operation-collapse"
          aria-expanded="false"
          aria-controls="operation-collapse"
        >
          <i class="fas fa-chevron-right"></i>
          <i class="fas fa-times"></i>
          <span>Operation</span>
        </button>
      </a>
    </h2>
  </div>

  
</div>

<div class="sidebar-accordion-wrapper">
  <div id="workflow">
    <h2 class="mb-0 mt-1 sidebar-accordion-item">
      <a href="/2.1/docs/workflow.html">
        <button
          class="collapsed"
          data-toggle="collapse"
          data-target="#workflow-collapse"
          aria-expanded="false"
          aria-controls="workflow-collapse"
        >
          <i class="fas fa-chevron-right"></i>
          <i class="fas fa-times"></i>
          <span>Workflow</span>
        </button>
      </a>
    </h2>
  </div>

  
</div>

<div class="sidebar-accordion-wrapper">
  <div id="endpoint">
    <h2 class="mb-0 mt-1 sidebar-accordion-item">
      <a href="/2.1/docs/endpoint.html">
        <button
          class="collapsed"
          data-toggle="collapse"
          data-target="#endpoint-collapse"
          aria-expanded="false"
          aria-controls="endpoint-collapse"
        >
          <i class="fas fa-chevron-right"></i>
          <i class="fas fa-times"></i>
          <span>Endpoint</span>
        </button>
      </a>
    </h2>
  </div>

  
</div>

  </div>
</div>

<div class="border-bottom">
  <div class="my-4">
    <div class="sidebar-accordion-wrapper">
  <div id="reform">
    <h2 class="mb-0 mt-1 sidebar-accordion-item">
      <a href="/2.1/docs/reform.html">
        <button
          class="collapsed"
          data-toggle="collapse"
          data-target="#reform-collapse"
          aria-expanded="false"
          aria-controls="reform-collapse"
        >
          <i class="fas fa-chevron-right"></i>
          <i class="fas fa-times"></i>
          <span>Reform</span>
        </button>
      </a>
    </h2>
  </div>

  
</div>

<div class="sidebar-accordion-wrapper">
  <div id="cells">
    <h2 class="mb-0 mt-1 sidebar-accordion-item">
      <a href="/2.1/docs/cells.html">
        <button
          class="collapsed"
          data-toggle="collapse"
          data-target="#cells-collapse"
          aria-expanded="false"
          aria-controls="cells-collapse"
        >
          <i class="fas fa-chevron-right"></i>
          <i class="fas fa-times"></i>
          <span>Cells</span>
        </button>
      </a>
    </h2>
  </div>

  
</div>

<div class="sidebar-accordion-wrapper">
  <div id="representable">
    <h2 class="mb-0 mt-1 sidebar-accordion-item">
      <a href="/2.1/docs/representable.html">
        <button
          class="collapsed"
          data-toggle="collapse"
          data-target="#representable-collapse"
          aria-expanded="false"
          aria-controls="representable-collapse"
        >
          <i class="fas fa-chevron-right"></i>
          <i class="fas fa-times"></i>
          <span>Representable</span>
        </button>
      </a>
    </h2>
  </div>

  
</div>

<div class="sidebar-accordion-wrapper">
  <div id="disposable">
    <h2 class="mb-0 mt-1 sidebar-accordion-item">
      <a href="/2.1/docs/disposable.html">
        <button
          class="collapsed"
          data-toggle="collapse"
          data-target="#disposable-collapse"
          aria-expanded="false"
          aria-controls="disposable-collapse"
        >
          <i class="fas fa-chevron-right"></i>
          <i class="fas fa-times"></i>
          <span>Disposable</span>
        </button>
      </a>
    </h2>
  </div>

  
</div>

<div class="sidebar-accordion-wrapper">
  <div id="roar">
    <h2 class="mb-0 mt-1 sidebar-accordion-item">
      <a href="/2.1/docs/roar.html">
        <button
          class="collapsed"
          data-toggle="collapse"
          data-target="#roar-collapse"
          aria-expanded="false"
          aria-controls="roar-collapse"
        >
          <i class="fas fa-chevron-right"></i>
          <i class="fas fa-times"></i>
          <span>Roar</span>
        </button>
      </a>
    </h2>
  </div>

  
</div>

  </div>
</div>

<div class="border-bottom">
  <div class="my-4">
    <div class="sidebar-accordion-wrapper">
  <div id="tutorials">
    <h2 class="mb-0 mt-1 sidebar-accordion-item">
      <a href="/2.1/docs/tutorials/activity.html">
        <button
          class="collapsed"
          data-toggle="collapse"
          data-target="#tutorials-collapse"
          aria-expanded="false"
          aria-controls="tutorials-collapse"
        >
          <i class="fas fa-chevron-right"></i>
          <i class="fas fa-times"></i>
          <span>Tutorials</span>
        </button>
      </a>
    </h2>
  </div>

  
</div>

<div class="sidebar-accordion-wrapper">
  <div id="pro">
    <h2 class="mb-0 mt-1 sidebar-accordion-item">
      <a href="/2.1/docs/pro.html">
        <button
          class="collapsed"
          data-toggle="collapse"
          data-target="#pro-collapse"
          aria-expanded="false"
          aria-controls="pro-collapse"
        >
          <i class="fas fa-chevron-right"></i>
          <i class="fas fa-times"></i>
          <span>PRO</span>
        </button>
      </a>
    </h2>
  </div>

  
</div>

  </div>
</div>

                </div>
              </div>

              <main
                class="col-md-9 col-xl-8 py-md-5 pl-md-5 order-2"
                role="main"
              >
                <div class="doc-block section-name session-show">
                  <h1 class="w-100">Macro</h1>
                  <ul>
                    <li>
                      <i class="far fa-clock pink"></i>
                      <span>Last updated 01 Dec 22</span>
                    </li>
                  </ul>
                </div>

                <div class="doc-block">
<p><span class="divider"></span></p>

<h2 id="macro-overview">Overview</h2>
<p><!-- {macro-overview-toc} --></p>

<p><a href="https://github.com/trailblazer/trailblazer-macro" class="pink"><i class="fa fa-gem" aria-hidden="true"></i> trailblazer-macro &gt;= 2.1.11</a></p>

<p>Macros provide shorthand methods to create and configure a particular step in your operation. Trailblazer ships with a handful of macros. Those are implemented in trailblazer-macro and trailblazer-macro-contract.</p>

<p>Writing you own macros is a very simple thing to do if you follow the macro API. <a href="/2.1/docs/activity.html#activity-macro-api"><i class="fa fa-book" aria-hidden="true"></i> API docs</a></p>

<p><span class="divider"></span></p>

<h3 id="macro-overview-general-notes">General notes</h3>
<p><!-- {macro-overview-general-notes-toc} --></p>

<p><span class="divider"></span></p>

<ul class="navigation">
    <li>General notes</li>
    <li id="macro-overview-general-notes-variable-mapping">Variable mapping</li>
</ul>

<p>Most macros internally use <a href="/2.1/docs/activity.html#activity-variable-mapping">variable mapping</a> to allow injection of configuration variables or to limit their own scope. Macros do so by leveraging the composable API using <code>In()</code>, <code>Inject()</code> and <code>Out()</code>.</p>

<p>This allows you to <em>add your own</em> variable mapping to a macro, as illustrated in the example below.</p>

<pre><code>class Create &lt; Trailblazer::Operation
  step Model(Song, :find_by),
    In() =&gt; -&gt;(ctx, my_id:, **) { ctx.merge(params: {id: my_id}) } # Model() needs {params[:id]}.
  # ...
end
</code></pre>

<p>When running the above operation, the exemplary <code>Model()</code> macro will pick the ID from <code>:my_id</code>.</p>

<pre><code>result = Create.(my_id: 1)
</code></pre>

<p>Please note that you shall <strong>not use <code>:input</code></strong> to configure your macro as it will override internal filters and breaks the macro’s configuration. Go with the new <a href="/2.1/docs/activity.html#activity-variable-mapping-composable-i-o">composable variable mapping</a> which is available from <code>trailblazer</code> 2.1.1 and onwards.</p>

<p><span class="divider"></span></p>

<h2 id="macro-nested">Nested</h2>
<p><!-- {macro-nested-toc} --></p>

<p>Only use the <code>Nested()</code> macro if you’re planning to nest an activity that can only be chosen at runtime.</p>

<ul>
  <li>If you know the nested activity upfront, use <a href="">Subprocess()</a>.</li>
  <li>If you know the activities upfront, and need only need to choose at run-time, use the <a href="#macro-nested-auto_wire"><code>:auto_wire</code> option</a>.</li>
</ul>

<p><span class="divider"></span></p>

<h3 id="macro-nested-dynamic">Dynamic</h3>
<p><!-- {macro-nested-dynamic-toc} --></p>

<p>Use <code>Nested()</code> to dynamically decide which nested activity to invoke, but when you don’t know all activities to pick from. This is sometimes the case in polymorphic setups, when a part of an operation needs to be “decided” at runtime, with no way to know what this will look like when writing the operation class.</p>

<p>Consider the following activity to create a song. Depending on the input in <code>params</code>, you either want to run a nested <code>Id3Tag</code> processor activity for an MP3 song, or <code>VorbisComment</code> at a specific point during the song creation.</p>

<pre><code>module Song::Activity
  class Create &lt; Trailblazer::Activity::Railway
    step :model
    step Nested(:decide_file_type) # Run either {Id3Tag} or {VorbisComment}
    step :save
    # ...
    def decide_file_type(ctx, params:, **)
      params[:type] == "mp3" ? Id3Tag : VorbisComment
    end
  end
end
</code></pre>

<p>When using <code>Nested()</code> with only one argument, the <em>decider</em>, we call this the “dynamic style”. Since we don’t know the possible nested activities upfront, the macro needs to compile several internals at runtime, which will be slower than its static equivalent.</p>

<p><span class="divider"></span></p>

<ul class="navigation">
    <li>Dynamic</li>
    <li id="macro-nested-dynamic-decider">Decider</li>
</ul>

<p>The decider can be any “option style” callable: an instance method in the hosting <code>Create</code> activity, any lambda or proc, or a callable object or class. In our example, it’s an instance method.</p>

<p>The decider receives <code>ctx</code> and keyword arguments just like any other step. It is run directly before the nested activity is run, it’s <strong>return value decides about</strong> which one that will be: <code>Id3Tag</code> or <code>VorbisComment</code>.</p>

<p><span class="divider"></span></p>

<ul class="navigation">
    <li>Dynamic</li>
    <li id="macro-nested-dynamic-nested-activity">Nested activity</li>
</ul>

<p>The nested activity (or operation) will, per default, receive the same <code>ctx</code> that a <code>step</code> in place of <code>Nested()</code> would receive.</p>

<pre><code>module Song::Activity
  class Id3Tag &lt; Trailblazer::Activity::Railway
    step :parse
    step :encode_id3
    # ...
  end
end
</code></pre>

<h1 id="dynamic-output">:dynamic-output</h1>

<p><span class="divider"></span></p>

<h3 id="macro-nested-auto_wire">Auto_wire</h3>
<p><!-- {macro-nested-auto_wire-toc} --></p>

<p>The recommended way of maintaining dynamically nested operations (or activities) is to use <code>Nested()</code> with the <code>:auto_wire</code> option. It works exactly like its <a href="#macro-nested-dynamic">purely dynamic</a> counterpart but requires you to specify all possible nested activities <strong>at compile-time</strong>.</p>

<pre><code>module Song::Activity
  class Create &lt; Trailblazer::Activity::Railway
    step :model
    step Nested(:decide_file_type,
      auto_wire: [Id3Tag, VorbisComment]) # explicitely define possible nested activities.
    step :save
    # ...

    def decide_file_type(ctx, params:, **)
      params[:type] == "mp3" ? Id3Tag : VorbisComment
    end
  end
end
</code></pre>

<p>The <code>:auto_wire</code> option expects an array of nested activities. While this might seem a bit clumsy, this brings several benefits. First of all, execution is much faster since the entire activity graph is created at compile-time. Second, you can use the Debugging API to <a href="#macro-nested-auto_wire-debugging">introspect things</a>.</p>

<p>You can use any type of decider step. In this example, it’s a instance method <code>#decide_file_type</code> on the <code>Nested()</code>-hosting class.</p>

<p><img class="mx-auto d-block" src="/vite/assets/nested-static-create.1305287e.png" /></p>

<p>Internally, the “auto-wire” <code>Nested()</code> macro simply returns a small activity as illustrated above in gray. It has a <code>decide</code> step to figure out which nested activity to run, then runs the actual nested activity. All well-known termini (success, failure, pass_fast, fail_fast) of the nested activities are automatically connected to the <code>Nested()</code>’s activity’s termini.</p>

<p><span class="divider"></span></p>

<ul class="navigation">
    <li>Auto_wire</li>
    <li id="macro-nested-auto_wire-output-wiring">Output Wiring</li>
</ul>

<p>Given we had a nested activity <code>VorbisComment</code> implemented like so.</p>

<pre><code>module Song::Activity
  class VorbisComment &lt; Trailblazer::Activity::Railway
    step :prepare_metadata
    step :encode_cover, Output(:failure) =&gt; End(:unsupported_file_format)
    # ...
  end
end
</code></pre>

<p>If the <code>#encode_cover</code> step fails, the activity will stop in the <code>End.unsupported_file_format</code> terminus - an end event very specific to the <code>VorbisComment</code> activity.</p>

<p><img class="mx-auto d-block" src="/vite/assets/nested-static-vorbiscomment.f9f19b24.png" /></p>

<p>This new terminus has to be wired explicitely in the nesting activity.</p>

<pre><code>module Song::Activity
  class Create &lt; Trailblazer::Activity::Railway
    step :model
    step Nested(
        :decide_file_type,
        auto_wire: [Id3Tag, VorbisComment]
      ),
      # Output and friends are used *after* Nested().
      # Connect VorbisComment's {unsupported_file_format} to our {failure} track:
      Output(:unsupported_file_format) =&gt; Track(:failure)

    step :save
    # ...
  end
end
</code></pre>

<p>Using <code>Output(:unsupported_file_type)</code> from the Wiring API you can connect this specific terminus to wherever you need it, here it’s routed to the failure track in <code>Create</code>. Note that Wiring API options are used after <code>Nested(...)</code>, not within its parenthesis.</p>

<p>The complete activity graph would look a bit like the following diagram.</p>

<p><img class="mx-auto d-block" src="/vite/assets/nested-static-complete.0c841265.png" /></p>

<p><span class="divider"></span></p>

<h3 id="macro-nested-compliance">Compliance</h3>
<p><!-- {macro-nested-compliance-toc} --></p>

<p><span class="divider"></span></p>

<ul class="navigation">
    <li>Compliance</li>
    <li id="macro-nested-compliance-debugger">Debugger</li>
</ul>

<p><code>Nested</code> setups are traceable using <code>#wtf?</code>.</p>

<pre><code>Trailblazer::Developer.wtf?(Song::Activity::Create, params: {type: "vorbis"})
</code></pre>

<p>The above examples result in a flow as follows.</p>

<p><img class="mx-auto d-block" src="/vite/assets/nested-static-trace.afc8a7f0.png" /></p>

<p><span class="divider"></span></p>

<ul class="navigation">
    <li>Compliance</li>
    <li id="macro-nested-compliance-introspect">Introspect</li>
</ul>

<p>The trace is fully compatible with the Debugging API and allows compile-time introspection. For example, you can specify the path to a nested activity <code>Id3Tag</code> and inspect it.</p>

<pre><code>Trailblazer::Developer.render(Song::Activity::Create,
  path: [
    "Nested/decide_file_type", # ID of Nested()
    Song::Activity::Id3Tag      # ID of the nested {Id3Tag} activity.
  ]
)
</code></pre>

<p>Note that the ID of the nested activities are the class constants.</p>

<p><span class="divider"></span></p>

<ul class="navigation">
    <li>Compliance</li>
    <li id="macro-nested-compliance-patch">Patch</li>
</ul>

<p><span class="divider"></span></p>

<h2 id="macro-wrap">Wrap</h2>
<p><!-- {macro-wrap-toc} --></p>

<p>Sometimes you need to run a sequence of steps within some block you provide. Often, this is required when certain steps must be wrapped in a database transaction. The <code>Wrap()</code> macro does just that.</p>

<pre><code>module Song::Activity
  class Upload &lt; Trailblazer::Activity::FastTrack
    step :model
    step Wrap(MyTransaction) {
      step :update   # this changes the database.
      step :transfer # this might even break!
    }
    step :notify
    fail :log_error
    # ...
  end
end
</code></pre>

<p>In an imaginary song <code>Upload</code> operation that transfers a music file to some streaming service platform while updating fields on the database, needs the steps <code>#update</code> and <code>#transfer</code> being run inside a transaction. The code running and interpreting this block is provided via the custom transaction <code>MyTransaction</code>.</p>

<p><span class="divider"></span></p>

<h3 id="macro-wrap-wrap-handler">Wrap handler</h3>
<p><!-- {macro-wrap-wrap-handler-toc} --></p>

<p>The most simple “transaction” (we call it <em>wrap handler</em>) could look as follows.</p>

<pre><code>class MyTransaction
  def self.call((ctx, flow_options), **, &amp;block)
    signal, (ctx, flow_options) = yield # calls the wrapped steps

    return signal, [ctx, flow_options]
  end
end
</code></pre>

<p>Your transaction handler can be any type of [callable] exposing the <a href="activity.html#activity-internals-circuit-interface">circuit interface</a>.</p>

<p>In the most simple transaction ever written, we simply run the wrapped steps by calling <code>yield</code>. This will return a circuit-interface return set. The interesting parts are the returned <code>ctx</code>, which is the ctx that left the wrapped steps, and the <code>signal</code>, which indicates the outcome of running the wrapped steps.</p>

<p>Here, we simply return the original signal of the wrapped activity.</p>

<p>Note that internally <code>#update</code> and <code>#transfer</code> are put into a separate activity. The terminus reached in that activity is the signal.</p>

<p><img class="mx-auto d-block" src="/vite/assets/wrap.654e0f7e.png" /></p>

<p>Given that both <code>#update</code> and <code>#transfer</code> are railway steps, the wrapped code can terminate in a <code>success</code> terminus, or a <code>failure</code>.
Now, it’s your handler that is responsible to interpret that. In the example above, we simply pass on the wrapped activity’s terminal signal, making the <code>Upload</code> activity either continue from <code>success</code> or from <code>failure</code>.</p>

<p><span class="divider"></span></p>

<ul class="navigation">
    <li>Wrap handler</li>
    <li id="macro-wrap-wrap-handler-routing">Routing</li>
</ul>

<p>Let’s assume the <code>#transfer</code> step had a custom output that goes to a super-special terminus <code>End.timeout</code>.</p>

<pre><code>step Wrap(MyTransaction) {
  step :update   # this changes the database.
  step :transfer,
    Output(:failure) =&gt; End(:timeout) # creates a third terminus.
},
</code></pre>

<p>The resulting wrapped activity now has three termini.</p>

<p><img class="mx-auto d-block" src="/vite/assets/wrap-timeout.578be5ab.png" /></p>

<p>With our handler, which simply returns the wrapped activity’s signal, it’s possible to route the <code>:timeout</code> signal in <code>Upload</code>. For instance, if a <code>:timeout</code> should be resulting in <code>Upload</code> jumping to the <code>fail_fast</code> track after <code>#transfer</code> terminated in <code>timeout</code>, you can do so.</p>

<pre><code>step Wrap(MyTransaction) {
  step :update   # this changes the database.
  step :transfer,
    Output(:failure) =&gt; End(:timeout) # creates a third terminus.
},
  Output(:timeout) =&gt; Track(:fail_fast) # any wiring is possible here.
</code></pre>

<p>Here’s what the circuit would look like.</p>

<p><img class="mx-auto d-block" src="/vite/assets/wrap-route.81f9692a.png" /></p>

<p><span class="divider"></span></p>

<h3 id="macro-wrap-transaction">Transaction</h3>
<p><!-- {macro-wrap-transaction-toc} --></p>

<p>Wrapping steps into a real database transaction, and rolling back in case of a failure outcome in one of the steps, could look like so.</p>

<pre><code>class MyTransaction
  def self.call((ctx, flow_options), **)
    handler_signal = nil # this is the signal we decide to return from Wrap().

    ActiveRecord::Base.transaction do
      signal, (ctx, flow_options) = yield # call the Wrap block

      # It's now up to us to interpret the wrapped activity's outcome.
      terminus_semantic = signal.to_h[:semantic]

      if [:success, :pass_fast].include?(terminus_semantic)
        handler_signal = Trailblazer::Activity::Right
      else # something in the wrapped steps went wrong:
        handler_signal = Trailblazer::Activity::Left

        raise ActiveRecord::Rollback # This is the only way to tell ActiveRecord to rollback!
      end
    end # transaction

    return handler_signal, [ctx, flow_options]
  end
end
</code></pre>

<p>This might look a bit clumsy, but most of the code is very straight-forward.</p>

<ol>
  <li>Your main intent, wrapping a sequence of steps into an <code>ActiveRecord::Base.transaction</code> block, contains the <code>yield</code> invocation that runs the wrapped steps.</li>
  <li>Having the <code>signal</code> of the wrapped activity returned, you can decide how you’d like to interpret that. Usually, looking at the signals <code>:semantic</code> field indicates the outcome.</li>
  <li>In case you’re not happy, a <code>raise ActiveRecord::Rollback</code> will make ActiveRecord undo whatever database commits happened in the block.</li>
  <li>Instead of returning the nested activity’s <code>signal</code>, which is completely legit, <code>Wrap()</code> also allows you to return a <code>Right</code> or <code>Left</code> signal to communicate the outcome of the entire <code>Wrap()</code> component.</li>
</ol>

<p><span class="divider"></span></p>

<h3 id="macro-wrap-exception-handling">Exception handling</h3>
<p><!-- {macro-wrap-exception-handling-toc} --></p>

<p>Catching and intercepting exceptions in <code>Wrap()</code> works identical to transactions. In case you don’t want to use our canonical <a href="#---FIXME">Rescue() macro</a> here is a sample wrap handler that uses <code>rescue</code> for intercepting exceptions thrown in <code>#update</code> or <code>#transfer</code>.</p>

<pre><code>class MyRescue
  def self.call((ctx, flow_options), **, &amp;block)
    signal, (ctx, flow_options) = yield # calls the wrapped steps

    return signal, [ctx, flow_options]
  rescue
    ctx[:exception] = $!.message
    return Trailblazer::Activity::Left, [ctx, flow_options]
  end
end
</code></pre>

<p>With any exception being thrown, the original signal from the wrapped activity is returned, as if the steps were part of the <code>Upload</code> operation flow.</p>

<p>The code below <code>rescue</code> is only run when an exception was thrown. Here, we write a new variable <code>:exception </code> to the <code>ctx</code> and return <code>Left</code>, indicating an error.</p>

<p><span class="divider"></span></p>

<h3 id="macro-wrap-compliance">Compliance</h3>
<p><!-- {macro-wrap-compliance-toc} --></p>

<p><span class="divider"></span></p>

<ul class="navigation">
    <li>Compliance</li>
    <li id="macro-wrap-compliance-debugger">Debugger</li>
</ul>

<p>You can use tracing with <code>Wrap()</code>.</p>

<pre><code>Trailblazer::Developer.wtf?(Song::Activity::Upload, params: {id: 1})
</code></pre>

<p>The trace per default shows Wrap’s ID.</p>

<p><img class="mx-auto d-block" src="/vite/assets/wrap-trace.b9d35c83.png" /></p>

<p><span class="divider"></span></p>

<ul class="navigation">
    <li>Compliance</li>
    <li id="macro-wrap-compliance-introspect">Introspect</li>
</ul>

<p>You can use any <code>Introspect</code> mechanics on activities using <code>Wrap()</code>.</p>

<pre><code>node, _ = Trailblazer::Developer::Introspect.find_path(
  Song::Activity::Upload,
  ["Wrap/MyTransaction", :transfer])
#=&gt; #&lt;Node ...&gt;
</code></pre>

<p><span class="divider"></span></p>

<ul class="navigation">
    <li>Compliance</li>
    <li id="macro-wrap-compliance-patch">Patch</li>
</ul>

<p><code>Wrap()</code> is compatible with the Patch API, as in, you may replace nested steps or entire activities within the wrapped part.</p>

<p>Consider the <code>Upload</code> activity used throughout this example.</p>

<pre><code>module Song::Activity
  class Upload &lt; Trailblazer::Activity::FastTrack
    step :model
    step Wrap(MyTransaction) {
      step :update   # this changes the database.
      step :transfer # this might even break!
    }
    step :notify
    fail :log_error
    # ...
  end
end
</code></pre>

<p>Say you want to replace the <code>#update</code> step within the wrap with a new step <code>#upsert</code>, you can use <code>Patch</code> as so.</p>

<pre><code>upload_with_upsert = Trailblazer::Activity::DSL::Linear.Patch(
  Song::Activity::Upload,
  ["Wrap/MyTransaction"] =&gt; -&gt; { step :upsert, replace: :update }
)
</code></pre>

<p>The returned new activity <code>upload_with_upsert</code> is a copy of <code>Upload</code> with the respective step replace. Note that in this very example, the method <code>#upsert</code> has to be included in the nested activity.</p>

<p><span class="divider"></span></p>

<h2 id="macro-each">Each</h2>
<p><!-- {macro-each-toc} --></p>

<p><a href="https://github.com/trailblazer/trailblazer-macro" class="pink"><i class="fa fa-gem" aria-hidden="true"></i> trailblazer-macro &gt;= 2.1.12</a></p>

<p>The <code>Each()</code> macro allows to loop over a dataset while invoking a particular operation per iteration, as if multiple identical operations were serially connected, but receiving different input ctxs.</p>

<pre><code>module Song::Activity
  class Cover &lt; Trailblazer::Activity::Railway
    step :model
    step Each(dataset_from: :composers_for_each) {
      step :notify_composers
    }
    step :rearrange

    # "decider interface"
    def composers_for_each(ctx, model:, **)
      model.composers
    end

    def notify_composers(ctx, index:, item:, **)
      Mailer.send(to: item.email, message: "#{index}) You, #{item.full_name}, have been warned about your song being copied.")
    end
    # ...
  end
end
</code></pre>

<p>You can either pass a block with steps to iterate, or an entire operation/activity. In this example, a block is used. Note that you need to use the <code>{}</code> curly braces due to Ruby’s precedence, just as it’s done in <code>Wrap()</code>.</p>

<p><span class="divider"></span></p>

<h3 id="macro-each-dataset_from">dataset_from</h3>
<p><!-- {macro-each-dataset_from-toc} --></p>

<p>While you could simply assign a ctx variable <code>:dataset</code> in a step preceding the <code>Each()</code> macro, the recommended way is using <code>:dataset_from</code> and implementing a dedicated dataset provider.</p>

<pre><code>step Each(dataset_from: :composers_for_each) {
  step :notify_composers
}
</code></pre>

<p>This can be an instance method or any kind of callable, following the “decider interface”.</p>

<pre><code>def composers_for_each(ctx, model:, **)
  model.composers
end
</code></pre>

<p>Note that our dataset provider is an instance method <code>#composers_for_each</code> defined on the operation class hosting <code>Each()</code>. It exposes a step signature with ctx and handy keyword arguments and simply returns the dataset. It explicitely does not write to <code>ctx</code>!</p>

<p>The only requirement to the dataset provider’s return value is that it returns an enumerable object - usually, that’s an array.</p>

<p><span class="divider"></span></p>

<h3 id="macro-each-iterated-block">Iterated Block</h3>
<p><!-- {macro-each-iterated-block-toc} --></p>

<p>Note that the iterated block’s <code>:instance_method</code>s are defined in the <code>Each()</code>-hosting activity, too.</p>

<pre><code>def notify_composers(ctx, index:, item:, **)
  Mailer.send(to: item.email, message: "#{index}) You, #{item.full_name}, have been warned about your song being copied.")
end
</code></pre>

<p>Per default, <code>Each()</code> will loop over the dataset using <code>#each</code> and pass the iterated item and its index into each step of the block, named <code>:item</code> and <code>:index</code>.</p>

<p><span class="divider"></span></p>

<ul class="navigation">
    <li>Iterated Block</li>
    <li id="macro-each-iterated-block-item-key">item key</li>
</ul>

<p>If you don’t like the <code>:item</code> keyword argument in your steps, you can configure it using the <code>:item_key</code> option for <code>Each()</code>.</p>

<pre><code>step Each(dataset_from: :composers_for_each, item_key: :composer) {
  step :notify_composers
}
</code></pre>

<p>The iterated steps now receive a <code>:composer</code> ctx variable instead of <code>:item</code>.</p>

<pre><code>module Song::Activity
  class Cover &lt; Trailblazer::Activity::Railway
    # ...
    def notify_composers(ctx, index:, composer:, **)
      Mailer.send(to: composer.email, message: "#{index}) You, #{composer.full_name}, have been warned about your song being copied.")
    end
  end
end
</code></pre>

<p><span class="divider"></span></p>

<ul class="navigation">
    <li>Iterated Block</li>
    <li id="macro-each-iterated-block-operation">operation</li>
</ul>

<p>If you would like the iterated steps to be within the “block”, use a dedicted activity or operation.</p>

<pre><code>module Song::Activity
  class Cover &lt; Trailblazer::Activity::Railway
    step :model
    step Each(Notify, dataset_from: :composers_for_each)
    step :rearrange
    # ...
  end
end
</code></pre>

<p>The iterated operation is composed of steps that have an identical interface with the block version.</p>

<pre><code>module Song::Activity
  class Notify &lt; Trailblazer::Activity::Railway
    step :send_email

    def send_email(ctx, index:, item:, **)
      Mailer.send(to: item.email, message: "#{index}) You, #{item.full_name}, have been warned about your song being copied.")
    end
  end
end
</code></pre>

<p><span class="divider"></span></p>

<h3 id="macro-each-collect-option">Collect option</h3>
<p><!-- {macro-each-collect-option-toc} --></p>

<p>Ctx variables set within an iteration <a href="#macro-each-variable-mapping">are discarded per default</a>. While you could configure <a href="#macro-each-variable-mapping-filtering">collecting values yourself</a>, you can use the <code>:collect</code> option.</p>

<pre><code>step Each(dataset_from: :composers_for_each, collect: true) {
  step :notify_composers
}
</code></pre>

<p>If one of your iterated steps sets <code>ctx[:value]</code> within <code>Each()</code>, this value will be collected.</p>

<pre><code>def notify_composers(ctx, index:, item:, **)
  Mailer.send(to: item.email, message: "#{index}) You, #{item.full_name}, have been warned about your song being copied.")
end
</code></pre>

<p>All collected values are available at <code>ctx[:collected_from_each]</code> when <code>Each()</code> is finished.</p>

<pre><code>ctx = {params: {id: 1}} # Song 1 has two composers.
signal, (ctx, _) = Trailblazer::Activity::TaskWrap.invoke(B::Song::Activity::Cover, [ctx, {}])

puts ctx[:collected_from_each] #=&gt; [[0, "Fat Mike"], [1, "El Hefe"]]
</code></pre>

<p><span class="divider"></span></p>

<h3 id="macro-each-variable-mapping">Variable mapping</h3>
<p><!-- {macro-each-variable-mapping-toc} --></p>

<p>The <code>Each()</code> macro allows to configure what goes in and out of each iteration. However, it provides a default setting.</p>

<pre><code>step Each(dataset_from: :composers_for_each) {
  step :notify_composers
  step :write_to_ctx
}
</code></pre>

<ul>
  <li>Per default, the iterated steps can see the entire outer <code>ctx</code>, plus <code>:index</code> and <code>:item</code>.</li>
  <li>Any variable written to <code>ctx</code> is discarded after the iteration.</li>
</ul>

<pre><code>def write_to_ctx(ctx, index:, seq:, **)
  # ...
  ctx[:variable] = index # this is discarded!
end
</code></pre>

<p>This default setting assures that no data from the iteration bleeds into the outer ctx.</p>

<p><span class="divider"></span></p>

<ul class="navigation">
    <li>Variable mapping</li>
    <li id="macro-each-variable-mapping-filtering">Filtering</li>
</ul>

<p>You may configure what goes in and out of the iterated activity. Use the variable mapping API by passing arguments to <code>Each()</code>.</p>

<p>For example, say you want to collect messages from each iteration.</p>

<pre><code>module Song::Activity
  class Cover &lt; Trailblazer::Activity::Railway
    step :model
    step Each(dataset_from: :composers_for_each,
      Inject(:messages) =&gt; -&gt;(*) { {} },

      # all filters called before/after each iteration!
      Out() =&gt; [:messages]
    ) {
      step :write_to_ctx
    }
    step :rearrange

    def write_to_ctx(ctx, item:, messages:, index:, **)
      ctx[:messages] = messages.merge(index =&gt; item.full_name)
    end
    # ...
  end
end
</code></pre>

<ol>
  <li>When starting the iteration, the ctx variable <code>:messages</code> will be initialized to an empty hash (unless you provide it in the outside ctx).</li>
  <li>The <code>#write_to_ctx</code> step within <code>Each()</code> sees that <code>:messages</code> variable and can override it, adding its non-sense message to the hash.</li>
  <li>Since you configured <code>Out() =&gt; [:messages]</code>, the following iteration will see that very <code>:messages</code> variable from the last iteration.</li>
</ol>

<p>This allows to collect outgoing variables from the iterations, even in case of failures.</p>

<div class="bd-callout bd-callout-info">
<p>Note how the <code>Inject()</code> and <code>Out()</code> calls are within the parenthesis of <code>Each()</code>.</p>
</div>

<p><span class="divider"></span></p>

<h3 id="macro-each-failure">Failure</h3>
<p><!-- {macro-each-failure-toc} --></p>

<p>If not configured, a failing iterated step leads the entire iteration to be stopped. The <code>Each()</code> activity will terminate on its <code>failure</code> terminus.</p>

<p>You can still access <code>ctx[:collected_from_each]</code> for each iterated block. Note that you can even see which iteration failed in the trace!</p>

<p><img class="mx-auto d-block" src="/vite/assets/each-failure-trace.e74d6e40.png" /></p>

<p>In combination with TRB’s debugger, this gives you a powerful tool for finding bugs in your code or understanding the flow, without having to jump around through iterations using <code>pry</code> or other tools.</p>

<p><span class="divider"></span></p>

<h3 id="macro-each-compliance">Compliance</h3>
<p><!-- {macro-each-compliance-toc} --></p>

<p><span class="divider"></span></p>

<ul class="navigation">
    <li>Compliance</li>
    <li id="macro-each-compliance-debugger">Debugger</li>
</ul>

<p>You can use tracing with <code>Each()</code>.</p>

<pre><code>Trailblazer::Developer.wtf?(Song::Activity::Cover, [{
  params: {id: 1},
  # ...
}])
</code></pre>

<p>Note that a virtual step <code>invoke_block_activity</code> is displayed to group the iterations, suffixed with the number of the iteration.</p>

<p><img class="mx-auto d-block" src="/vite/assets/each-trace.eb26e5fc.png" /></p>

<p>TODO: show how runtime data can be accessed for each iterated block.</p>

<p><span class="divider"></span></p>

<ul class="navigation">
    <li>Compliance</li>
    <li id="macro-each-compliance-introspect">Introspect</li>
</ul>

<p>You can use any <code>Introspect</code> mechanics on the nested activity using <code>Each()</code>.</p>

<pre><code>node, _ = Trailblazer::Developer::Introspect.find_path(
  Song::Activity::Cover,
  ["Each/composers_for_each", "Each.iterate.block", :notify_composers])
#=&gt; #&lt;Node ...&gt;
</code></pre>

<p><span class="divider"></span></p>

<ul class="navigation">
    <li>Compliance</li>
    <li id="macro-each-compliance-patch">Patch</li>
</ul>

<p>You may patch the iterated activity.</p>

<pre><code>cover_patched = Trailblazer::Activity::DSL::Linear.Patch(
  Song::Activity::Cover,
  ["Each/composers_for_each", "Each.iterate.block"] =&gt; -&gt; { step :log_email }
)
</code></pre>

<p>Here, the <code>Each.iterate.block</code> task represents the nested iterated activity.</p>

<p><span class="divider"></span></p>

<h2 id="macro-model">Model</h2>
<p><!-- {macro-model-toc} --></p>

<p>An operation can automatically find or create a model for you depending on the input, with the <code>Model</code> macro.</p>

<pre><code>class Create &lt; Trailblazer::Operation
  step Model(Song, :new)
  # ..
end
</code></pre>

<p>After this step, there is a fresh model instance under <code>ctx[:model]</code> that can be used in all following steps and the returned <code>result</code> object.</p>

<pre><code>result = Create.(params: {})
result[:model] #=&gt; #&lt;struct Song id=nil, title=nil&gt;
</code></pre>

<p>Internally, <code>Model</code> macro will simply invoke <code>Song.new</code> to populate <code>ctx[:model]</code>.</p>

<p><span class="divider"></span></p>

<h3 id="macro-model-find_by">Find_by</h3>
<p><!-- {macro-model-find_by-toc} --></p>

<p>You can also find models using <code>:find_by</code>. This is helpful for <code>Update</code> or <code>Delete</code> operations.</p>

<pre><code>class Update &lt; Trailblazer::Operation
  step Model( Song, :find_by )
  # ..
end
</code></pre>

<p>The <code>Model</code> macro will invoke the following code for you.</p>

<pre><code>ctx[:model] = Song.find_by( id: params[:id] )
</code></pre>

<p>This will assign <code>[:model]</code> for you by invoking <code>find_by</code>.</p>

<pre><code>result = Update.(params: { id: 1 })
result[:model] #=&gt; #&lt;struct Song id=1, title="nil"&gt;
</code></pre>

<p>If <code>Song.find_by</code> returns <code>nil</code>, this will deviate to the left track, skipping the rest of the operation.</p>

<pre><code>result = Update.(params: {})
result[:model] #=&gt; nil
result.success? #=&gt; false
</code></pre>

<p>It is also possible to <code>find_by</code> with attribute other than <code>id</code>. For example,</p>

<pre><code>class UpdateWithFindByKey &lt; Trailblazer::Operation
  step Model( Song, :find_by, :title )
  # ..
end
</code></pre>

<p>Note that you may also use <code>:find</code>. This is not recommended, though, since it raises an exception, which is not the preferred way of flow control in Trailblazer.</p>

<p><span class="divider"></span></p>

<h3 id="macro-model-arbitrary-finder">Arbitrary Finder</h3>
<p><!-- {macro-model-arbitrary-finder-toc} --></p>

<p>It’s possible to specify any finder method, which is helpful with ROMs such as Sequel.</p>

<pre><code>class Show &lt; Trailblazer::Operation
  step Model( Song, :[] )
  # ..
end
</code></pre>

<p>The provided method will be invoked and Trailblazer passes it the <code>params[:id]</code> value.</p>

<pre><code>Song[ params[:id] ]
</code></pre>

<p>Given your database gem provides that finder, it will result in a successful query.</p>

<pre><code>result = Show.(params: { id: 1 })
result[:model] #=&gt; #&lt;struct Song id=1, title="Roxanne"&gt;
</code></pre>

<p><span class="divider"></span></p>

<h3 id="macro-model-not-found">Not Found</h3>
<p><!-- {macro-model-not-found-toc} --></p>

<p>With the help of <a href="/2.1/docs/endpoint.html">endpoint</a>, it is possible to connect failure of this step to render <strong>404 response</strong> directly.
As a result, you don’t need to conditionally check if <code>ctx[:model]</code> is present or not.</p>

<p><img class="mx-auto d-block" src="/vite/assets/macro-ends.bedbd22e.webp" /></p>

<p>To emit <code>End.not_found</code> signal, you need to pass <code>not_found_terminus</code> kwarg.</p>

<pre><code>class UpdateFailureWithModelNotFound &lt; Trailblazer::Operation
  step Model( Song, :find_by, not_found_terminus: true )
  # ..
end
</code></pre>

<p>Internally, it is just telling <a href="/2.1/docs/activity.html#activity-wiring-api-output-implicit-signal"><code>Output(:failure)</code></a> to emit <a href="/2.1/docs/activity.html#activity-wiring-api-end-"><code>End(:not_found)</code></a></p>

<pre><code>result = UpdateFailureWithModelNotFound.(params: {title: nil})
result[:model] #=&gt; nil
result.success? #=&gt; false
result.event #=&gt; #&lt;Trailblazer::Activity::End semantic=:not_found&gt;
</code></pre>

<p><span class="divider"></span></p>

<h3 id="macro-model-dependency-injection">Dependency Injection</h3>
<p><!-- {macro-model-dependency-injection-toc} --></p>

<p>The following <code>Model()</code> options can be injected using variables when <code>call</code>ing the operation.</p>

<ul>
  <li><code>:"model.class"</code> which represents the first argument for <code>Model()</code>.</li>
  <li><code>:"model.action"</code> representing the second argument.</li>
  <li><code>:"model.find_by_key"</code> which represents the third argument.</li>
</ul>

<p>As per your design, you may inject one or more of those variables as follows.</p>

<pre><code>result = Create.(
  params:               {title: "Olympia"}, # some random variable.
  "model.class":        Hit,
  "model.action":       :find_by,
  "model.find_by_key": :title
)
</code></pre>

<p>You can even leave <code>Model()</code> entirely unconfigured.</p>

<pre><code>class Create &lt; Trailblazer::Operation
  step Model()
  # ..
end
</code></pre>

<p>This implies you inject all required variables at run-time.</p>

<p><span class="divider"></span></p>

<ul class="navigation">
    <li>Dependency Injection</li>
    <li id="macro-model-dependency-injection-model-class">Model class</li>
</ul>

<p>Usually, the specific model class for <code>Model()</code> is set directly in the macro.</p>

<pre><code>class Create &lt; Trailblazer::Operation
  step Model(Song, :new)
  # ..
end
</code></pre>

<p>Nevertheless, it’s possible to override it using the <code>:"model.class"</code> variable when invoking the operation/activity.</p>

<pre><code>result = Create.(params: {}, :"model.class" =&gt; Hit)
</code></pre>

<p>Note that you <a href="">don’t have  to configure</a> any model class at all when injecting it.</p>

<p><span class="divider"></span></p>

<h2 id="macro-rescue">Rescue</h2>
<p><!-- {macro-rescue-toc} --></p>

<p>While you can write your own <code>begin/rescue/end</code> mechanics using <a href="#wrap"><code>Wrap</code></a>, Trailblazer offers you the <code>Rescue</code> macro to catch and handle exceptions that might occur while running the pipe.</p>

<pre><code>class Memo::Create &lt; Trailblazer::Operation
  step :find_model
  step Rescue( RuntimeError, handler: MyHandler ) {
    step :update
    step :rehash
  }
  step :notify
  fail :log_error
  # ...
end
</code></pre>

<p>Any exception raised during a step in the <code>Rescue</code> block will stop the nested pipe from being executed, and continue after the block on the left track.</p>

<p>You can specify what exceptions to catch and an optional handler that is called when an exception is encountered.</p>

<pre><code>class MyHandler
  def self.call(exception, (ctx), *)
    ctx[:exception_class] = exception.class
  end
end
</code></pre>

<p>Alternatively, you can use a  <code>Callable</code> object for <code>:handler</code>.</p>

<p><span class="divider"></span></p>

<h3 id="macro-rescue-full-example">Full example</h3>
<p><!-- {macro-rescue-full-example-toc} --></p>

<p>The  <code>Nested</code>, <code>Wrap</code> and <code>Rescue</code> macros can also be nested, allowing an easily extendable business workflow with error handling along the way.</p>

<p>TODO: add example</p>

<p><span class="divider"></span></p>

<h2 id="macro-policy">Policy</h2>
<p><!-- {macro-policy-toc} --></p>

<p>The <code>Policy</code> macros <a href="#pundit"><code>Policy::Pundit</code></a>, and <a href="#guard"><code>Policy::Guard</code></a> help to implement permission decider steps.</p>

<p><span class="divider"></span></p>

<h3 id="macro-policy-pundit">Pundit</h3>
<p><!-- {macro-policy-pundit-toc} --></p>

<p>The <code>Policy::Pundit</code> module allows using <a href="https://github.com/elabs/pundit">Pundit</a>-compatible policy classes in an operation.</p>

<p>A Pundit policy has various rule methods and a special constructor that receives the current user and the current model.</p>

<pre><code>class MyPolicy
  def initialize(user, model)
    @user, @model = user, model
  end

  def create?
    @user == Module &amp;&amp; @model.id.nil?
  end

  def new?
    @user == Class
  end
end
</code></pre>

<p>In pundit policies, it is a convention to have access to those objects at runtime and build rules on top of those.</p>

<p>You can plug this policy into your pipe at any point. However, this must be inserted after the <code>"model"</code> skill is available.</p>

<pre><code>class Create &lt; Trailblazer::Operation
  step Model( Song, :new )
  step Policy::Pundit( MyPolicy, :create? )
  # ...
end
</code></pre>

<p>Note that you don’t have to create the model via the <code>Model</code> macro - you can use any logic you want. The <code>Pundit</code> macro will grab the model from <code>["model"]</code>, though.</p>

<p>This policy will only pass when the operation is invoked as follows.</p>

<pre><code>Create.(current_user: User.find(1))
</code></pre>

<p>Any other call will cause a policy breach and stop the pipe from executing after the <code>Policy::Pundit</code> step.</p>

<p><span class="divider"></span></p>

<ul class="navigation">
    <li>Pundit</li>
    <li id="macro-policy-pundit-api">API</li>
</ul>

<p>Add your polices using the <code>Policy::Pundit</code> macro. It accepts the policy class name, and the rule method to call.</p>

<pre><code>class Create &lt; Trailblazer::Operation
  step Model( Song, :new )
  step Policy::Pundit( MyPolicy, :create? )
  # ...
end
</code></pre>

<p>The step will create the policy instance automatically for you and passes the <code>"model"</code> and the <code>"current_user"</code> skill into the policies constructor. Just make sure those dependencies are available before the step is executed.</p>

<p>If the policy returns <code>falsey</code>, it <a href="api.html#flow-control-step">deviates to the left track</a>.</p>

<p>After running the <code>Pundit</code> step, its result is readable from the <code>Result</code> object.</p>

<pre><code>result = Create.(params: {}, current_user: Module)
result[:"result.policy.default"].success? #=&gt; true
result[:"result.policy.default"][:policy] #=&gt; #&lt;MyPolicy ...&gt;
</code></pre>

<p>Note that the actual policy instance is available via <code>["result.policy.#{name}"]["policy"]</code> to be reinvoked with other rules (e.g. in the view layer).</p>

<p><span class="divider"></span></p>

<ul class="navigation">
    <li>Pundit</li>
    <li id="macro-policy-pundit-name">Name</li>
</ul>

<p>You can add any number of Pundit policies to your pipe. Make sure to use <code>name:</code> to name them, though.</p>

<pre><code>class Create &lt; Trailblazer::Operation
  step Model( Song, :new )
  step Policy::Pundit( MyPolicy, :create?, name: "after_model" )
  # ...
end
</code></pre>

<p>The result will be stored in <code>"result.policy.#{name}"</code></p>

<pre><code>result = Create.(params: {}, current_user: Module)
result[:"result.policy.after_model"].success? #=&gt; true
</code></pre>

<p><span class="divider"></span></p>

<ul class="navigation">
    <li>Pundit</li>
    <li id="macro-policy-pundit-dependency-injection">Dependency Injection</li>
</ul>

<p>Override a configured policy using dependency injection.</p>

<pre><code>Create.(params: {},
  current_user:            Module,
  :"policy.default.eval" =&gt; Trailblazer::Operation::Policy::Pundit.build(AnotherPolicy, :create?)
)
</code></pre>

<p>You can inject it using <code>"policy.#{name}.eval"</code>. It can be any object responding to <code>call</code>.</p>

<p><span class="divider"></span></p>

<h3 id="macro-policy-guard">Guard</h3>
<p><!-- {macro-policy-guard-toc} --></p>

<p>A guard is a step that helps you evaluating a condition and writing the result. If the condition was evaluated as <code>falsey</code>, the pipe won’t be further processed and a policy breach is reported in <code>Result["result.policy.default"]</code>.</p>

<pre><code>class Create &lt; Trailblazer::Operation
  step Policy::Guard(-&gt;(options, pass:, **) { pass })
  step :process

  def process(options, **)
    options[:x] = true
  end
end
</code></pre>

<p>The only way to make the above operation invoke the second step <code>:process</code> is as follows.</p>

<pre><code>result = Create.({ pass: true })
result["x"] #=&gt; true
</code></pre>

<p>Any other input will result in an abortion of the pipe after the guard.</p>

<pre><code>result = Create.()
result["x"] #=&gt; nil
result["result.policy.default"].success? #=&gt; false
</code></pre>

<p>Learn more about <a href="skill.md">→ dependency injection</a> to pass params and current user into the operation. TODO: fix link</p>

<p><span class="divider"></span></p>

<ul class="navigation">
    <li>Guard</li>
    <li id="macro-policy-guard-api">API</li>
</ul>

<p>The <code>Policy::Guard</code> macro helps you inserting your guard logic. If not defined, it will be evaluated <a href="#guard-position">where you insert</a> it.</p>

<pre><code>step :process

def process(options, **)
  options[:x] = true
end
</code></pre>

<p>The <code>options</code> object is passed into the guard and allows you to read and inspect data like <code>params</code> or <code>current_user</code>. Please use kw args.</p>

<p><span class="divider"></span></p>

<ul class="navigation">
    <li>Guard</li>
    <li id="macro-policy-guard-callable">Callable</li>
</ul>

<p>As always, the guard can also be a <code>Callable</code>-marked object.</p>

<pre><code>class MyGuard
  def call(options, pass:, **)
    pass
  end
end
</code></pre>

<p>Insert the object instance via the <code>Policy::Guard</code> macro.</p>

<pre><code>class Create &lt; Trailblazer::Operation
  step Policy::Guard( MyGuard.new )
  step :process

  # ...
end
</code></pre>

<p><span class="divider"></span></p>

<ul class="navigation">
    <li>Guard</li>
    <li id="macro-policy-guard-instance-method">Instance Method</li>
</ul>

<p>As always, you may also use an instance method to implement a guard.</p>

<pre><code>class Create &lt; Trailblazer::Operation
  step Policy::Guard( :pass? )

  def pass?(options, pass:, **)
    pass
  end
  step :process
  # ...
end
</code></pre>

<p><span class="divider"></span></p>

<ul class="navigation">
    <li>Guard</li>
    <li id="macro-policy-guard-name">Name</li>
</ul>

<p>The guard name defaults to <code>default</code> and can be set via <code>name:</code>. This allows having multiple guards.</p>

<pre><code>class Create &lt; Trailblazer::Operation
  step Policy::Guard( -&gt;(options, current_user:, **) { current_user }, name: :user )
  # ...
end
</code></pre>

<p>The result will sit in <code>result.policy.#{name}</code>.</p>

<pre><code>result = Create.(:current_user =&gt; true)
result[:"result.policy.user"].success? #=&gt; true
</code></pre>

<p><span class="divider"></span></p>

<ul class="navigation">
    <li>Guard</li>
    <li id="macro-policy-guard-dependency-injection">Dependency Injection</li>
</ul>

<p>Instead of using the configured guard, you can inject any callable object that returns a <code>Result</code> object. Do so by overriding the <code>policy.#{name}.eval</code> path when calling the operation.</p>

<pre><code>Create.(
  :current_user           =&gt; Module,
  :"policy.default.eval"  =&gt; Trailblazer::Operation::Policy::Guard.build(-&gt;(options, **) { false })
)
</code></pre>

<p>An easy way to let Trailblazer build a compatible object for you is using <code>Guard.build</code>.</p>

<p>This is helpful to override a certain policy for testing, or to invoke it with special rights, e.g. for an admin.</p>

<p><span class="divider"></span></p>

<ul class="navigation">
    <li>Guard</li>
    <li id="macro-policy-guard-position">Position</li>
</ul>

<p>You may specify a position.</p>

<pre><code>class Create &lt; Trailblazer::Operation
  step :model!
  step Policy::Guard( :authorize! ),
    before: :model!
end
</code></pre>

<p>Resulting in the guard inserted before <code>model!</code>, even though it was added at a later point.</p>

<pre><code>  Trailblazer::Developer.railway(Create, style: :rows) #=&gt;
   # 0 ========================&gt;operation.new
   # 1 ==================&gt;policy.default.eval
   # 2 ===============================&gt;model!
</code></pre>

<p>This is helpful if you maintain modules for operations with generic steps.</p>

</div>

                <aside>
                  <span class="deco-purple-cross wow fadeIn"></span>
                </aside>
              </main>

              <div class="d-none d-xl-block col-xl-2 list-group sidebar-scroll order-3">
                <img alt="Trailblazer" class="wow fadeIn" src="/vite/assets/deco1.51110a75.webp" />
                <div class="features" id="macro-overview-features">
  <h3>
    <i class="fas fa-times"></i>
    <span>Overview</span>
  </h3>

  <ul class="vertical menu">
    
      <li>
        <a href="#macro-overview-general-notes">
          <i class="fas fa-arrow-right"></i>
          General notes
        </a>
      </li>
      
        
        <li class="sub-item">
          <a href="#macro-overview-general-notes-variable-mapping">Variable mapping</a>
        </li>
      
    
  </ul>
</div>

<div class="features" id="macro-nested-features">
  <h3>
    <i class="fas fa-times"></i>
    <span>Nested</span>
  </h3>

  <ul class="vertical menu">
    
      <li>
        <a href="#macro-nested-dynamic">
          <i class="fas fa-arrow-right"></i>
          Dynamic
        </a>
      </li>
      
        
        <li class="sub-item">
          <a href="#macro-nested-dynamic-decider">Decider</a>
        </li>
      
        
        <li class="sub-item">
          <a href="#macro-nested-dynamic-nested-activity">Nested activity</a>
        </li>
      
    
      <li>
        <a href="#macro-nested-auto_wire">
          <i class="fas fa-arrow-right"></i>
          Auto_wire
        </a>
      </li>
      
        
        <li class="sub-item">
          <a href="#macro-nested-auto_wire-output-wiring">Output Wiring</a>
        </li>
      
    
      <li>
        <a href="#macro-nested-compliance">
          <i class="fas fa-arrow-right"></i>
          Compliance
        </a>
      </li>
      
        
        <li class="sub-item">
          <a href="#macro-nested-compliance-debugger">Debugger</a>
        </li>
      
        
        <li class="sub-item">
          <a href="#macro-nested-compliance-introspect">Introspect</a>
        </li>
      
        
        <li class="sub-item">
          <a href="#macro-nested-compliance-patch">Patch</a>
        </li>
      
    
  </ul>
</div>

<div class="features" id="macro-wrap-features">
  <h3>
    <i class="fas fa-times"></i>
    <span>Wrap</span>
  </h3>

  <ul class="vertical menu">
    
      <li>
        <a href="#macro-wrap-wrap-handler">
          <i class="fas fa-arrow-right"></i>
          Wrap handler
        </a>
      </li>
      
        
        <li class="sub-item">
          <a href="#macro-wrap-wrap-handler-routing">Routing</a>
        </li>
      
    
      <li>
        <a href="#macro-wrap-transaction">
          <i class="fas fa-arrow-right"></i>
          Transaction
        </a>
      </li>
      
    
      <li>
        <a href="#macro-wrap-exception-handling">
          <i class="fas fa-arrow-right"></i>
          Exception handling
        </a>
      </li>
      
    
      <li>
        <a href="#macro-wrap-compliance">
          <i class="fas fa-arrow-right"></i>
          Compliance
        </a>
      </li>
      
        
        <li class="sub-item">
          <a href="#macro-wrap-compliance-debugger">Debugger</a>
        </li>
      
        
        <li class="sub-item">
          <a href="#macro-wrap-compliance-introspect">Introspect</a>
        </li>
      
        
        <li class="sub-item">
          <a href="#macro-wrap-compliance-patch">Patch</a>
        </li>
      
    
  </ul>
</div>

<div class="features" id="macro-each-features">
  <h3>
    <i class="fas fa-times"></i>
    <span>Each</span>
  </h3>

  <ul class="vertical menu">
    
      <li>
        <a href="#macro-each-dataset_from">
          <i class="fas fa-arrow-right"></i>
          dataset_from
        </a>
      </li>
      
    
      <li>
        <a href="#macro-each-iterated-block">
          <i class="fas fa-arrow-right"></i>
          Iterated Block
        </a>
      </li>
      
        
        <li class="sub-item">
          <a href="#macro-each-iterated-block-item-key">item key</a>
        </li>
      
        
        <li class="sub-item">
          <a href="#macro-each-iterated-block-operation">operation</a>
        </li>
      
    
      <li>
        <a href="#macro-each-collect-option">
          <i class="fas fa-arrow-right"></i>
          Collect option
        </a>
      </li>
      
    
      <li>
        <a href="#macro-each-variable-mapping">
          <i class="fas fa-arrow-right"></i>
          Variable mapping
        </a>
      </li>
      
        
        <li class="sub-item">
          <a href="#macro-each-variable-mapping-filtering">Filtering</a>
        </li>
      
    
      <li>
        <a href="#macro-each-failure">
          <i class="fas fa-arrow-right"></i>
          Failure
        </a>
      </li>
      
    
      <li>
        <a href="#macro-each-compliance">
          <i class="fas fa-arrow-right"></i>
          Compliance
        </a>
      </li>
      
        
        <li class="sub-item">
          <a href="#macro-each-compliance-debugger">Debugger</a>
        </li>
      
        
        <li class="sub-item">
          <a href="#macro-each-compliance-introspect">Introspect</a>
        </li>
      
        
        <li class="sub-item">
          <a href="#macro-each-compliance-patch">Patch</a>
        </li>
      
    
  </ul>
</div>

<div class="features" id="macro-model-features">
  <h3>
    <i class="fas fa-times"></i>
    <span>Model</span>
  </h3>

  <ul class="vertical menu">
    
      <li>
        <a href="#macro-model-find_by">
          <i class="fas fa-arrow-right"></i>
          Find_by
        </a>
      </li>
      
    
      <li>
        <a href="#macro-model-arbitrary-finder">
          <i class="fas fa-arrow-right"></i>
          Arbitrary Finder
        </a>
      </li>
      
    
      <li>
        <a href="#macro-model-not-found">
          <i class="fas fa-arrow-right"></i>
          Not Found
        </a>
      </li>
      
    
      <li>
        <a href="#macro-model-dependency-injection">
          <i class="fas fa-arrow-right"></i>
          Dependency Injection
        </a>
      </li>
      
        
        <li class="sub-item">
          <a href="#macro-model-dependency-injection-model-class">Model class</a>
        </li>
      
    
  </ul>
</div>

<div class="features" id="macro-rescue-features">
  <h3>
    <i class="fas fa-times"></i>
    <span>Rescue</span>
  </h3>

  <ul class="vertical menu">
    
      <li>
        <a href="#macro-rescue-full-example">
          <i class="fas fa-arrow-right"></i>
          Full example
        </a>
      </li>
      
    
  </ul>
</div>

<div class="features" id="macro-policy-features">
  <h3>
    <i class="fas fa-times"></i>
    <span>Policy</span>
  </h3>

  <ul class="vertical menu">
    
      <li>
        <a href="#macro-policy-pundit">
          <i class="fas fa-arrow-right"></i>
          Pundit
        </a>
      </li>
      
        
        <li class="sub-item">
          <a href="#macro-policy-pundit-api">API</a>
        </li>
      
        
        <li class="sub-item">
          <a href="#macro-policy-pundit-name">Name</a>
        </li>
      
        
        <li class="sub-item">
          <a href="#macro-policy-pundit-dependency-injection">Dependency Injection</a>
        </li>
      
    
      <li>
        <a href="#macro-policy-guard">
          <i class="fas fa-arrow-right"></i>
          Guard
        </a>
      </li>
      
        
        <li class="sub-item">
          <a href="#macro-policy-guard-api">API</a>
        </li>
      
        
        <li class="sub-item">
          <a href="#macro-policy-guard-callable">Callable</a>
        </li>
      
        
        <li class="sub-item">
          <a href="#macro-policy-guard-instance-method">Instance Method</a>
        </li>
      
        
        <li class="sub-item">
          <a href="#macro-policy-guard-name">Name</a>
        </li>
      
        
        <li class="sub-item">
          <a href="#macro-policy-guard-dependency-injection">Dependency Injection</a>
        </li>
      
        
        <li class="sub-item">
          <a href="#macro-policy-guard-position">Position</a>
        </li>
      
    
  </ul>
</div>

              </div>
            </div>
          </div>
        </section>
      </main>

      <footer class="trailblazer-footer">
  <div class="container">
    <div class="row align-items-center">
      <div class="col-md-3 col-lg-2">
        <a href="/2.1/index.html" class="logo-footer">Trailblazer</a>
      </div>
      <div class="col-md-6 col-lg-8">
        <nav>
          <ul class="navbar-nav documentation-nav-items">
  <li>
    <a class="nav-item nav-link active" href="/2.1/docs/trailblazer.html">
      <i class="fas fa-arrow-right"></i>
      DOCS
    </a>
  </li>

  <li>
    <a class="nav-item nav-link " href="https://dev.to/trailblazer">BLOG</a>
  </li>

  <li class="">
    <a class="nav-item nav-link " href="/2.1/about_us.html">ABOUT US</a>
  </li>

  <li>
    <a class="nav-item nav-link " href="/2.1/learn.html">LEARN</a>
  </li>

  <li class="">
    <a class="nav-item nav-link" href="/2.0/index.html">
      <i class="fas fa-arrow-right"></i>
      2.0
    </a>
  </li>

  <li>
    <a class="nav-item nav-link" href="https://trailblazer.zulipchat.com" target="_blank">
      <i class="fas fa-comments"></i>
      CHAT
    </a>
  </li>

  <!--
  
  -->
</ul>

        </nav>
      </div>
      <div class="col-md-3 col-lg-2">
        <ul class="social purple">
          <li>
            <a href="https://github.com/trailblazer" target="_blank"><i class="fab fa-github-square"></i></a>
          </li>
          <li>
            <a href="https://www.facebook.com/trailblazer.to" target="_blank"><i class="fab fa-facebook-square"></i></a>
          </li>
          <li>
            <a href="https://twitter.com/trailblazer_to" target="_blank"><i class="fab fa-twitter-square"></i></a>
          </li>
        </ul>
      </div>
    </div>
  </div>
</footer>

    </div>
  </body>
</html>
