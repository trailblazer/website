<!DOCTYPE html>
<html lang="en" data-theme="dark">
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, shrink-to-fit=no">

    <title>Trailblazer - Operation</title>

    <script src="/vite-dev/@vite/client" type="module"></script>
    <script src="/vite-dev/entrypoints/documentation.js" crossorigin="anonymous" type="module"></script>

    <link
      href="https://fonts.googleapis.com/css?family=Raleway:200,300,400,500,600,700,800"
      rel="stylesheet"
    >
    <link
      href="https://fonts.googleapis.com/icon?family=Material+Icons"
      rel="stylesheet"
    >
    <link
      rel="preconnect"
      href="https://R2IYF7ETH7-dsn.algolia.net" crossorigin
    >
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/@docsearch/css@3"
    >

    

    <link rel="icon" type="image/png" sizes="32x32" href="/vite-dev/images/favicon.ico">
  </head>
  <body>
    <div class="alert alert-primary m-0 rounded-0 text-center" role="alert">
      <span class="alert-text text-center">
        <!-- The new TRB 2.1 book series has begun - 82 pages are <a class="alert-link" href="https://leanpub.com/buildalib">waiting for you</a>! -->
        Dear Russian friends, please watch President Zelenskyy's
        <a href="https://twitter.com/PMoelleken/status/1496941845812760577">speech addressed to you</a>.
        🇺🇦 Help our brave mates in Ukraine
        <a
          href="https://actions.sumofus.org/a/give-to-ukrainians-who-need-an-urgent-lifeline"
        >
          with a donation
        </a>.
      </span>
    </div>

    <div class="lg-bg">
      <!-- Add class="session-show" if you need a header with dark background -->
      <header
        id="header"
        class="trailblazer-header documentation-navbar navbar navbar-expand-lg flex-column flex-md-row"
      >
        <h1 class="m-2">
          <a class="navbar-brand mr-0 mr-md-2" href="/2.1/index.html">Trailblazer</a>
        </h1>

        <div class="navbar-nav-scroll ml-md-auto">
          <ul class="navbar-nav documentation-nav-items">
  <li>
    <a class="nav-item nav-link active" href="/2.1/docs/trailblazer.html">
      <i class="fas fa-arrow-right"></i>
      DOCS
    </a>
  </li>

  <li>
    <a class="nav-item nav-link " href="https://dev.to/trailblazer">BLOG</a>
  </li>

  <li class="d-none d-md-block">
    <a class="nav-item nav-link " href="/2.1/about_us.html">ABOUT US</a>
  </li>

  <li>
    <a class="nav-item nav-link " href="/2.1/learn.html">LEARN</a>
  </li>

  <li class="d-none d-md-block">
    <a class="nav-item nav-link" href="/2.0/index.html">
      <i class="fas fa-arrow-right"></i>
      2.0
    </a>
  </li>

  <li>
    <a class="nav-item nav-link" href="https://trailblazer.zulipchat.com" target="_blank">
      <i class="fas fa-comments"></i>
      CHAT
    </a>
  </li>

  <!--
  
    <li>
      <div id="docsearch"></div> https://docsearch.algolia.com/docs/DocSearch-v3
    </li>
  
  -->
</ul>

        </div>
      </header>

      <main>
        <section class="documentation-main">
          <div class="container-fluid">
            <div class="row flex-xl-nowrap">
              <div class="col-md-3 col-xl-2 border-bottom order-1 sidebar-accordion sidebar-scroll">
                <form class="d-md-none d-flex align-items-center position-relative py-3 mx-n3 border-bottom">
                  <button
                    class="navbar-toggler collapsed"
                    type="button"
                    data-toggle="collapse"
                    data-target="#navBarTrailBlazer"
                    aria-controls="navBarTrailBlazer"
                    aria-expanded="false"
                    aria-label="Toggle navigation"
                  >
                    <i class="far fa-lg fa-bars"></i>
                  </button>
                </form>
                <div class="collapse d-md-block py-3 mx-n3" id="navBarTrailBlazer">
                  <div class="border-bottom">
  <div class="my-4">
    <div class="sidebar-accordion-wrapper">
  <div id="trailblazer">
    <h2 class="mb-0 mt-1 sidebar-accordion-item">
      <a href="/2.1/docs/trailblazer.html">
        <button
          class="collapsed"
          data-toggle="collapse"
          data-target="#trailblazer-collapse"
          aria-expanded="false"
          aria-controls="trailblazer-collapse"
        >
          <i class="fas fa-chevron-right"></i>
          <i class="fas fa-times"></i>
          <span>Trailblazer</span>
        </button>
      </a>
    </h2>
  </div>

  
</div>

<div class="sidebar-accordion-wrapper">
  <div id="rails-integration">
    <h2 class="mb-0 mt-1 sidebar-accordion-item">
      <a href="/2.1/docs/rails.html">
        <button
          class="collapsed"
          data-toggle="collapse"
          data-target="#rails-integration-collapse"
          aria-expanded="false"
          aria-controls="rails-integration-collapse"
        >
          <i class="fas fa-chevron-right"></i>
          <i class="fas fa-times"></i>
          <span>Rails Integration</span>
        </button>
      </a>
    </h2>
  </div>

  
</div>

<div class="sidebar-accordion-wrapper">
  <div id="test">
    <h2 class="mb-0 mt-1 sidebar-accordion-item">
      <a href="/2.1/docs/test.html">
        <button
          class="collapsed"
          data-toggle="collapse"
          data-target="#test-collapse"
          aria-expanded="false"
          aria-controls="test-collapse"
        >
          <i class="fas fa-chevron-right"></i>
          <i class="fas fa-times"></i>
          <span>Test</span>
        </button>
      </a>
    </h2>
  </div>

  
</div>

  </div>
</div>

<div class="border-bottom">
  <div class="my-4">
    <div class="sidebar-accordion-wrapper">
  <div id="activity">
    <h2 class="mb-0 mt-1 sidebar-accordion-item">
      <a href="/2.1/docs/activity.html">
        <button
          class="collapsed"
          data-toggle="collapse"
          data-target="#activity-collapse"
          aria-expanded="false"
          aria-controls="activity-collapse"
        >
          <i class="fas fa-chevron-right"></i>
          <i class="fas fa-times"></i>
          <span>Activity</span>
        </button>
      </a>
    </h2>
  </div>

  
</div>

<div class="sidebar-accordion-wrapper">
  <div id="macro">
    <h2 class="mb-0 mt-1 sidebar-accordion-item">
      <a href="/2.1/docs/macro.html">
        <button
          class="collapsed"
          data-toggle="collapse"
          data-target="#macro-collapse"
          aria-expanded="false"
          aria-controls="macro-collapse"
        >
          <i class="fas fa-chevron-right"></i>
          <i class="fas fa-times"></i>
          <span>Macro</span>
        </button>
      </a>
    </h2>
  </div>

  
</div>

<div class="sidebar-accordion-wrapper">
  <div id="operation">
    <h2 class="mb-0 mt-1 sidebar-accordion-item">
      <a href="/2.1/docs/operation.html">
        <button
          class=""
          data-toggle="collapse"
          data-target="#operation-collapse"
          aria-expanded="true"
          aria-controls="operation-collapse"
        >
          <i class="fas fa-chevron-right"></i>
          <i class="fas fa-times"></i>
          <span>Operation</span>
        </button>
      </a>
    </h2>
  </div>

  
    <div
      id="operation-collapse"
      class="collapse show"
      aria-labelledby="operation"
      data-parent="#accordion"
    >
      <ul class="nav vertical menu navbar-light">
        
          <li class="nav-item">
            <a class="nav-link active" href="#operation-overview">
              Overview
            </a>
          </li>
        
          <li class="nav-item">
            <a class="nav-link " href="#operation-macros">
              Macros
            </a>
          </li>
        
          <li class="nav-item">
            <a class="nav-link " href="#operation-nested">
              Nested
            </a>
          </li>
        
          <li class="nav-item">
            <a class="nav-link " href="#operation-policy">
              Policy
            </a>
          </li>
        
          <li class="nav-item">
            <a class="nav-link " href="#operation-contract">
              Contract
            </a>
          </li>
        
          <li class="nav-item">
            <a class="nav-link " href="#operation-options">
              Options
            </a>
          </li>
        
      </ul>
    </div>
  
</div>

<div class="sidebar-accordion-wrapper">
  <div id="workflow">
    <h2 class="mb-0 mt-1 sidebar-accordion-item">
      <a href="/2.1/docs/workflow.html">
        <button
          class="collapsed"
          data-toggle="collapse"
          data-target="#workflow-collapse"
          aria-expanded="false"
          aria-controls="workflow-collapse"
        >
          <i class="fas fa-chevron-right"></i>
          <i class="fas fa-times"></i>
          <span>Workflow</span>
        </button>
      </a>
    </h2>
  </div>

  
</div>

<div class="sidebar-accordion-wrapper">
  <div id="endpoint">
    <h2 class="mb-0 mt-1 sidebar-accordion-item">
      <a href="/2.1/docs/endpoint.html">
        <button
          class="collapsed"
          data-toggle="collapse"
          data-target="#endpoint-collapse"
          aria-expanded="false"
          aria-controls="endpoint-collapse"
        >
          <i class="fas fa-chevron-right"></i>
          <i class="fas fa-times"></i>
          <span>Endpoint</span>
        </button>
      </a>
    </h2>
  </div>

  
</div>

  </div>
</div>

<div class="border-bottom">
  <div class="my-4">
    <div class="sidebar-accordion-wrapper">
  <div id="reform">
    <h2 class="mb-0 mt-1 sidebar-accordion-item">
      <a href="/2.1/docs/reform.html">
        <button
          class="collapsed"
          data-toggle="collapse"
          data-target="#reform-collapse"
          aria-expanded="false"
          aria-controls="reform-collapse"
        >
          <i class="fas fa-chevron-right"></i>
          <i class="fas fa-times"></i>
          <span>Reform</span>
        </button>
      </a>
    </h2>
  </div>

  
</div>

<div class="sidebar-accordion-wrapper">
  <div id="cells">
    <h2 class="mb-0 mt-1 sidebar-accordion-item">
      <a href="/2.1/docs/cells.html">
        <button
          class="collapsed"
          data-toggle="collapse"
          data-target="#cells-collapse"
          aria-expanded="false"
          aria-controls="cells-collapse"
        >
          <i class="fas fa-chevron-right"></i>
          <i class="fas fa-times"></i>
          <span>Cells</span>
        </button>
      </a>
    </h2>
  </div>

  
</div>

<div class="sidebar-accordion-wrapper">
  <div id="representable">
    <h2 class="mb-0 mt-1 sidebar-accordion-item">
      <a href="/2.1/docs/representable.html">
        <button
          class="collapsed"
          data-toggle="collapse"
          data-target="#representable-collapse"
          aria-expanded="false"
          aria-controls="representable-collapse"
        >
          <i class="fas fa-chevron-right"></i>
          <i class="fas fa-times"></i>
          <span>Representable</span>
        </button>
      </a>
    </h2>
  </div>

  
</div>

<div class="sidebar-accordion-wrapper">
  <div id="disposable">
    <h2 class="mb-0 mt-1 sidebar-accordion-item">
      <a href="/2.1/docs/disposable.html">
        <button
          class="collapsed"
          data-toggle="collapse"
          data-target="#disposable-collapse"
          aria-expanded="false"
          aria-controls="disposable-collapse"
        >
          <i class="fas fa-chevron-right"></i>
          <i class="fas fa-times"></i>
          <span>Disposable</span>
        </button>
      </a>
    </h2>
  </div>

  
</div>

<div class="sidebar-accordion-wrapper">
  <div id="roar">
    <h2 class="mb-0 mt-1 sidebar-accordion-item">
      <a href="/2.1/docs/roar.html">
        <button
          class="collapsed"
          data-toggle="collapse"
          data-target="#roar-collapse"
          aria-expanded="false"
          aria-controls="roar-collapse"
        >
          <i class="fas fa-chevron-right"></i>
          <i class="fas fa-times"></i>
          <span>Roar</span>
        </button>
      </a>
    </h2>
  </div>

  
</div>

  </div>
</div>

<div class="border-bottom">
  <div class="my-4">
    <div class="sidebar-accordion-wrapper">
  <div id="tutorials">
    <h2 class="mb-0 mt-1 sidebar-accordion-item">
      <a href="/2.1/docs/tutorials/activity.html">
        <button
          class="collapsed"
          data-toggle="collapse"
          data-target="#tutorials-collapse"
          aria-expanded="false"
          aria-controls="tutorials-collapse"
        >
          <i class="fas fa-chevron-right"></i>
          <i class="fas fa-times"></i>
          <span>Tutorials</span>
        </button>
      </a>
    </h2>
  </div>

  
</div>

<div class="sidebar-accordion-wrapper">
  <div id="pro">
    <h2 class="mb-0 mt-1 sidebar-accordion-item">
      <a href="/2.1/docs/pro.html">
        <button
          class="collapsed"
          data-toggle="collapse"
          data-target="#pro-collapse"
          aria-expanded="false"
          aria-controls="pro-collapse"
        >
          <i class="fas fa-chevron-right"></i>
          <i class="fas fa-times"></i>
          <span>PRO</span>
        </button>
      </a>
    </h2>
  </div>

  
</div>

  </div>
</div>

                </div>
              </div>

              <main
                class="col-md-9 col-xl-8 py-md-5 pl-md-5 order-2"
                role="main"
              >
                <div class="doc-block section-name session-show">
                  <h1 class="w-100">Operation</h1>
                  <ul>
                    <li>
                      <i class="far fa-clock pink"></i>
                      <span>Last updated 01 Nov 22</span>
                    </li>
                  </ul>
                </div>

                <div class="doc-block">
<p><span class="divider"></span></p>

<h2 id="operation-overview">Overview</h2>
<p><!-- {operation-overview-toc} --></p>

<p>Operations have been a central element since Trailblazer 1.0. An operation models a top-level function of your application, such as creating a user or archiving a blog post. It’s the outer-most object that is directly invoked by the controller, embraces all business-specific logic and hides it from the latter.</p>

<p>Operations are often confused as <em>god objects</em> that do “everything”. However, operations are nothing but orchestrators. Where to implement the actual code and when to call it is up to the developer.</p>

<div class="bd-callout bd-callout-info">
<p>Since Trailblazer 2.1, operations are reduced to being a very thin, public API around an <code>Activity</code> with some pre-defined configuration such as the <code>FastTrack</code>-railway.</p>

<p>Deeply nested business logic is implemented using activities. For background-compatibility, you may still use an operation for the upper-most logic, but internally, it boils down to being an <code>Activity::FastTrack</code>.</p>
</div>

<ul>
  <li>Two public <code>Operation.call</code> signatures: “public call” and circuit interface.
*</li>
</ul>

<p><span class="divider"></span></p>

<h3 id="operation-overview-invocation">Invocation</h3>
<p><!-- {operation-overview-invocation-toc} --></p>

<p>An operation has two invocation styles. This is the only difference to an <code>Activity</code>.</p>

<p><span class="divider"></span></p>

<ul class="navigation">
    <li>Invocation</li>
    <li id="operation-overview-invocation-public-call">Public call</li>
</ul>

<p>Until TRB 2.1, the public call was the only way to invoke an operation. Its signature is simpler, but less powerful.</p>

<pre><code>result = Memo::Create.(params: {text: "Enjoy an IPA"})

puts result.success?    #=&gt; true

model = result[:model]
puts model.text         #=&gt; "Enjoy an IPA"
</code></pre>

<p>The public call will return a <a href="/2.1/docs/operation.html#operation-overview-result">result object</a> that exposes the binary state (<code>success?</code> or <code>failure?</code>). All variables written to the context are accessable via the <code>#[]</code> reader.</p>

<p><span class="divider"></span></p>

<ul class="navigation">
    <li>Invocation</li>
    <li id="operation-overview-invocation-circuit-interface">Circuit Interface</li>
</ul>

<p>Since operations are just normal activities under the hood, they also expose the [circuit interface]. This allows using all advanced features such as [taskWrap], [tracing] or nesting operations with the generic activity mechanics.</p>

<pre><code>ctx = {params: {text: "Enjoy an IPA"}}
signal, (ctx, _) = Memo::Create.([ctx, {}], {})

puts signal #=&gt; #&lt;Trailblazer::Activity::Railway::End::Success semantic=:success&gt;
</code></pre>

<p><span class="divider"></span></p>

<h3 id="operation-overview-wiring">Wiring</h3>
<p><!-- {operation-overview-wiring-toc} --></p>

<p>An operation is simply an <code>Activity::FastTrack</code> subclass and all [DSL implications are identical].</p>

<pre><code>class Create &lt; Trailblazer::Operation
  step :validate, fast_track: true
  fail :log_error
  step :create

  # ...
end
</code></pre>

<p>An operation always allows you the fast-track outputs and wiring.</p>

<p><img class="mx-auto d-block" src="/vite-dev/images/ft-fasttrack.webp" /></p>

<p>For DSL options, refer to <a href="/2.1/docs/activity.html#activity-strategy-fasttrack">Fast Track</a>.</p>

<p><span class="divider"></span></p>

<h3 id="operation-overview-result">Result</h3>
<p><!-- {operation-overview-result-toc} --></p>

<p>An operation invoked with public call will return an <code>Operation::Result</code> object for your convenience. It’s nothing but a container exposing the binary state (or outcome) plus the <code>ctx</code> object that was passed around in the circuit.</p>

<pre><code>class Create &lt; Trailblazer::Operation
  step :validate, fast_track: true
  fail :log_error
  step :create

  def create(ctx, **)
    ctx[:model] = Memo.new
  end
  # ...
  # ...
</code></pre>

<p>The result exposes state and the context you wrote to.</p>

<pre><code>result.success? #=&gt; true
result[:model]  #=&gt; #&lt;Memo ..&gt;
</code></pre>

<p>The operation ending on a “failure” end (<code>End.failure</code>, <code>End.fail_fast</code>) will result in <code>result.failure?</code> being true. All other outcomes will be interpreted as success.</p>

<div class="bd-callout bd-callout-info">
<p>Please note that the result object is not compatible with the circuit interface and only here for backward-compatibility, when invoking operations manually.</p>

<p>In compositions or workflows, operations will always be called using the circuit interface.</p>
</div>

<p><span class="divider"></span></p>

<h2 id="operation-macros">Macros</h2>
<p><!-- {operation-macros-toc} --></p>

<p>Macros provide shorthand methods to create and configure a particular step in your operation. Trailblazer ships with a handful of macros. Those are implemented in trailblazer-macro and trailblazer-macro-contract.</p>

<p>Writing you own macros is a very simple thing to do if you follow the macro API. <a href="/2.1/docs/activity.html#activity-macro-api"><i class="fa fa-book" aria-hidden="true"></i> API docs</a></p>

<p><span class="divider"></span></p>

<h3 id="operation-macros-general-notes">General notes</h3>
<p><!-- {operation-macros-general-notes-toc} --></p>

<p><span class="divider"></span></p>

<ul class="navigation">
    <li>General notes</li>
    <li id="operation-macros-general-notes-variable-mapping">Variable mapping</li>
</ul>

<p>Most macros internally use <a href="/2.1/docs/activity.html#activity-variable-mapping">variable mapping</a> to allow injection of configuration variables or to limit their own scope. Macros do so by leveraging the composable API using <code>In()</code>, <code>Inject()</code> and <code>Out()</code>.</p>

<p>This allows you to <em>add your own</em> variable mapping to a macro, as illustrated in the example below.</p>

<pre><code>class Create &lt; Trailblazer::Operation
  step Model(Song, :find_by),
    In() =&gt; -&gt;(ctx, my_id:, **) { ctx.merge(params: {id: my_id}) } # Model() needs {params[:id]}.
  # ...
end
</code></pre>

<p>When running the above operation, the exemplary <code>Model()</code> macro will pick the ID from <code>:my_id</code>.</p>

<pre><code>result = Create.(my_id: 1)
</code></pre>

<p>Please note that you shall <strong>not use <code>:input</code></strong> to configure your macro as it will override internal filters and breaks the macro’s configuration. Go with the new <a href="/2.1/docs/activity.html#activity-variable-mapping-composable-i-o">composable variable mapping</a> which is available from <code>trailblazer</code> 2.1.1 and onwards.</p>

<p><span class="divider"></span></p>

<h3 id="operation-macros-model">Model</h3>
<p><!-- {operation-macros-model-toc} --></p>

<p>An operation can automatically find or create a model for you depending on the input, with the <code>Model</code> macro.</p>

<pre><code>class Create &lt; Trailblazer::Operation
  step Model(Song, :new)
  # ..
end
</code></pre>

<p>After this step, there is a fresh model instance under <code>ctx[:model]</code> that can be used in all following steps and the returned <code>result</code> object.</p>

<pre><code>result = Create.(params: {})
result[:model] #=&gt; #&lt;struct Song id=nil, title=nil&gt;
</code></pre>

<p>Internally, <code>Model</code> macro will simply invoke <code>Song.new</code> to populate <code>ctx[:model]</code>.</p>

<p><span class="divider"></span></p>

<ul class="navigation">
    <li>Model</li>
    <li id="operation-macros-model-find_by">Find_by</li>
</ul>

<p>You can also find models using <code>:find_by</code>. This is helpful for <code>Update</code> or <code>Delete</code> operations.</p>

<pre><code>class Update &lt; Trailblazer::Operation
  step Model( Song, :find_by )
  # ..
end
</code></pre>

<p>The <code>Model</code> macro will invoke the following code for you.</p>

<pre><code>ctx[:model] = Song.find_by( id: params[:id] )
</code></pre>

<p>This will assign <code>[:model]</code> for you by invoking <code>find_by</code>.</p>

<pre><code>result = Update.(params: { id: 1 })
result[:model] #=&gt; #&lt;struct Song id=1, title="nil"&gt;
</code></pre>

<p>If <code>Song.find_by</code> returns <code>nil</code>, this will deviate to the left track, skipping the rest of the operation.</p>

<pre><code>result = Update.(params: {})
result[:model] #=&gt; nil
result.success? #=&gt; false
</code></pre>

<p>It is also possible to <code>find_by</code> with attribute other than <code>id</code>. For example,</p>

<pre><code>class UpdateWithFindByKey &lt; Trailblazer::Operation
  step Model( Song, :find_by, :title )
  # ..
end
</code></pre>

<p>Note that you may also use <code>:find</code>. This is not recommended, though, since it raises an exception, which is not the preferred way of flow control in Trailblazer.</p>

<p><span class="divider"></span></p>

<ul class="navigation">
    <li>Model</li>
    <li id="operation-macros-model-arbitrary-finder">Arbitrary Finder</li>
</ul>

<p>It’s possible to specify any finder method, which is helpful with ROMs such as Sequel.</p>

<pre><code>class Show &lt; Trailblazer::Operation
  step Model( Song, :[] )
  # ..
end
</code></pre>

<p>The provided method will be invoked and Trailblazer passes it the <code>params[:id]</code> value.</p>

<pre><code>Song[ params[:id] ]
</code></pre>

<p>Given your database gem provides that finder, it will result in a successful query.</p>

<pre><code>result = Show.(params: { id: 1 })
result[:model] #=&gt; #&lt;struct Song id=1, title="Roxanne"&gt;
</code></pre>

<p><span class="divider"></span></p>

<ul class="navigation">
    <li>Model</li>
    <li id="operation-macros-model-not-found">Not Found</li>
</ul>

<p>With the help of <a href="/2.1/docs/endpoint.html">endpoint</a>, it is possible to connect failure of this step to render <strong>404 response</strong> directly.
As a result, you don’t need to conditionally check if <code>ctx[:model]</code> is present or not.</p>

<p><img class="mx-auto d-block" src="/vite-dev/images/macro-ends.webp" /></p>

<p>To emit <code>End.not_found</code> signal, you need to pass <code>not_found_terminus</code> kwarg.</p>

<pre><code>class UpdateFailureWithModelNotFound &lt; Trailblazer::Operation
  step Model( Song, :find_by, not_found_terminus: true )
  # ..
end
</code></pre>

<p>Internally, it is just telling <a href="/2.1/docs/activity.html#activity-wiring-api-output-implicit-signal"><code>Output(:failure)</code></a> to emit <a href="/2.1/docs/activity.html#activity-wiring-api-end-"><code>End(:not_found)</code></a></p>

<pre><code>result = UpdateFailureWithModelNotFound.(params: {title: nil})
result[:model] #=&gt; nil
result.success? #=&gt; false
result.event #=&gt; #&lt;Trailblazer::Activity::End semantic=:not_found&gt;
</code></pre>

<p><span class="divider"></span></p>

<ul class="navigation">
    <li>Model</li>
    <li id="operation-macros-model-dependency-injection">Dependency Injection</li>
</ul>

<p>The following <code>Model()</code> options can be injected using variables when <code>call</code>ing the operation.</p>

<ul>
  <li><code>:"model.class"</code> which represents the first argument for <code>Model()</code>.</li>
  <li><code>:"model.action"</code> representing the second argument.</li>
  <li><code>:"model.find_by_key"</code> which represents the third argument.</li>
</ul>

<p>As per your design, you may inject one or more of those variables as follows.</p>

<pre><code>result = Create.(
  params:               {title: "Olympia"}, # some random variable.
  "model.class":        Hit,
  "model.action":       :find_by,
  "model.find_by_key": :title
)
</code></pre>

<p>You can even leave <code>Model()</code> entirely unconfigured.</p>

<pre><code>class Create &lt; Trailblazer::Operation
  step Model()
  # ..
end
</code></pre>

<p>This implies you inject all required variables at run-time.</p>

<p><span class="divider"></span></p>

<ul class="navigation">
    <li>Model</li>
    <li id="operation-macros-model-dependency-injection-model-class">Dependency Injection / Model class</li>
</ul>

<p>Usually, the specific model class for <code>Model()</code> is set directly in the macro.</p>

<pre><code>class Create &lt; Trailblazer::Operation
  step Model(Song, :new)
  # ..
end
</code></pre>

<p>Nevertheless, it’s possible to override it using the <code>:"model.class"</code> variable when invoking the operation/activity.</p>

<pre><code>result = Create.(params: {}, :"model.class" =&gt; Hit)
</code></pre>

<p>Note that you <a href="">don’t have  to configure</a> any model class at all when injecting it.</p>

<p><span class="divider"></span></p>

<h3 id="operation-macros-nested">Nested</h3>
<p><!-- {operation-macros-nested-toc} --></p>

<p>The <code>Nested</code> macro works identical to <code>Subprocess</code> when you pass an activity.</p>

<pre><code>class Create &lt; Trailblazer::Operation
  step :create
  step Nested(Validate)
  step :save
  # ...
end
</code></pre>

<p>It will print a deprecation and use <code>Subprocess</code> internally, automatically wiring the nested’s outputs (<code>Validate</code>) to the known outer tracks.</p>

<p>Anyhow, <code>Nested</code> allows for dynamically deciding the nested activity at run-time using an <code>:instance_method</code>, or any callable object.</p>

<pre><code>class Create &lt; Trailblazer::Operation
  step :create
  step Nested(:compute_nested)
  step :save

  def compute_nested(ctx, params:, **)
    params.is_a?(Hash) ? Validate : JsonValidate
  end
  # ...
end
  end

  it "Nested(:method)" do
</code></pre>

<p>The dynamic nested decider method or callable has a task interface and must return the activity to nest. <code>Nested</code> will automatically connect the <code>failure</code> and the <code>success</code> end only.</p>

<p><span class="divider"></span></p>

<ul class="navigation">
    <li>Nested</li>
    <li id="operation-macros-nested-auto-wire">Auto-wire</li>
</ul>

<p>In order to connect all the ends of dynamically selected activity, you need to provide the list of all possible activities using <code>:auto_wire</code> option. You may use the wiring DSL with <code>Output</code> and friends to connect outputs from the nested activity.</p>

<pre><code>class Create &lt; Trailblazer::Operation
  step :create
  step Nested(:compute_nested, auto_wire: [Validate, JsonValidate]),
    Output(:invalid_json) =&gt; End(:jsoned)

  # ...
end
</code></pre>

<p><span class="divider"></span></p>

<h2 id="operation-nested">Nested</h2>
<p><!-- {operation-nested-toc} --></p>

<p><span class="divider"></span></p>

<h3 id="operation-nested-dynamic">Dynamic</h3>
<p><!-- {operation-nested-dynamic-toc} --></p>

<p>compiled at runtime</p>

<p><span class="divider"></span></p>

<h3 id="operation-nested-auto_wire">Auto_wire</h3>
<p><!-- {operation-nested-auto_wire-toc} --></p>

<p>The recommended way of maintaining dynamically nested operations (or activities) is to use <code>Nested()</code> with the <code>:auto_wire</code> option. It works exactly like its <a href="#macro-nested-dynamic">purely dynamic</a> counterpart but requires you to specify all possible nested activities <strong>at compile-time</strong>.</p>

<pre><code>module Song::Activity
  class Create &lt; Trailblazer::Activity::Railway
    step :model
    step Nested(:decide_file_type,
      auto_wire: [Id3Tag, VorbisComment]) # explicitely define possible nested activities.
    step :save
    # ...

    def decide_file_type(ctx, params:, **)
      params[:type] == "mp3" ? Id3Tag : VorbisComment
    end
  end
end
</code></pre>

<p>The <code>:auto_wire</code> option expects an array of nested activities. While this might seem a bit clumsy, this brings several benefits. First of all, execution is much faster since the entire activity graph is created at compile-time. Second, you can use the Debugging API to <a href="#macro-nested-auto_wire-debugging">introspect things</a>.</p>

<p>You can use any type of decider step. In this example, it’s a instance method <code>#decide_file_type</code> on the <code>Nested()</code>-hosting class.</p>

<p><img class="mx-auto d-block" src="/vite-dev/images/nested-static-create.png" /></p>

<p>Internally, the “auto-wire” <code>Nested()</code> macro simply returns a small activity as illustrated above in gray. It has a <code>decide</code> step to figure out which nested activity to run, then runs the actual nested activity. All well-known termini (success, failure, pass_fast, fail_fast) of the nested activities are automatically connected to the <code>Nested()</code>’s activity’s termini.</p>

<p><span class="divider"></span></p>

<ul class="navigation">
    <li>Auto_wire</li>
    <li id="operation-nested-auto_wire-output-wiring">Output Wiring</li>
</ul>

<p>Given we had a nested activity <code>VorbisComment</code> implemented like so.</p>

<pre><code>module Song::Activity
  class VorbisComment &lt; Trailblazer::Activity::Railway
    step :prepare_metadata
    step :encode_cover, Output(:failure) =&gt; End(:unsupported_file_format)
    # ...
  end
end
</code></pre>

<p>If the <code>#encode_cover</code> step fails, the activity will stop in the <code>End.unsupported_file_format</code> terminus - an end event very specific to the <code>VorbisComment</code> activity.</p>

<p><img class="mx-auto d-block" src="/vite-dev/images/nested-static-vorbiscomment.png" /></p>

<p>This new terminus has to be wired explicitely in the nesting activity.</p>

<pre><code>module Song::Activity
  class Create &lt; Trailblazer::Activity::Railway
    step :model
    step Nested(
        :decide_file_type,
        auto_wire: [Id3Tag, VorbisComment]
      ),
      # Output and friends are used *after* Nested().
      # Connect VorbisComment's {unsupported_file_format} to our {failure} track:
      Output(:unsupported_file_format) =&gt; Track(:failure)

    step :save
    # ...
  end
end
</code></pre>

<p>Using <code>Output(:unsupported_file_type)</code> from the Wiring API you can connect this specific terminus to wherever you need it, here it’s routed to the failure track in <code>Create</code>. Note that Wiring API options are used after <code>Nested(...)</code>, not within its parenthesis.</p>

<p>The complete activity graph would look a bit like the following diagram.</p>

<p><img class="mx-auto d-block" src="/vite-dev/images/nested-static-complete.png" /></p>

<p><span class="divider"></span></p>

<ul class="navigation">
    <li>Auto_wire</li>
    <li id="operation-nested-auto_wire-debugging">Debugging</li>
</ul>

<p>Static <code>Nested</code> setups are traceable using <code>#wtf?</code>. The above examples result in a flow as follows.</p>

<pre><code>Song::Activity::Create
|-- Start.default
|-- model
|-- Nested(decide_file_type)
|   |-- Start.default
|   |-- decide
|   |   |-- Start.default
|   |   |-- #&lt;Trailblazer::Activity::TaskBuilder::Task user_proc=decide_file_type&gt;
|   |   |-- dispatch_to_terminus
|   |   `-- End.decision:DocsNestedStaticTest::A::Song::Activity::VorbisComment
|   |-- DocsNestedStaticTest::A::Song::Activity::VorbisComment
|   |   |-- Start.default
|   |   |-- prepare_metadata
|   |   |-- encode_cover
|   |   `-- End.success
|   `-- End.success
|-- save
`-- End.success
</code></pre>

<p>The trace is fully compatible with the Debugging API and allows compile-time introspection. For example, you can specify the path to a nested activity <code>Id3Tag</code> and inspect it.</p>

<pre><code>Trailblazer::Developer.render(Song::Activity::Create,
  path: [
    "Nested(decide_file_type)", # ID of Nested()
    Song::Activity::Id3Tag      # ID of the nested {Id3Tag} activity.
  ]
)
</code></pre>

<p>Note that the ID of the nested activities are the class constants.</p>

<p><span class="divider"></span></p>

<h3 id="operation-nested-wrap">Wrap</h3>
<p><!-- {operation-nested-wrap-toc} --></p>

<p>Steps can be wrapped by an embracing step. This is necessary when defining a set of steps to be contained in a database transaction or a database lock.</p>

<pre><code>class Memo::Create &lt; Trailblazer::Operation
  step :find_model
  step Wrap( MyTransaction ) {
    step :update
    step :rehash
  }
  step :notify
  fail :log_error
  # ...
end
</code></pre>

<p>The <code>Wrap</code> macro helps you to define the wrapping code (such as a <code>Sequel.transaction</code> call) and allows you to define the wrapped steps. (Because of the precedence works in Ruby, you need to use <code>{...}</code> instead of <code>do...end</code>.)</p>

<pre><code>class HandleUnsafeProcess
  def self.call((_ctx, _flow_options), *, &amp;block)
    signal, (ctx, flow_options) = yield
    evaluated_signal = if signal.to_h[:semantic] == :success
                        Trailblazer::Operation::Railway.pass_fast!
                      else
                        Trailblazer::Operation::Railway.fail!
                      end
    [ evaluated_signal, [ctx, flow_options] ]
  end
end
</code></pre>

<p>As always, you can have steps before and after <code>Wrap</code> in the pipe.</p>

<p>The proc passed to <code>Wrap</code> will be called when the step is executed, and receives <code>block</code>. <code>block.call</code> will execute the nested pipe.</p>

<p>You may have any amount of <code>Wrap</code> nesting.</p>

<p><span class="divider"></span></p>

<ul class="navigation">
    <li>Wrap</li>
    <li id="operation-nested-wrap-callable">Callable</li>
</ul>

<p>For reusable wrappers, you can also use a <code>Callable</code> object.</p>

<pre><code>class MyTransaction
  def self.call((ctx, flow_options), *, &amp;block)
    Sequel.transaction { yield } # calls the wrapped steps
  rescue
    [ Trailblazer::Operation::Railway.fail!, [ctx, flow_options] ]
  end
end
</code></pre>

<p>This can then be passed to <code>Wrap</code>, making the flow extremely readable.</p>

<p><span class="divider"></span></p>

<ul class="navigation">
    <li>Wrap</li>
    <li id="operation-nested-wrap-return-value">Return Value</li>
</ul>

<p>All nested steps will simply be executed as if they were on the “top-level” track, but within the wrapper code. Steps may deviate to the left track, and so on.</p>

<p>However, the last signal of the wrapped pipe is not simply passed on to the “outer” pipe. The return value of the actual <code>Wrap</code> block is crucial: If it returns falsey, the pipe will deviate to left after <code>Wrap</code>.</p>

<pre><code>step Wrap -&gt;(*, &amp;block) { Sequel.transaction do block.call end; false } {
</code></pre>

<p>In the above example, regardless of <code>Sequel.transaction</code>’s return value, the outer pipe will deviate to the left track as the <code>Wrap</code>’s return value is always <code>false</code>.</p>

<p>TODO: document how you can wire</p>

<p><span class="divider"></span></p>

<h3 id="operation-nested-rescue">Rescue</h3>
<p><!-- {operation-nested-rescue-toc} --></p>

<p>While you can write your own <code>begin/rescue/end</code> mechanics using <a href="#wrap"><code>Wrap</code></a>, Trailblazer offers you the <code>Rescue</code> macro to catch and handle exceptions that might occur while running the pipe.</p>

<pre><code>class Memo::Create &lt; Trailblazer::Operation
  step :find_model
  step Rescue( RuntimeError, handler: MyHandler ) {
    step :update
    step :rehash
  }
  step :notify
  fail :log_error
  # ...
end
</code></pre>

<p>Any exception raised during a step in the <code>Rescue</code> block will stop the nested pipe from being executed, and continue after the block on the left track.</p>

<p>You can specify what exceptions to catch and an optional handler that is called when an exception is encountered.</p>

<pre><code>class MyHandler
  def self.call(exception, (ctx), *)
    ctx[:exception_class] = exception.class
  end
end
</code></pre>

<p>Alternatively, you can use a  <code>Callable</code> object for <code>:handler</code>.</p>

<p><span class="divider"></span></p>

<ul class="navigation">
    <li>Rescue</li>
    <li id="operation-nested-rescue-full-example">Full example</li>
</ul>

<p>The  <code>Nested</code>, <code>Wrap</code> and <code>Rescue</code> macros can also be nested, allowing an easily extendable business workflow with error handling along the way.</p>

<p>TODO: add example</p>

<p><span class="divider"></span></p>

<h2 id="operation-policy">Policy</h2>
<p><!-- {operation-policy-toc} --></p>

<p>The <code>Policy</code> macros <a href="#pundit"><code>Policy::Pundit</code></a>, and <a href="#guard"><code>Policy::Guard</code></a> help to implement permission decider steps.</p>

<p><span class="divider"></span></p>

<h3 id="operation-policy-pundit">Pundit</h3>
<p><!-- {operation-policy-pundit-toc} --></p>

<p>The <code>Policy::Pundit</code> module allows using <a href="https://github.com/elabs/pundit">Pundit</a>-compatible policy classes in an operation.</p>

<p>A Pundit policy has various rule methods and a special constructor that receives the current user and the current model.</p>

<pre><code>class MyPolicy
  def initialize(user, model)
    @user, @model = user, model
  end

  def create?
    @user == Module &amp;&amp; @model.id.nil?
  end

  def new?
    @user == Class
  end
end
</code></pre>

<p>In pundit policies, it is a convention to have access to those objects at runtime and build rules on top of those.</p>

<p>You can plug this policy into your pipe at any point. However, this must be inserted after the <code>"model"</code> skill is available.</p>

<pre><code>class Create &lt; Trailblazer::Operation
  step Model( Song, :new )
  step Policy::Pundit( MyPolicy, :create? )
  # ...
end
</code></pre>

<p>Note that you don’t have to create the model via the <code>Model</code> macro - you can use any logic you want. The <code>Pundit</code> macro will grab the model from <code>["model"]</code>, though.</p>

<p>This policy will only pass when the operation is invoked as follows.</p>

<pre><code>Create.(current_user: User.find(1))
</code></pre>

<p>Any other call will cause a policy breach and stop the pipe from executing after the <code>Policy::Pundit</code> step.</p>

<p><span class="divider"></span></p>

<ul class="navigation">
    <li>Pundit</li>
    <li id="operation-policy-pundit-api">API</li>
</ul>

<p>Add your polices using the <code>Policy::Pundit</code> macro. It accepts the policy class name, and the rule method to call.</p>

<pre><code>class Create &lt; Trailblazer::Operation
  step Model( Song, :new )
  step Policy::Pundit( MyPolicy, :create? )
  # ...
end
</code></pre>

<p>The step will create the policy instance automatically for you and passes the <code>"model"</code> and the <code>"current_user"</code> skill into the policies constructor. Just make sure those dependencies are available before the step is executed.</p>

<p>If the policy returns <code>falsey</code>, it <a href="api.html#flow-control-step">deviates to the left track</a>.</p>

<p>After running the <code>Pundit</code> step, its result is readable from the <code>Result</code> object.</p>

<pre><code>result = Create.(params: {}, current_user: Module)
result[:"result.policy.default"].success? #=&gt; true
result[:"result.policy.default"][:policy] #=&gt; #&lt;MyPolicy ...&gt;
</code></pre>

<p>Note that the actual policy instance is available via <code>["result.policy.#{name}"]["policy"]</code> to be reinvoked with other rules (e.g. in the view layer).</p>

<p><span class="divider"></span></p>

<ul class="navigation">
    <li>Pundit</li>
    <li id="operation-policy-pundit-name">Name</li>
</ul>

<p>You can add any number of Pundit policies to your pipe. Make sure to use <code>name:</code> to name them, though.</p>

<pre><code>class Create &lt; Trailblazer::Operation
  step Model( Song, :new )
  step Policy::Pundit( MyPolicy, :create?, name: "after_model" )
  # ...
end
</code></pre>

<p>The result will be stored in <code>"result.policy.#{name}"</code></p>

<pre><code>result = Create.(params: {}, current_user: Module)
result[:"result.policy.after_model"].success? #=&gt; true
</code></pre>

<p><span class="divider"></span></p>

<ul class="navigation">
    <li>Pundit</li>
    <li id="operation-policy-pundit-dependency-injection">Dependency Injection</li>
</ul>

<p>Override a configured policy using dependency injection.</p>

<pre><code>Create.(params: {},
  current_user:            Module,
  :"policy.default.eval" =&gt; Trailblazer::Operation::Policy::Pundit.build(AnotherPolicy, :create?)
)
</code></pre>

<p>You can inject it using <code>"policy.#{name}.eval"</code>. It can be any object responding to <code>call</code>.</p>

<p><span class="divider"></span></p>

<h3 id="operation-policy-guard">Guard</h3>
<p><!-- {operation-policy-guard-toc} --></p>

<p>A guard is a step that helps you evaluating a condition and writing the result. If the condition was evaluated as <code>falsey</code>, the pipe won’t be further processed and a policy breach is reported in <code>Result["result.policy.default"]</code>.</p>

<pre><code>class Create &lt; Trailblazer::Operation
  step Policy::Guard(-&gt;(options, pass:, **) { pass })
  step :process

  def process(options, **)
    options[:x] = true
  end
end
</code></pre>

<p>The only way to make the above operation invoke the second step <code>:process</code> is as follows.</p>

<pre><code>result = Create.({ pass: true })
result["x"] #=&gt; true
</code></pre>

<p>Any other input will result in an abortion of the pipe after the guard.</p>

<pre><code>result = Create.()
result["x"] #=&gt; nil
result["result.policy.default"].success? #=&gt; false
</code></pre>

<p>Learn more about <a href="skill.md">→ dependency injection</a> to pass params and current user into the operation. TODO: fix link</p>

<p><span class="divider"></span></p>

<ul class="navigation">
    <li>Guard</li>
    <li id="operation-policy-guard-api">API</li>
</ul>

<p>The <code>Policy::Guard</code> macro helps you inserting your guard logic. If not defined, it will be evaluated <a href="#guard-position">where you insert</a> it.</p>

<pre><code>step :process

def process(options, **)
  options[:x] = true
end
</code></pre>

<p>The <code>options</code> object is passed into the guard and allows you to read and inspect data like <code>params</code> or <code>current_user</code>. Please use kw args.</p>

<p><span class="divider"></span></p>

<ul class="navigation">
    <li>Guard</li>
    <li id="operation-policy-guard-callable">Callable</li>
</ul>

<p>As always, the guard can also be a <code>Callable</code>-marked object.</p>

<pre><code>class MyGuard
  def call(options, pass:, **)
    pass
  end
end
</code></pre>

<p>Insert the object instance via the <code>Policy::Guard</code> macro.</p>

<pre><code>class Create &lt; Trailblazer::Operation
  step Policy::Guard( MyGuard.new )
  step :process

  # ...
end
</code></pre>

<p><span class="divider"></span></p>

<ul class="navigation">
    <li>Guard</li>
    <li id="operation-policy-guard-instance-method">Instance Method</li>
</ul>

<p>As always, you may also use an instance method to implement a guard.</p>

<pre><code>class Create &lt; Trailblazer::Operation
  step Policy::Guard( :pass? )

  def pass?(options, pass:, **)
    pass
  end
  step :process
  # ...
end
</code></pre>

<p><span class="divider"></span></p>

<ul class="navigation">
    <li>Guard</li>
    <li id="operation-policy-guard-name">Name</li>
</ul>

<p>The guard name defaults to <code>default</code> and can be set via <code>name:</code>. This allows having multiple guards.</p>

<pre><code>class Create &lt; Trailblazer::Operation
  step Policy::Guard( -&gt;(options, current_user:, **) { current_user }, name: :user )
  # ...
end
</code></pre>

<p>The result will sit in <code>result.policy.#{name}</code>.</p>

<pre><code>result = Create.(:current_user =&gt; true)
result[:"result.policy.user"].success? #=&gt; true
</code></pre>

<p><span class="divider"></span></p>

<ul class="navigation">
    <li>Guard</li>
    <li id="operation-policy-guard-dependency-injection">Dependency Injection</li>
</ul>

<p>Instead of using the configured guard, you can inject any callable object that returns a <code>Result</code> object. Do so by overriding the <code>policy.#{name}.eval</code> path when calling the operation.</p>

<pre><code>Create.(
  :current_user           =&gt; Module,
  :"policy.default.eval"  =&gt; Trailblazer::Operation::Policy::Guard.build(-&gt;(options, **) { false })
)
</code></pre>

<p>An easy way to let Trailblazer build a compatible object for you is using <code>Guard.build</code>.</p>

<p>This is helpful to override a certain policy for testing, or to invoke it with special rights, e.g. for an admin.</p>

<p><span class="divider"></span></p>

<ul class="navigation">
    <li>Guard</li>
    <li id="operation-policy-guard-position">Position</li>
</ul>

<p>You may specify a position.</p>

<pre><code>class Create &lt; Trailblazer::Operation
  step :model!
  step Policy::Guard( :authorize! ),
    before: :model!
end
</code></pre>

<p>Resulting in the guard inserted before <code>model!</code>, even though it was added at a later point.</p>

<pre><code>  Trailblazer::Developer.railway(Create, style: :rows) #=&gt;
   # 0 ========================&gt;operation.new
   # 1 ==================&gt;policy.default.eval
   # 2 ===============================&gt;model!
</code></pre>

<p>This is helpful if you maintain modules for operations with generic steps.</p>

<p><span class="divider"></span></p>

<h2 id="operation-contract">Contract</h2>
<p><!-- {operation-contract-toc} --></p>

<p>A <em>contract</em> is an abstraction to handle validation of arbitrary data or object state. It is a fully self-contained object that is orchestrated by the operation.</p>

<p>The actual validation can be implemented using Reform with <code>ActiveModel::Validation</code> or dry-validation, or a <a href="/2.1/docs/operation.html#operation-contract-dry-schema"><code>Dry::Schema</code> directly</a> without Reform.</p>

<p>The <code>Contract</code> macros helps you defining contracts and assists with instantiating and validating data with those contracts at runtime.</p>

<p><span class="divider"></span></p>

<h3 id="operation-contract-overview-reform">overview: reform</h3>
<p><!-- {operation-contract-overview-reform-toc} --></p>

<p>Most contracts are <a href="/2.1/docs/reform.html">Reform</a> objects that you can define and validate in the operation. Reform is a fantastic tool for deserializing and validating deeply nested hashes, and then, when valid, writing those to the database using your persistence layer such as ActiveRecord.</p>

<pre><code># app/concepts/song/contract/create.rb
module Song::Contract
  class Create &lt; Reform::Form
    property :title
    property :length

    validates :title,  length: 2..33
    validates :length, numericality: true
  end
end
</code></pre>

<p>The contract then gets hooked into the operation.</p>

<pre><code>class Song::Create &lt; Trailblazer::Operation
  step Model( Song, :new )
  step Contract::Build( constant: Song::Contract::Create )
  step Contract::Validate()
  step Contract::Persist()
end
</code></pre>

<p>As you can see, using contracts consists of five steps.</p>

<ol>
  <li>Define the contract class (or multiple of them) for the operation.</li>
  <li>Plug the contract creation into the operation’s pipe using <code>Contract::Build</code>.</li>
  <li>Run the contract’s validation for the params using <code>Contract::Validate</code>.</li>
  <li>If successful, write the sane data to the model(s). This will usually happen in the <code>Contract::Persist</code> macro.</li>
  <li>After the operation has been run, <a href="/2.1/docs/operation.html#operation-overview-result">interpret the result</a>. For instance, a controller calling an operation will render a erroring form for invalid input.</li>
</ol>

<div class="bd-callout bd-callout-info">
<p>You don’t have to use any of the TRB macros to deal with contracts, and do everything yourself. They are an abstraction that will save code and bugs, and introduce strong conventions. However, feel free to use your own code.</p>
</div>

<p>Here’s what the result would look like after running the <code>Create</code> operation with invalid data.</p>

<pre><code>result = Song::Create.(params: { title: "A" })
result.success? #=&gt; false
result[:"contract.default"].errors.messages
#=&gt; {:title=&gt;["is too short (minimum is 2 characters)"], :length=&gt;["is not a number"]}
</code></pre>

<p><span class="divider"></span></p>

<h3 id="operation-contract-definition">Definition</h3>
<p><!-- {operation-contract-definition-toc} --></p>

<p>Trailblazer offers a few different ways to define contract classes and use them in an operation.</p>

<p><span class="divider"></span></p>

<ul class="navigation">
    <li>Definition</li>
    <li id="operation-contract-definition-explicit">Explicit</li>
</ul>

<p>The preferred way of defining contracts is to use a separate file and class, such as the example below.</p>

<pre><code># app/concepts/song/contract/create.rb
module Song::Contract
  class Create &lt; Reform::Form
    property :title
    property :length

    validates :title,  length: 2..33
    validates :length, numericality: true
  end
end
</code></pre>

<p>This is called <em>explicit contract</em>.</p>

<p>The contract file could be located just anywhere, but it’s clever to follow the Trailblazer conventions.</p>

<p>Using the contract happens via <code>Contract::Build</code>, and the <code>:constant</code> option.</p>

<pre><code>class Song::Create &lt; Trailblazer::Operation
  step Model( Song, :new )
  step Contract::Build( constant: Song::Contract::Create )
  step Contract::Validate()
  step Contract::Persist()
end
</code></pre>

<p>Since both operations and contracts grow during development, the completely encapsulated approach of the explicit contract is what we recommend.</p>

<p><span class="divider"></span></p>

<ul class="navigation">
    <li>Definition</li>
    <li id="operation-contract-definition-inline">Inline</li>
</ul>

<p>Contracts can also be defined in the operation itself.</p>

<pre><code># app/concepts/song/create.rb
class Create &lt; Trailblazer::Operation
  class MyContract &lt; Reform::Form
    property :title
    property :length

    validates :title,  presence: true
    validates :length, numericality: true
  end

  step Model( Song, :new )
  step Contract::Build(constant: MyContract)
  step Contract::Validate()
  step Contract::Persist( method: :sync )
end
</code></pre>

<p>Defining the contract happens via the <code>contract</code> block. This is called an <em>inline contract</em>. Note that you need to extend the class with the <code>Contract::DSL</code> module. You don’t have to specify anything in the <code>Build</code> macro.</p>

<p>While this is nice for a quick example, this usually ends up quite convoluted and we advise you to use the <a href="/2.1/docs/operation.html#operation-contract-definition-explicit">explicit style</a>.</p>

<p><span class="divider"></span></p>

<h3 id="operation-contract-build">Build</h3>
<p><!-- {operation-contract-build-toc} --></p>

<p>The <code>Contract::Build</code> macro helps you to instantiate the contract.
It is both helpful for a complete workflow, or to create the contract, only, without validating it, e.g. when presenting the form.</p>

<pre><code>class Song::New &lt; Trailblazer::Operation
  step Model( Song, :new )
  step Contract::Build( constant: Song::Contract::Create )
end
</code></pre>

<p>This macro will grab the model from <code>options["model"]</code> and pass it into the contract’s constructor. The contract is then saved in <code>options["contract.default"]</code>.</p>

<pre><code>result = Song::New.(params: {})
result["model"] #=&gt; #&lt;struct Song title=nil, length=nil&gt;
result["contract.default"]
#=&gt; #&lt;Song::Contract::Create model=#&lt;struct Song title=nil, length=nil&gt;&gt;
</code></pre>

<p>The <code>Build</code> macro accepts <a href="/2.1/docs/operation.html#operation-contract-name">the <code>:name</code> option</a> to change the name from <code>default</code>.</p>

<p><span class="divider"></span></p>

<ul class="navigation">
    <li>Build</li>
    <li id="operation-contract-build-dependency-injection-contract-class">Dependency Injection / Contract class</li>
</ul>

<p>Instead of defining  the contract class in the <code>Build()</code> macro the very option can be injected at run-time, when <code>call</code>ing the operation. The operation <em>class</em> doesn’t need any hard-wired reference to a contract class at all.</p>

<pre><code>class Song::Create &lt; Trailblazer::Operation
  step Model(Song, :new)
  step Contract::Build() # no constant provided here!
  step Contract::Validate()
  step Contract::Persist(method: :sync)
end
</code></pre>

<p>A prerequisite for that is that the contract class is defined somewhere.</p>

<pre><code>class MyContract &lt; Reform::Form
  property :title
  validates :title, length: 2..33
end
</code></pre>

<p>When invoking the operation, you now have to provide the default contract class as a variable (or dependency) using the <code>:"contract.default.class"</code> option. The <code>Build()</code> step will use the passed class constant for instantiating the contract.</p>

<pre><code>Song::Create.(
  params:                   { title: "Anthony's Song" },
  "contract.default.class": MyContract # dependency injection!
)
</code></pre>

<p>This will work with any contract name if you follow <a href="/2.1/docs/operation.html#operation-contract-name">the naming conventions</a>.</p>

<p><span class="divider"></span></p>

<h3 id="operation-contract-validate">Validate</h3>
<p><!-- {operation-contract-validate-toc} --></p>

<p>The <code>Contract::Validate</code> macro is responsible for validating the incoming params against its contract. That means you have to use <code>Contract::Build</code> beforehand, or create the contract yourself. The macro will then grab the params and throw then into the contract’s <code>validate</code> (or <code>call</code>) method.</p>

<pre><code>class Song::ValidateOnly &lt; Trailblazer::Operation
  step Model( Song, :new )
  step Contract::Build( constant: Song::Contract::Create )
  step Contract::Validate()
end
</code></pre>

<p>Depending on the outcome of the validation, it either stays on the right track, or deviates to left, skipping the remaining steps.</p>

<pre><code>result = Song::ValidateOnly.(params: {}) # empty params
result.success? #=&gt; false
</code></pre>

<p>Note that <code>Validate</code> really only validates the contract, nothing is written to the model, yet. You need to push data to the model manually, e.g. <a href="/2.1/docs/operation.html#operation-contract-persist">with <code>Contract::Persist</code></a>.</p>

<pre><code>result = Song::ValidateOnly.(params: { title: "Rising Force", length: 13 })

result.success? #=&gt; true
result[:model] #=&gt; #&lt;struct Song title=nil, length=nil&gt;
result[:"contract.default"].title #=&gt; "Rising Force"
</code></pre>

<p><code>Validate</code> will use <code>options["params"]</code> as the input. You can change the nesting with <a href="/2.1/docs/operation.html#operation-contract-key">the <code>:key</code> option</a>.</p>

<div class="bd-callout bd-callout-info">
<p>Internally, this macro will simply call <code>Form#validate</code> on the Reform object.</p>

<p>Note that Reform comes with sophisticated deserialization semantics for nested forms, it might be worth reading <a href="/2.1/docs/reform.html">a bit about Reform</a> to fully understand what you can do in the <code>Validate</code> step.</p>
</div>

<p><span class="divider"></span></p>

<ul class="navigation">
    <li>Validate</li>
    <li id="operation-contract-validate-key">Key</li>
</ul>

<p>Per default, <code>Contract::Validate</code> will use <code>ctx[:params]</code> as the data to be validated. Use the <code>:key</code> option if you want to validate a nested hash from the original params structure.</p>

<pre><code>class Song::Create &lt; Trailblazer::Operation
  step Model( Song, :new )
  step Contract::Build( constant: Song::Contract::Create )
  step Contract::Validate( key: "song" )
  step Contract::Persist( )
end
</code></pre>

<p>This automatically extracts the nested <code>"song"</code> hash.</p>

<pre><code>result = Song::Create.(params: { "song" =&gt; { title: "Rising Force", length: 13 } })
result.success? #=&gt; true
</code></pre>

<p>If that key isn’t present in the params hash, the operation fails before the actual validation.</p>

<pre><code>result = Song::Create.(params: { title: "Rising Force", length: 13 })
result.success? #=&gt; false
</code></pre>

<p>Note that string vs. symbol do matter here since the operation will simply do a hash lookup using the key you provided.</p>

<p><span class="divider"></span></p>

<ul class="navigation">
    <li>Validate</li>
    <li id="operation-contract-validate-dependency-injection-key">Dependency Injection / Key</li>
</ul>

<p>The <code>Validate()</code> macro allows to injecting the <code>:key</code> option at run-time instead of providing it when using the macro on the class level. You may omit the <code>:key</code> option in the <code>Validate()</code> macro call as below.</p>

<pre><code>class Song::Create &lt; Trailblazer::Operation
  # ...
  step Contract::Validate() # we don't define a key here! E.g. {key: "song"}
  step Contract::Persist()
end
</code></pre>

<p>Defining the <code>:key</code> option in <code>Operation.call</code> is now achieved by passing the <code>"contract.default.extract_key"</code> option.</p>

<pre><code>res = Song::Create.(
  params:                         params,
  "contract.default.extract_key": "song"
)
</code></pre>

<p>Note that the <code>.default</code> part might differ depending on the name of your contract.</p>

<p><span class="divider"></span></p>

<ul class="navigation">
    <li>Validate</li>
    <li id="operation-contract-validate-dependency-injection-contract-instance">Dependency injection / Contract instance</li>
</ul>

<p>Instead of using <code>Contract::Build()</code> to let the macro create the contract instance used for <code>Validate()</code>, an arbitrary contract object may be injected at run-time. You may omit <code>Model()</code> and <code>Contract::Build()</code> in that case.</p>

<pre><code>class Song::Create &lt; Trailblazer::Operation
  # we omit the {Model()} call as the run-time contract contains the model.
  # we don't have a {Contract::Build()} step here.
  step Contract::Validate(key: "song") # you could use an injection here, too!
  step Contract::Persist()
end
</code></pre>

<p>In order for <code>Validate()</code> to work you have to inject a contract via the <code>:"contract.default"</code> option.</p>

<pre><code>res = Song::Create.(
  params:             params,
  "contract.default": Song::Contract::Create.new(Song.new) # we build the contract ourselves!
)
</code></pre>

<p>As always, the <code>.default</code> part might differ depending on the name of your contract.</p>

<p><span class="divider"></span></p>

<h3 id="operation-contract-invalid-termini">Invalid Termini</h3>
<p><!-- {operation-contract-invalid-termini-toc} --></p>

<p>If the <code>Contract::Validate()</code> deviates on a failure track, it is possible to emit a new <a href="/2.1/docs/operation.html#signals">signal</a> suggesting contract failure.</p>

<p><img class="mx-auto d-block" src="/vite-dev/images/macro-ends.webp" /></p>

<p>This becomes really handy when used along with the <a href="/2.1/docs/endpoint.html">endpoint</a>.
It avoids any conditional checks and can be wired to render <strong>422 response</strong> without accessing the <code>ctx</code>.
In order to add this <a href="/2.1/docs/activity.html#activity-wiring-api-end-adding-ends">new termini</a> in your operation’s terminuses, you need to pass <code>invalid_data_terminus</code> kwarg.</p>

<pre><code>class Song::Create &lt; Trailblazer::Operation
  step Model( Song, :new )
  step Contract::Build( constant: Song::Contract::Create )
  step Contract::Validate( key: :song, invalid_data_terminus: true )
  step Contract::Persist( )
end
</code></pre>

<p>Based on the given <a href="/2.1/docs/operation.html#operation-contract-name">name</a> to this macro (default is ofcourse, <code>default</code>), it will assign <code>End</code> semantic as <code>"contract.#{name}.invalid"</code>.</p>

<pre><code>result = Song::Create.(params: { title: "Rising Force", length: 13 })
result.success? #=&gt; false
result.event    #=&gt; #&lt;Trailblazer::Activity::End semantic=:"contract.default.invalid"&gt;
</code></pre>

<p><span class="divider"></span></p>

<h3 id="operation-contract-persist">Persist</h3>
<p><!-- {operation-contract-persist-toc} --></p>

<p>To push validated data from the contract to the model(s), use <code>Persist</code>. Like <code>Validate</code>, this requires a contract to be set up beforehand.</p>

<pre><code>class Song::Create &lt; Trailblazer::Operation
  step Model( Song, :new )
  step Contract::Build( constant: Song::Contract::Create )
  step Contract::Validate()
  step Contract::Persist()
end
</code></pre>

<p>After the step, the contract’s attribute values are written to the model, and the contract will call <code>save</code> on the model.</p>

<pre><code>result = Song::Create.(params: { title: "Rising Force", length: 13 })
result.success? #=&gt; true
result["model"] #=&gt; #&lt;Song title="Rising Force", length=13&gt;
</code></pre>

<p>You can also configure the <code>Persist</code> step to call <code>sync</code> instead of Reform’s <code>save</code>.</p>

<pre><code>step Persist( method: :sync )
</code></pre>

<p>This will only write the contract’s data to the model without calling <code>save</code> on it.</p>

<p><span class="divider"></span></p>

<h3 id="operation-contract-name">Name</h3>
<p><!-- {operation-contract-name-toc} --></p>

<p>Explicit naming for the contract is possible, too.</p>

<pre><code>class Song::Create &lt; Trailblazer::Operation
  step Model( Song, :new )
  step Contract::Build(    name: "form", constant: Song::Contract::Create )
  step Contract::Validate( name: "form" )
  step Contract::Persist(  name: "form" )
end
</code></pre>

<p>You have to use the <code>name:</code> option to tell each step what contract to use. The contract and its result will now use your name instead of <code>default</code>.</p>

<pre><code>result = Song::Create.(params: { title: "A" })
result[:"contract.form"].errors.messages #=&gt; {:title=&gt;["is too short (minimum is 2 ch...
</code></pre>

<p>Use this if your operation has multiple contracts.</p>

<p><span class="divider"></span></p>

<h3 id="operation-contract-dry-validation">Dry-Validation</h3>
<p><!-- {operation-contract-dry-validation-toc} --></p>

<p>Instead of using <code>ActiveModel::Validation</code> you may use the very popular <a href="http://dry-rb.org/gems/dry-validation/"><code>dry-validation</code> gem</a> for  validations in your Reform class.</p>

<pre><code>require "reform/form/dry"
class Create &lt; Trailblazer::Operation
  # contract to verify params formally.
  class MyContract &lt; Reform::Form
    feature Dry
    property :id
    property :title

    validation name: :default do
      params do
        required(:id).filled
      end
    end

    validation name: :extra, if: :default do
      params do
        required(:title).filled(min_size?: 2)
      end
    end
  end

  step Model( Song, :new )                      # create the op's main model.
  step Contract::Build( constant: MyContract )  # create the Reform contract.
  step Contract::Validate()                     # validate the Reform contract.
  step Contract::Persist( method: :sync)        # persist the contract's data via the model.
end
</code></pre>

<p>All you need to do is including the <code>feature Dry</code> extension and applying dry-validation’s syntax within the <code>validation</code> blocks. The operation’s macros will work seamlessly with dry’s logic.</p>

<div class="bd-callout bd-callout-info">
<p>(TODO Jan 2021) We are rewriting the Dry-validation documentation shortly and will link to a more concise reference here.</p>
</div>

<p><span class="divider"></span></p>

<ul class="navigation">
    <li>Dry-Validation</li>
    <li id="operation-contract-dry-validation-dry-schema">Dry-Schema</li>
</ul>

<p>It is possible to use Dry’s <a href="http://dry-rb.org/gems/dry-validation/">Validation::Contract</a> directly as a contract in an operation, using the <code>Contract::Validate()</code> macro. You don’t need a model here, and the contract cannot be persisted. However, this is great for formal validations, e.g. to make sure the params have the correct format.</p>

<pre><code>module Song::Operation
  class Archive &lt; Trailblazer::Operation
    Schema = Dry::Validation.Contract do
      params do
        required(:id).filled
      end
    end

    # step Model(Song, :new)                              # You don't need {ctx[:model]}.
    step Contract::Validate(constant: Schema, key: :song) # Your validation.
    # ...
  end
end
</code></pre>

<p>Invoking the operation works exactly as it did with a “normal” contract.</p>

<pre><code>result = Song::Operation::Archive.(params: {song: {id: nil}})
</code></pre>

<p>Note that if you don’t use the <code>:song</code> key in your incoming data, you can <a href="/2.1/docs/operation.html#operation-contract-validate-key">configure</a> the <code>Validate()</code> macro to refrain from looking for that key.</p>

<p>The “errors” object after running the contract validation can be found at `ctx[:”result.contract.default”]</p>

<pre><code>result[:"result.contract.default"].errors[:id] #=&gt; ["must be filled"]
</code></pre>

<div class="bd-callout bd-callout-info">
<p>(TODO Jan 2021) We are working on an operation-wide <code>Errors</code> object which will be available at <code>ctx[:errors]</code>.</p>
</div>

<p><span class="divider"></span></p>

<h3 id="operation-contract-manual-extraction">Manual Extraction</h3>
<p><!-- {operation-contract-manual-extraction-toc} --></p>

<p>You can plug your own complex logic to extract params for validation into the pipe.</p>

<pre><code>class Create &lt; Trailblazer::Operation
  class MyContract &lt; Reform::Form
    property :title
  end

  def type
    "evergreen" # this is how you could do polymorphic lookups.
  end

  step Model( Song, :new )
  step Contract::Build(constant: MyContract)
  step :extract_params!
  step Contract::Validate( skip_extract: true )
  step Contract::Persist( method: :sync )

  def extract_params!(options, **)
    options[:"contract.default.params"] = options[:params][type]
  end
end
</code></pre>

<p>Note that you have to set the <code>self["params.validate"]</code> field in your own step, and - obviously - this has to happen before the actual validation.</p>

<p>Keep in mind that <code>&amp;</code> will deviate to the left track if your <code>extract_params!</code> logic returns falsey.</p>

<p><span class="divider"></span></p>

<h3 id="operation-contract-manual-build">Manual Build</h3>
<p><!-- {operation-contract-manual-build-toc} --></p>

<p>To manually build the contract instance, e.g. to inject the current user, use <code>builder:</code>.</p>

<pre><code>class Create &lt; Trailblazer::Operation

  class MyContract &lt; Reform::Form
    property :title
    property :current_user, virtual: true

    validate :current_user?
    validates :title, presence: true

    def current_user?
      return true if defined?(current_user)
      false
    end
  end

  step Model( Song, :new )
  step Contract::Build( constant: MyContract, builder: :default_contract! )
  step Contract::Validate()
  step Contract::Persist( method: :sync )

  def default_contract!(options, constant:, model:, **)
    constant.new(model, current_user: options [:current_user])
  end
end
</code></pre>

<p>Note how the contract’s class and the appropriate model are offered as kw arguments. You’re free to ignore these options and use your own assets.</p>

<p>As always, you may also use a proc.</p>

<p><span class="divider"></span></p>

<h3 id="operation-contract-result-object">Result Object</h3>
<p><!-- {operation-contract-result-object-toc} --></p>

<p>The operation will store the validation result for every contract in its own result object.</p>

<p>The path is <code>result.contract.#{name}</code>.</p>

<pre><code>result = Create.(params: { length: "A" })

result[:"result.contract.default"].success?        #=&gt; false
result[:"result.contract.default"].errors          #=&gt; Errors object
result[:"result.contract.default"].errors.messages #=&gt; {:length=&gt;["is not a number"]}
</code></pre>

<p>Each result object responds to <code>success?</code>, <code>failure?</code>, and <code>errors</code>, which is an <code>Errors</code> object. TODO: design/document Errors. WE ARE CURRENTLY WORKING ON A UNIFIED API FOR ERRORS (FOR DRY AND REFORM).</p>

<p><span class="divider"></span></p>

<h2 id="operation-options">Options</h2>
<p><!-- {operation-options-toc} --></p>

<p><span class="divider"></span></p>

<h3 id="operation-options-class-dependencies">Class Dependencies</h3>
<p><!-- {operation-options-class-dependencies-toc} --></p>

<p>If you want to configure values or dependencies on the operation class level, use the <code>ClassDependencies</code> module.</p>

<div class="bd-callout bd-callout-info">
<p>The usage of this feature is not recommended. Use a dry-container instead.</p>
</div>

<p>You may use the <code>self[]=</code> setter to add directives to the operation class.</p>

<p>These variables will be available within every step of the operation <em>and after</em>.</p>

<pre><code>class Create &lt; Trailblazer::Operation
  extend ClassDependencies

  # Configure some dependency on class level
  self[:validator] = AlwaysTrue

  step :validate
  step Subprocess(Insert)

  def validate(ctx, validator:, params:, **)
    validator.(params)
  end
end
</code></pre>

<p>Starting with the invocation of the <code>Create</code> operation, the <code>validator</code> variable is injected into the <code>ctx</code> and passed on.</p>

<pre><code>def validate(ctx, validator:, params:, **)
  validator.(params)
end
</code></pre>

<p>The variable is readable from <code>ctx</code> even when the operation finishes - so be careful in nested setups.</p>

<pre><code>signal, (ctx, _) = Create.([ctx, {}])

puts ctx[:validator] #=&gt; AlwaysTrue
</code></pre>

<div class="bd-callout bd-callout-info">
<p>Note that variables from within a nested operation are readable in the outer operation after the nested one has been invoked.</p>
</div>

<h2 id="signals">Signals</h2>

<p>A <em>signal</em> is the object that is returned from a task. It can be any kind of object, but per convention, we derive signals from <code>Trailblazer::Activity::Signal</code>. When using the wiring API with <code>step</code> and friends, your tasks will automatically get wrapped so the returned boolean <a href="https://github.com/trailblazer/trailblazer-operation/blob/master/lib/trailblazer/operation/railway/task_builder.rb">gets translated into a signal</a>.</p>

<p>You can bypass this by returning a signal directly.</p>

<table>
  <tbody>
    <tr>
      <td>{{ “signal-validate”</td>
      <td>tsnippet }}</td>
    </tr>
  </tbody>
</table>

<p>Historically, the signal name for taking the success track is <code>Right</code> whereas the signal for the error track is <code>Left</code>. Instead of using the signal constants directly (which some users, for whatever reason, prefer), you may use signal helpers. The following snippet is identical to the one above.</p>

<table>
  <tbody>
    <tr>
      <td>{{ “signalhelper-validate”</td>
      <td>tsnippet }}</td>
    </tr>
  </tbody>
</table>

<p>Available signal helpers per default are <code>Railway.pass!</code>, <code>Railway.fail!</code>, <code>Railway.pass_fast!</code> and <code>Railway.fail_fast!</code>.</p>

<p>{% callout %}
Note that those signals <strong>must have outputs that are connected to the next task</strong>, otherwise you will get a <code>IllegalOutputSignalError</code> exception. The PRO editor or tracing can help understanding.</p>

<p>Also, keep in mind that the more signals you use, the harder it will be to understand. This is why the operation <a href="#fast-track-fasttrack">enforces the <code>:fast_track</code> option</a> when you want to use <code>pass_fast!</code> and <code>fail_fast!</code> - so both the developer reading your operation and the framework itself know about the implications upfront.
{% endcallout %}</p>

</div>

                <aside>
                  <span class="deco-purple-cross wow fadeIn"></span>
                </aside>
              </main>

              <div class="d-none d-xl-block col-xl-2 list-group sidebar-scroll order-3">
                <img alt="Trailblazer" class="wow fadeIn" src="/vite-dev/images/deco1.webp" />
                <div class="features" id="operation-overview-features">
  <h3>
    <i class="fas fa-times"></i>
    <span>Overview</span>
  </h3>

  <ul class="vertical menu">
    
      <li>
        <a href="#operation-overview-invocation">
          <i class="fas fa-arrow-right"></i>
          Invocation
        </a>
      </li>
      
        
        <li class="sub-item">
          <a href="#operation-overview-invocation-public-call">Public call</a>
        </li>
      
        
        <li class="sub-item">
          <a href="#operation-overview-invocation-circuit-interface">Circuit Interface</a>
        </li>
      
    
      <li>
        <a href="#operation-overview-wiring">
          <i class="fas fa-arrow-right"></i>
          Wiring
        </a>
      </li>
      
    
      <li>
        <a href="#operation-overview-result">
          <i class="fas fa-arrow-right"></i>
          Result
        </a>
      </li>
      
    
  </ul>
</div>

<div class="features" id="operation-macros-features">
  <h3>
    <i class="fas fa-times"></i>
    <span>Macros</span>
  </h3>

  <ul class="vertical menu">
    
      <li>
        <a href="#operation-macros-general-notes">
          <i class="fas fa-arrow-right"></i>
          General notes
        </a>
      </li>
      
        
        <li class="sub-item">
          <a href="#operation-macros-general-notes-variable-mapping">Variable mapping</a>
        </li>
      
    
      <li>
        <a href="#operation-macros-model">
          <i class="fas fa-arrow-right"></i>
          Model
        </a>
      </li>
      
        
        <li class="sub-item">
          <a href="#operation-macros-model-find_by">Find_by</a>
        </li>
      
        
        <li class="sub-item">
          <a href="#operation-macros-model-arbitrary-finder">Arbitrary Finder</a>
        </li>
      
        
        <li class="sub-item">
          <a href="#operation-macros-model-not-found">Not Found</a>
        </li>
      
        
        <li class="sub-item">
          <a href="#operation-macros-model-dependency-injection">Dependency Injection</a>
        </li>
      
        
        <li class="sub-item">
          <a href="#operation-macros-model-dependency-injection-model-class">Dependency Injection / Model class</a>
        </li>
      
    
      <li>
        <a href="#operation-macros-nested">
          <i class="fas fa-arrow-right"></i>
          Nested
        </a>
      </li>
      
        
        <li class="sub-item">
          <a href="#operation-macros-nested-auto-wire">Auto-wire</a>
        </li>
      
    
  </ul>
</div>

<div class="features" id="operation-nested-features">
  <h3>
    <i class="fas fa-times"></i>
    <span>Nested</span>
  </h3>

  <ul class="vertical menu">
    
      <li>
        <a href="#operation-nested-dynamic">
          <i class="fas fa-arrow-right"></i>
          Dynamic
        </a>
      </li>
      
    
      <li>
        <a href="#operation-nested-auto_wire">
          <i class="fas fa-arrow-right"></i>
          Auto_wire
        </a>
      </li>
      
        
        <li class="sub-item">
          <a href="#operation-nested-auto_wire-output-wiring">Output Wiring</a>
        </li>
      
        
        <li class="sub-item">
          <a href="#operation-nested-auto_wire-debugging">Debugging</a>
        </li>
      
    
      <li>
        <a href="#operation-nested-wrap">
          <i class="fas fa-arrow-right"></i>
          Wrap
        </a>
      </li>
      
        
        <li class="sub-item">
          <a href="#operation-nested-wrap-callable">Callable</a>
        </li>
      
        
        <li class="sub-item">
          <a href="#operation-nested-wrap-return-value">Return Value</a>
        </li>
      
    
      <li>
        <a href="#operation-nested-rescue">
          <i class="fas fa-arrow-right"></i>
          Rescue
        </a>
      </li>
      
        
        <li class="sub-item">
          <a href="#operation-nested-rescue-full-example">Full example</a>
        </li>
      
    
  </ul>
</div>

<div class="features" id="operation-policy-features">
  <h3>
    <i class="fas fa-times"></i>
    <span>Policy</span>
  </h3>

  <ul class="vertical menu">
    
      <li>
        <a href="#operation-policy-pundit">
          <i class="fas fa-arrow-right"></i>
          Pundit
        </a>
      </li>
      
        
        <li class="sub-item">
          <a href="#operation-policy-pundit-api">API</a>
        </li>
      
        
        <li class="sub-item">
          <a href="#operation-policy-pundit-name">Name</a>
        </li>
      
        
        <li class="sub-item">
          <a href="#operation-policy-pundit-dependency-injection">Dependency Injection</a>
        </li>
      
    
      <li>
        <a href="#operation-policy-guard">
          <i class="fas fa-arrow-right"></i>
          Guard
        </a>
      </li>
      
        
        <li class="sub-item">
          <a href="#operation-policy-guard-api">API</a>
        </li>
      
        
        <li class="sub-item">
          <a href="#operation-policy-guard-callable">Callable</a>
        </li>
      
        
        <li class="sub-item">
          <a href="#operation-policy-guard-instance-method">Instance Method</a>
        </li>
      
        
        <li class="sub-item">
          <a href="#operation-policy-guard-name">Name</a>
        </li>
      
        
        <li class="sub-item">
          <a href="#operation-policy-guard-dependency-injection">Dependency Injection</a>
        </li>
      
        
        <li class="sub-item">
          <a href="#operation-policy-guard-position">Position</a>
        </li>
      
    
  </ul>
</div>

<div class="features" id="operation-contract-features">
  <h3>
    <i class="fas fa-times"></i>
    <span>Contract</span>
  </h3>

  <ul class="vertical menu">
    
      <li>
        <a href="#operation-contract-overview-reform">
          <i class="fas fa-arrow-right"></i>
          overview: reform
        </a>
      </li>
      
    
      <li>
        <a href="#operation-contract-definition">
          <i class="fas fa-arrow-right"></i>
          Definition
        </a>
      </li>
      
        
        <li class="sub-item">
          <a href="#operation-contract-definition-explicit">Explicit</a>
        </li>
      
        
        <li class="sub-item">
          <a href="#operation-contract-definition-inline">Inline</a>
        </li>
      
    
      <li>
        <a href="#operation-contract-build">
          <i class="fas fa-arrow-right"></i>
          Build
        </a>
      </li>
      
        
        <li class="sub-item">
          <a href="#operation-contract-build-dependency-injection-contract-class">Dependency Injection / Contract class</a>
        </li>
      
    
      <li>
        <a href="#operation-contract-validate">
          <i class="fas fa-arrow-right"></i>
          Validate
        </a>
      </li>
      
        
        <li class="sub-item">
          <a href="#operation-contract-validate-key">Key</a>
        </li>
      
        
        <li class="sub-item">
          <a href="#operation-contract-validate-dependency-injection-key">Dependency Injection / Key</a>
        </li>
      
        
        <li class="sub-item">
          <a href="#operation-contract-validate-dependency-injection-contract-instance">Dependency injection / Contract instance</a>
        </li>
      
    
      <li>
        <a href="#operation-contract-invalid-termini">
          <i class="fas fa-arrow-right"></i>
          Invalid Termini
        </a>
      </li>
      
    
      <li>
        <a href="#operation-contract-persist">
          <i class="fas fa-arrow-right"></i>
          Persist
        </a>
      </li>
      
    
      <li>
        <a href="#operation-contract-name">
          <i class="fas fa-arrow-right"></i>
          Name
        </a>
      </li>
      
    
      <li>
        <a href="#operation-contract-dry-validation">
          <i class="fas fa-arrow-right"></i>
          Dry-Validation
        </a>
      </li>
      
        
        <li class="sub-item">
          <a href="#operation-contract-dry-validation-dry-schema">Dry-Schema</a>
        </li>
      
    
      <li>
        <a href="#operation-contract-manual-extraction">
          <i class="fas fa-arrow-right"></i>
          Manual Extraction
        </a>
      </li>
      
    
      <li>
        <a href="#operation-contract-manual-build">
          <i class="fas fa-arrow-right"></i>
          Manual Build
        </a>
      </li>
      
    
      <li>
        <a href="#operation-contract-result-object">
          <i class="fas fa-arrow-right"></i>
          Result Object
        </a>
      </li>
      
    
  </ul>
</div>

<div class="features" id="operation-options-features">
  <h3>
    <i class="fas fa-times"></i>
    <span>Options</span>
  </h3>

  <ul class="vertical menu">
    
      <li>
        <a href="#operation-options-class-dependencies">
          <i class="fas fa-arrow-right"></i>
          Class Dependencies
        </a>
      </li>
      
    
  </ul>
</div>

              </div>
            </div>
          </div>
        </section>
      </main>

      <footer class="trailblazer-footer">
  <div class="container">
    <div class="row align-items-center">
      <div class="col-md-3 col-lg-2">
        <a href="/2.1/index.html" class="logo-footer">Trailblazer</a>
      </div>
      <div class="col-md-6 col-lg-8">
        <nav>
          <ul class="navbar-nav documentation-nav-items">
  <li>
    <a class="nav-item nav-link active" href="/2.1/docs/trailblazer.html">
      <i class="fas fa-arrow-right"></i>
      DOCS
    </a>
  </li>

  <li>
    <a class="nav-item nav-link " href="https://dev.to/trailblazer">BLOG</a>
  </li>

  <li class="">
    <a class="nav-item nav-link " href="/2.1/about_us.html">ABOUT US</a>
  </li>

  <li>
    <a class="nav-item nav-link " href="/2.1/learn.html">LEARN</a>
  </li>

  <li class="">
    <a class="nav-item nav-link" href="/2.0/index.html">
      <i class="fas fa-arrow-right"></i>
      2.0
    </a>
  </li>

  <li>
    <a class="nav-item nav-link" href="https://trailblazer.zulipchat.com" target="_blank">
      <i class="fas fa-comments"></i>
      CHAT
    </a>
  </li>

  <!--
  
  -->
</ul>

        </nav>
      </div>
      <div class="col-md-3 col-lg-2">
        <ul class="social purple">
          <li>
            <a href="https://github.com/trailblazer" target="_blank"><i class="fab fa-github-square"></i></a>
          </li>
          <li>
            <a href="https://www.facebook.com/trailblazer.to" target="_blank"><i class="fab fa-facebook-square"></i></a>
          </li>
          <li>
            <a href="https://twitter.com/trailblazer_to" target="_blank"><i class="fab fa-twitter-square"></i></a>
          </li>
        </ul>
      </div>
    </div>
  </div>
</footer>

    </div>
  </body>
</html>
