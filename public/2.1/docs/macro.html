<!DOCTYPE html>
<html lang="en" data-theme="dark">
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, shrink-to-fit=no">

    <title>Trailblazer - Macro</title>

    <script src="/vite-dev/@vite/client" type="module"></script>
    <script src="/vite-dev/entrypoints/documentation.js" crossorigin="anonymous" type="module"></script>

    <link
      href="https://fonts.googleapis.com/css?family=Raleway:200,300,400,500,600,700,800"
      rel="stylesheet"
    >
    <link
      href="https://fonts.googleapis.com/icon?family=Material+Icons"
      rel="stylesheet"
    >
    <link
      rel="preconnect"
      href="https://R2IYF7ETH7-dsn.algolia.net" crossorigin
    >
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/@docsearch/css@3"
    >

    

    <link rel="icon" type="image/png" sizes="32x32" href="/vite-dev/images/favicon.ico">
  </head>
  <body>
    <div class="alert alert-primary m-0 rounded-0 text-center" role="alert">
      <span class="alert-text text-center">
        <!-- The new TRB 2.1 book series has begun - 82 pages are <a class="alert-link" href="https://leanpub.com/buildalib">waiting for you</a>! -->
        Dear Russian friends, please watch President Zelenskyy's
        <a href="https://twitter.com/PMoelleken/status/1496941845812760577">speech addressed to you</a>.
        🇺🇦 Help our brave mates in Ukraine
        <a
          href="https://actions.sumofus.org/a/give-to-ukrainians-who-need-an-urgent-lifeline"
        >
          with a donation
        </a>.
      </span>
    </div>

    <div class="lg-bg">
      <!-- Add class="session-show" if you need a header with dark background -->
      <header
        id="header"
        class="trailblazer-header documentation-navbar navbar navbar-expand-lg flex-column flex-md-row"
      >
        <h1 class="m-2">
          <a class="navbar-brand mr-0 mr-md-2" href="/2.1/index.html">Trailblazer</a>
        </h1>

        <div class="navbar-nav-scroll ml-md-auto">
          <ul class="navbar-nav documentation-nav-items">
  <li>
    <a class="nav-item nav-link active" href="/2.1/docs/trailblazer.html">
      <i class="fas fa-arrow-right"></i>
      DOCS
    </a>
  </li>

  <li>
    <a class="nav-item nav-link " href="https://dev.to/trailblazer">BLOG</a>
  </li>

  <li class="d-none d-md-block">
    <a class="nav-item nav-link " href="/2.1/about_us.html">ABOUT US</a>
  </li>

  <li>
    <a class="nav-item nav-link " href="/2.1/learn.html">LEARN</a>
  </li>

  <li class="d-none d-md-block">
    <a class="nav-item nav-link" href="/2.0/index.html">
      <i class="fas fa-arrow-right"></i>
      2.0
    </a>
  </li>

  <li>
    <a class="nav-item nav-link" href="https://trailblazer.zulipchat.com" target="_blank">
      <i class="fas fa-comments"></i>
      CHAT
    </a>
  </li>

  <!--
  
    <li>
      <div id="docsearch"></div> https://docsearch.algolia.com/docs/DocSearch-v3
    </li>
  
  -->
</ul>

        </div>
      </header>

      <main>
        <section class="documentation-main">
          <div class="container-fluid">
            <div class="row flex-xl-nowrap">
              <div class="col-md-3 col-xl-2 border-bottom order-1 sidebar-accordion sidebar-scroll">
                <form class="d-md-none d-flex align-items-center position-relative py-3 mx-n3 border-bottom">
                  <button
                    class="navbar-toggler collapsed"
                    type="button"
                    data-toggle="collapse"
                    data-target="#navBarTrailBlazer"
                    aria-controls="navBarTrailBlazer"
                    aria-expanded="false"
                    aria-label="Toggle navigation"
                  >
                    <i class="far fa-lg fa-bars"></i>
                  </button>
                </form>
                <div class="collapse d-md-block py-3 mx-n3" id="navBarTrailBlazer">
                  <div class="border-bottom">
  <div class="my-4">
    <div class="sidebar-accordion-wrapper">
  <div id="trailblazer">
    <h2 class="mb-0 mt-1 sidebar-accordion-item">
      <a href="/2.1/docs/trailblazer.html">
        <button
          class="collapsed"
          data-toggle="collapse"
          data-target="#trailblazer-collapse"
          aria-expanded="false"
          aria-controls="trailblazer-collapse"
        >
          <i class="fas fa-chevron-right"></i>
          <i class="fas fa-times"></i>
          <span>Trailblazer</span>
        </button>
      </a>
    </h2>
  </div>

  
</div>

<div class="sidebar-accordion-wrapper">
  <div id="rails-integration">
    <h2 class="mb-0 mt-1 sidebar-accordion-item">
      <a href="/2.1/docs/rails.html">
        <button
          class="collapsed"
          data-toggle="collapse"
          data-target="#rails-integration-collapse"
          aria-expanded="false"
          aria-controls="rails-integration-collapse"
        >
          <i class="fas fa-chevron-right"></i>
          <i class="fas fa-times"></i>
          <span>Rails Integration</span>
        </button>
      </a>
    </h2>
  </div>

  
</div>

<div class="sidebar-accordion-wrapper">
  <div id="test">
    <h2 class="mb-0 mt-1 sidebar-accordion-item">
      <a href="/2.1/docs/test.html">
        <button
          class="collapsed"
          data-toggle="collapse"
          data-target="#test-collapse"
          aria-expanded="false"
          aria-controls="test-collapse"
        >
          <i class="fas fa-chevron-right"></i>
          <i class="fas fa-times"></i>
          <span>Test</span>
        </button>
      </a>
    </h2>
  </div>

  
</div>

  </div>
</div>

<div class="border-bottom">
  <div class="my-4">
    <div class="sidebar-accordion-wrapper">
  <div id="activity">
    <h2 class="mb-0 mt-1 sidebar-accordion-item">
      <a href="/2.1/docs/activity.html">
        <button
          class="collapsed"
          data-toggle="collapse"
          data-target="#activity-collapse"
          aria-expanded="false"
          aria-controls="activity-collapse"
        >
          <i class="fas fa-chevron-right"></i>
          <i class="fas fa-times"></i>
          <span>Activity</span>
        </button>
      </a>
    </h2>
  </div>

  
</div>

<div class="sidebar-accordion-wrapper">
  <div id="macro">
    <h2 class="mb-0 mt-1 sidebar-accordion-item">
      <a href="/2.1/docs/macro.html">
        <button
          class=""
          data-toggle="collapse"
          data-target="#macro-collapse"
          aria-expanded="true"
          aria-controls="macro-collapse"
        >
          <i class="fas fa-chevron-right"></i>
          <i class="fas fa-times"></i>
          <span>Macro</span>
        </button>
      </a>
    </h2>
  </div>

  
    <div
      id="macro-collapse"
      class="collapse show"
      aria-labelledby="macro"
      data-parent="#accordion"
    >
      <ul class="nav vertical menu navbar-light">
        
          <li class="nav-item">
            <a class="nav-link active" href="#macro-overview">
              Overview
            </a>
          </li>
        
          <li class="nav-item">
            <a class="nav-link " href="#macro-nested">
              Nested
            </a>
          </li>
        
          <li class="nav-item">
            <a class="nav-link " href="#macro-wrap">
              Wrap
            </a>
          </li>
        
      </ul>
    </div>
  
</div>

<div class="sidebar-accordion-wrapper">
  <div id="operation">
    <h2 class="mb-0 mt-1 sidebar-accordion-item">
      <a href="/2.1/docs/operation.html">
        <button
          class="collapsed"
          data-toggle="collapse"
          data-target="#operation-collapse"
          aria-expanded="false"
          aria-controls="operation-collapse"
        >
          <i class="fas fa-chevron-right"></i>
          <i class="fas fa-times"></i>
          <span>Operation</span>
        </button>
      </a>
    </h2>
  </div>

  
</div>

<div class="sidebar-accordion-wrapper">
  <div id="workflow">
    <h2 class="mb-0 mt-1 sidebar-accordion-item">
      <a href="/2.1/docs/workflow.html">
        <button
          class="collapsed"
          data-toggle="collapse"
          data-target="#workflow-collapse"
          aria-expanded="false"
          aria-controls="workflow-collapse"
        >
          <i class="fas fa-chevron-right"></i>
          <i class="fas fa-times"></i>
          <span>Workflow</span>
        </button>
      </a>
    </h2>
  </div>

  
</div>

<div class="sidebar-accordion-wrapper">
  <div id="endpoint">
    <h2 class="mb-0 mt-1 sidebar-accordion-item">
      <a href="/2.1/docs/endpoint.html">
        <button
          class="collapsed"
          data-toggle="collapse"
          data-target="#endpoint-collapse"
          aria-expanded="false"
          aria-controls="endpoint-collapse"
        >
          <i class="fas fa-chevron-right"></i>
          <i class="fas fa-times"></i>
          <span>Endpoint</span>
        </button>
      </a>
    </h2>
  </div>

  
</div>

  </div>
</div>

<div class="border-bottom">
  <div class="my-4">
    <div class="sidebar-accordion-wrapper">
  <div id="reform">
    <h2 class="mb-0 mt-1 sidebar-accordion-item">
      <a href="/2.1/docs/reform.html">
        <button
          class="collapsed"
          data-toggle="collapse"
          data-target="#reform-collapse"
          aria-expanded="false"
          aria-controls="reform-collapse"
        >
          <i class="fas fa-chevron-right"></i>
          <i class="fas fa-times"></i>
          <span>Reform</span>
        </button>
      </a>
    </h2>
  </div>

  
</div>

<div class="sidebar-accordion-wrapper">
  <div id="cells">
    <h2 class="mb-0 mt-1 sidebar-accordion-item">
      <a href="/2.1/docs/cells.html">
        <button
          class="collapsed"
          data-toggle="collapse"
          data-target="#cells-collapse"
          aria-expanded="false"
          aria-controls="cells-collapse"
        >
          <i class="fas fa-chevron-right"></i>
          <i class="fas fa-times"></i>
          <span>Cells</span>
        </button>
      </a>
    </h2>
  </div>

  
</div>

<div class="sidebar-accordion-wrapper">
  <div id="representable">
    <h2 class="mb-0 mt-1 sidebar-accordion-item">
      <a href="/2.1/docs/representable.html">
        <button
          class="collapsed"
          data-toggle="collapse"
          data-target="#representable-collapse"
          aria-expanded="false"
          aria-controls="representable-collapse"
        >
          <i class="fas fa-chevron-right"></i>
          <i class="fas fa-times"></i>
          <span>Representable</span>
        </button>
      </a>
    </h2>
  </div>

  
</div>

<div class="sidebar-accordion-wrapper">
  <div id="disposable">
    <h2 class="mb-0 mt-1 sidebar-accordion-item">
      <a href="/2.1/docs/disposable.html">
        <button
          class="collapsed"
          data-toggle="collapse"
          data-target="#disposable-collapse"
          aria-expanded="false"
          aria-controls="disposable-collapse"
        >
          <i class="fas fa-chevron-right"></i>
          <i class="fas fa-times"></i>
          <span>Disposable</span>
        </button>
      </a>
    </h2>
  </div>

  
</div>

<div class="sidebar-accordion-wrapper">
  <div id="roar">
    <h2 class="mb-0 mt-1 sidebar-accordion-item">
      <a href="/2.1/docs/roar.html">
        <button
          class="collapsed"
          data-toggle="collapse"
          data-target="#roar-collapse"
          aria-expanded="false"
          aria-controls="roar-collapse"
        >
          <i class="fas fa-chevron-right"></i>
          <i class="fas fa-times"></i>
          <span>Roar</span>
        </button>
      </a>
    </h2>
  </div>

  
</div>

  </div>
</div>

<div class="border-bottom">
  <div class="my-4">
    <div class="sidebar-accordion-wrapper">
  <div id="tutorials">
    <h2 class="mb-0 mt-1 sidebar-accordion-item">
      <a href="/2.1/docs/tutorials/activity.html">
        <button
          class="collapsed"
          data-toggle="collapse"
          data-target="#tutorials-collapse"
          aria-expanded="false"
          aria-controls="tutorials-collapse"
        >
          <i class="fas fa-chevron-right"></i>
          <i class="fas fa-times"></i>
          <span>Tutorials</span>
        </button>
      </a>
    </h2>
  </div>

  
</div>

<div class="sidebar-accordion-wrapper">
  <div id="pro">
    <h2 class="mb-0 mt-1 sidebar-accordion-item">
      <a href="/2.1/docs/pro.html">
        <button
          class="collapsed"
          data-toggle="collapse"
          data-target="#pro-collapse"
          aria-expanded="false"
          aria-controls="pro-collapse"
        >
          <i class="fas fa-chevron-right"></i>
          <i class="fas fa-times"></i>
          <span>PRO</span>
        </button>
      </a>
    </h2>
  </div>

  
</div>

  </div>
</div>

                </div>
              </div>

              <main
                class="col-md-9 col-xl-8 py-md-5 pl-md-5 order-2"
                role="main"
              >
                <div class="doc-block section-name session-show">
                  <h1 class="w-100">Macro</h1>
                  <ul>
                    <li>
                      <i class="far fa-clock pink"></i>
                      <span>Last updated 14 Nov 22</span>
                    </li>
                  </ul>
                </div>

                <div class="doc-block">
<p><span class="divider"></span></p>

<h2 id="macro-overview">Overview</h2>
<p><!-- {macro-overview-toc} --></p>

<p><a href="https://github.com/trailblazer/trailblazer-macro" class="pink"><i class="fa fa-gem" aria-hidden="true"></i> trailblazer-macro &gt;= 2.1.11</a></p>

<p>Macros provide shorthand methods to create and configure a particular step in your operation. Trailblazer ships with a handful of macros. Those are implemented in trailblazer-macro and trailblazer-macro-contract.</p>

<p>Writing you own macros is a very simple thing to do if you follow the macro API. <a href="/2.1/docs/activity.html#activity-macro-api"><i class="fa fa-book" aria-hidden="true"></i> API docs</a></p>

<p><span class="divider"></span></p>

<h3 id="macro-overview-general-notes">General notes</h3>
<p><!-- {macro-overview-general-notes-toc} --></p>

<p><span class="divider"></span></p>

<ul class="navigation">
    <li>General notes</li>
    <li id="macro-overview-general-notes-variable-mapping">Variable mapping</li>
</ul>

<p>Most macros internally use <a href="/2.1/docs/activity.html#activity-variable-mapping">variable mapping</a> to allow injection of configuration variables or to limit their own scope. Macros do so by leveraging the composable API using <code>In()</code>, <code>Inject()</code> and <code>Out()</code>.</p>

<p>This allows you to <em>add your own</em> variable mapping to a macro, as illustrated in the example below.</p>

<pre><code>class Create &lt; Trailblazer::Operation
  step Model(Song, :find_by),
    In() =&gt; -&gt;(ctx, my_id:, **) { ctx.merge(params: {id: my_id}) } # Model() needs {params[:id]}.
  # ...
end
</code></pre>

<p>When running the above operation, the exemplary <code>Model()</code> macro will pick the ID from <code>:my_id</code>.</p>

<pre><code>result = Create.(my_id: 1)
</code></pre>

<p>Please note that you shall <strong>not use <code>:input</code></strong> to configure your macro as it will override internal filters and breaks the macro’s configuration. Go with the new <a href="/2.1/docs/activity.html#activity-variable-mapping-composable-i-o">composable variable mapping</a> which is available from <code>trailblazer</code> 2.1.1 and onwards.</p>

<p><span class="divider"></span></p>

<h2 id="macro-nested">Nested</h2>
<p><!-- {macro-nested-toc} --></p>

<p>Only use the <code>Nested()</code> macro if you’re planning to nest an activity that can only be chosen at runtime.</p>

<ul>
  <li>If you know the nested activity upfront, use <a href="">Subprocess()</a>.</li>
  <li>If you know the activities upfront, and need only need to choose at run-time, use the <a href="#macro-nested-auto_wire"><code>:auto_wire</code> option</a>.</li>
</ul>

<p><span class="divider"></span></p>

<h3 id="macro-nested-dynamic">Dynamic</h3>
<p><!-- {macro-nested-dynamic-toc} --></p>

<p>Use <code>Nested()</code> to dynamically decide which nested activity to invoke, but when you don’t know all activities to pick from. This is sometimes the case in polymorphic setups, when a part of an operation needs to be “decided” at runtime, with no way to know what this will look like when writing the operation class.</p>

<p>Consider the following activity to create a song. Depending on the input in <code>params</code>, you either want to run a nested <code>Id3Tag</code> processor activity for an MP3 song, or <code>VorbisComment</code> at a specific point during the song creation.</p>

<pre><code>module Song::Activity
  class Create &lt; Trailblazer::Activity::Railway
    step :model
    step Nested(:decide_file_type) # Run either {Id3Tag} or {VorbisComment}
    step :save
    # ...
    def decide_file_type(ctx, params:, **)
      params[:type] == "mp3" ? Id3Tag : VorbisComment
    end
  end
end
</code></pre>

<p>When using <code>Nested()</code> with only one argument, the <em>decider</em>, we call this the “dynamic style”. Since we don’t know the possible nested activities upfront, the macro needs to compile several internals at runtime, which will be slower than its static equivalent.</p>

<p><span class="divider"></span></p>

<ul class="navigation">
    <li>Dynamic</li>
    <li id="macro-nested-dynamic-decider">Decider</li>
</ul>

<p>The decider can be any “option style” callable: an instance method in the hosting <code>Create</code> activity, any lambda or proc, or a callable object or class. In our example, it’s an instance method.</p>

<p>The decider receives <code>ctx</code> and keyword arguments just like any other step. It is run directly before the nested activity is run, it’s <strong>return value decides about</strong> which one that will be: <code>Id3Tag</code> or <code>VorbisComment</code>.</p>

<p><span class="divider"></span></p>

<ul class="navigation">
    <li>Dynamic</li>
    <li id="macro-nested-dynamic-nested-activity">Nested activity</li>
</ul>

<p>The nested activity (or operation) will, per default, receive the same <code>ctx</code> that a <code>step</code> in place of <code>Nested()</code> would receive.</p>

<pre><code>module Song::Activity
  class Id3Tag &lt; Trailblazer::Activity::Railway
    step :parse
    step :encode_id3
    # ...
  end
end
</code></pre>

<h1 id="dynamic-output">:dynamic-output</h1>

<p><span class="divider"></span></p>

<h3 id="macro-nested-auto_wire">Auto_wire</h3>
<p><!-- {macro-nested-auto_wire-toc} --></p>

<p>The recommended way of maintaining dynamically nested operations (or activities) is to use <code>Nested()</code> with the <code>:auto_wire</code> option. It works exactly like its <a href="#macro-nested-dynamic">purely dynamic</a> counterpart but requires you to specify all possible nested activities <strong>at compile-time</strong>.</p>

<pre><code>module Song::Activity
  class Create &lt; Trailblazer::Activity::Railway
    step :model
    step Nested(:decide_file_type,
      auto_wire: [Id3Tag, VorbisComment]) # explicitely define possible nested activities.
    step :save
    # ...

    def decide_file_type(ctx, params:, **)
      params[:type] == "mp3" ? Id3Tag : VorbisComment
    end
  end
end
</code></pre>

<p>The <code>:auto_wire</code> option expects an array of nested activities. While this might seem a bit clumsy, this brings several benefits. First of all, execution is much faster since the entire activity graph is created at compile-time. Second, you can use the Debugging API to <a href="#macro-nested-auto_wire-debugging">introspect things</a>.</p>

<p>You can use any type of decider step. In this example, it’s a instance method <code>#decide_file_type</code> on the <code>Nested()</code>-hosting class.</p>

<p><img class="mx-auto d-block" src="/vite-dev/images/nested-static-create.png" /></p>

<p>Internally, the “auto-wire” <code>Nested()</code> macro simply returns a small activity as illustrated above in gray. It has a <code>decide</code> step to figure out which nested activity to run, then runs the actual nested activity. All well-known termini (success, failure, pass_fast, fail_fast) of the nested activities are automatically connected to the <code>Nested()</code>’s activity’s termini.</p>

<p><span class="divider"></span></p>

<ul class="navigation">
    <li>Auto_wire</li>
    <li id="macro-nested-auto_wire-output-wiring">Output Wiring</li>
</ul>

<p>Given we had a nested activity <code>VorbisComment</code> implemented like so.</p>

<pre><code>module Song::Activity
  class VorbisComment &lt; Trailblazer::Activity::Railway
    step :prepare_metadata
    step :encode_cover, Output(:failure) =&gt; End(:unsupported_file_format)
    # ...
  end
end
</code></pre>

<p>If the <code>#encode_cover</code> step fails, the activity will stop in the <code>End.unsupported_file_format</code> terminus - an end event very specific to the <code>VorbisComment</code> activity.</p>

<p><img class="mx-auto d-block" src="/vite-dev/images/nested-static-vorbiscomment.png" /></p>

<p>This new terminus has to be wired explicitely in the nesting activity.</p>

<pre><code>module Song::Activity
  class Create &lt; Trailblazer::Activity::Railway
    step :model
    step Nested(
        :decide_file_type,
        auto_wire: [Id3Tag, VorbisComment]
      ),
      # Output and friends are used *after* Nested().
      # Connect VorbisComment's {unsupported_file_format} to our {failure} track:
      Output(:unsupported_file_format) =&gt; Track(:failure)

    step :save
    # ...
  end
end
</code></pre>

<p>Using <code>Output(:unsupported_file_type)</code> from the Wiring API you can connect this specific terminus to wherever you need it, here it’s routed to the failure track in <code>Create</code>. Note that Wiring API options are used after <code>Nested(...)</code>, not within its parenthesis.</p>

<p>The complete activity graph would look a bit like the following diagram.</p>

<p><img class="mx-auto d-block" src="/vite-dev/images/nested-static-complete.png" /></p>

<p><span class="divider"></span></p>

<ul class="navigation">
    <li>Auto_wire</li>
    <li id="macro-nested-auto_wire-debugging">Debugging</li>
</ul>

<p>Static <code>Nested</code> setups are traceable using <code>#wtf?</code>. The above examples result in a flow as follows.</p>

<pre><code>Song::Activity::Create
|-- Start.default
|-- model
|-- Nested(decide_file_type)
|   |-- Start.default
|   |-- route_to_nested_activity
|   |-- DocsNestedStaticTest::A::Song::Activity::VorbisComment
|   |   |-- Start.default
|   |   |-- prepare_metadata
|   |   |-- encode_cover
|   |   `-- End.success
|   `-- End.success
|-- save
`-- End.success
</code></pre>

<p>The trace is fully compatible with the Debugging API and allows compile-time introspection. For example, you can specify the path to a nested activity <code>Id3Tag</code> and inspect it.</p>

<pre><code>Trailblazer::Developer.render(Song::Activity::Create,
  path: [
    "Nested(decide_file_type)", # ID of Nested()
    Song::Activity::Id3Tag      # ID of the nested {Id3Tag} activity.
  ]
)
</code></pre>

<p>Note that the ID of the nested activities are the class constants.</p>

<p><span class="divider"></span></p>

<h2 id="macro-wrap">Wrap</h2>
<p><!-- {macro-wrap-toc} --></p>

<p>Sometimes you need to run a sequence of steps within some block you provide. Often, this is required when certain steps must be wrapped in a database transaction. The <code>Wrap()</code> macro does just that.</p>

<pre><code>module Song::Activity
  class Upload &lt; Trailblazer::Activity::FastTrack
    step :model
    step Wrap(MyTransaction) {
      step :update   # this changes the database.
      step :transfer # this might even break!
    }
    step :notify
    fail :log_error
    # ...
  end
end
</code></pre>

<p>In an imaginary song <code>Upload</code> operation that transfers a music file to some streaming service platform while updating fields on the database, needs the steps <code>#update</code> and <code>#transfer</code> being run inside a transaction. The code running and interpreting this block is provided via the custom transaction <code>MyTransaction</code>.</p>

<p><span class="divider"></span></p>

<h3 id="macro-wrap-wrap-handler">Wrap handler</h3>
<p><!-- {macro-wrap-wrap-handler-toc} --></p>

<p>The most simple “transaction” (we call it <em>wrap handler</em>) could look as follows.</p>

<pre><code>class MyTransaction
  def self.call((ctx, flow_options), **, &amp;block)
    signal, (ctx, flow_options) = yield # calls the wrapped steps

    return signal, [ctx, flow_options]
  end
end
</code></pre>

<p>Your transaction handler can be any type of [callable] exposing the <a href="activity.html#activity-internals-circuit-interface">circuit interface</a>.</p>

<p>In the most simple transaction ever written, we simply run the wrapped steps by calling <code>yield</code>. This will return a circuit-interface return set. The interesting parts are the returned <code>ctx</code>, which is the ctx that left the wrapped steps, and the <code>signal</code>, which indicates the outcome of running the wrapped steps.</p>

<p>Note that internally <code>#update</code> and <code>#transfer</code> are put into a separate activity. The terminus reached in that activity is the signal.</p>

<p><img class="mx-auto d-block" src="/vite-dev/images/wrap.png" /></p>

<p>Given that both <code>#update</code> and <code>#transfer</code> are railway steps, the wrapped code can terminate in a <code>success</code> terminus, or a <code>failure</code>.
It’s now your handler that is responsible to interpret that. In the example above, we simply pass on the wrapped activity’s terminal signal, making the <code>Upload</code> activity either continue from <code>success</code> or from <code>failure</code>.</p>

<p><span class="divider"></span></p>

<h3 id="macro-wrap-transaction">Transaction</h3>
<p><!-- {macro-wrap-transaction-toc} --></p>

<p>Wrapping steps into a real database transaction, and rolling back in case of a failure outcome in one of the steps, could look like so.</p>

<pre><code>class MyTransaction
  def self.call((ctx, flow_options), **)
    handler_signal = nil # this is the signal we decide to return from Wrap().

    ActiveRecord::Base.transaction do
      signal, (ctx, flow_options) = yield # call the Wrap block

      # It's now up to us to interpret the wrapped activity's outcome.
      terminus_semantic = signal.to_h[:semantic]

      if [:success, :pass_fast].include?(terminus_semantic)
        handler_signal = Trailblazer::Activity::Right
      else # something in the wrapped steps went wrong:
        handler_signal = Trailblazer::Activity::Left

        raise ActiveRecord::Rollback # This is the only way to tell ActiveRecord to rollback!
      end
    end # transaction

    return handler_signal, [ctx, flow_options]
  end
end
</code></pre>

<p>This might look a bit clumsy, but most of the code is very straight-forward.</p>

<ol>
  <li>Your main intent, wrapping a sequence of steps into an <code>ActiveRecord::Base.transaction</code> block, contains the <code>yield</code> invocation that runs the wrapped steps.</li>
  <li>Having the <code>signal</code> of the wrapped activity returned, you can decide how you’d like to interpret that. Usually, looking at the signals <code>:semantic</code> field indicates the outcome.</li>
  <li>In case you’re not happy, a <code>raise ActiveRecord::Rollback</code> will make ActiveRecord undo whatever database commits happened in the block.</li>
  <li>Instead of returning the nested activity’s <code>signal</code>, which is completely legit, <code>Wrap()</code> also allows you to return a <code>Right</code> or <code>Left</code> signal to communicate the outcome of the entire <code>Wrap()</code> component.</li>
</ol>

</div>

                <aside>
                  <span class="deco-purple-cross wow fadeIn"></span>
                </aside>
              </main>

              <div class="d-none d-xl-block col-xl-2 list-group sidebar-scroll order-3">
                <img alt="Trailblazer" class="wow fadeIn" src="/vite-dev/images/deco1.webp" />
                <div class="features" id="macro-overview-features">
  <h3>
    <i class="fas fa-times"></i>
    <span>Overview</span>
  </h3>

  <ul class="vertical menu">
    
      <li>
        <a href="#macro-overview-general-notes">
          <i class="fas fa-arrow-right"></i>
          General notes
        </a>
      </li>
      
        
        <li class="sub-item">
          <a href="#macro-overview-general-notes-variable-mapping">Variable mapping</a>
        </li>
      
    
  </ul>
</div>

<div class="features" id="macro-nested-features">
  <h3>
    <i class="fas fa-times"></i>
    <span>Nested</span>
  </h3>

  <ul class="vertical menu">
    
      <li>
        <a href="#macro-nested-dynamic">
          <i class="fas fa-arrow-right"></i>
          Dynamic
        </a>
      </li>
      
        
        <li class="sub-item">
          <a href="#macro-nested-dynamic-decider">Decider</a>
        </li>
      
        
        <li class="sub-item">
          <a href="#macro-nested-dynamic-nested-activity">Nested activity</a>
        </li>
      
    
      <li>
        <a href="#macro-nested-auto_wire">
          <i class="fas fa-arrow-right"></i>
          Auto_wire
        </a>
      </li>
      
        
        <li class="sub-item">
          <a href="#macro-nested-auto_wire-output-wiring">Output Wiring</a>
        </li>
      
        
        <li class="sub-item">
          <a href="#macro-nested-auto_wire-debugging">Debugging</a>
        </li>
      
    
  </ul>
</div>

<div class="features" id="macro-wrap-features">
  <h3>
    <i class="fas fa-times"></i>
    <span>Wrap</span>
  </h3>

  <ul class="vertical menu">
    
      <li>
        <a href="#macro-wrap-wrap-handler">
          <i class="fas fa-arrow-right"></i>
          Wrap handler
        </a>
      </li>
      
    
      <li>
        <a href="#macro-wrap-transaction">
          <i class="fas fa-arrow-right"></i>
          Transaction
        </a>
      </li>
      
    
  </ul>
</div>

              </div>
            </div>
          </div>
        </section>
      </main>

      <footer class="trailblazer-footer">
  <div class="container">
    <div class="row align-items-center">
      <div class="col-md-3 col-lg-2">
        <a href="/2.1/index.html" class="logo-footer">Trailblazer</a>
      </div>
      <div class="col-md-6 col-lg-8">
        <nav>
          <ul class="navbar-nav documentation-nav-items">
  <li>
    <a class="nav-item nav-link active" href="/2.1/docs/trailblazer.html">
      <i class="fas fa-arrow-right"></i>
      DOCS
    </a>
  </li>

  <li>
    <a class="nav-item nav-link " href="https://dev.to/trailblazer">BLOG</a>
  </li>

  <li class="">
    <a class="nav-item nav-link " href="/2.1/about_us.html">ABOUT US</a>
  </li>

  <li>
    <a class="nav-item nav-link " href="/2.1/learn.html">LEARN</a>
  </li>

  <li class="">
    <a class="nav-item nav-link" href="/2.0/index.html">
      <i class="fas fa-arrow-right"></i>
      2.0
    </a>
  </li>

  <li>
    <a class="nav-item nav-link" href="https://trailblazer.zulipchat.com" target="_blank">
      <i class="fas fa-comments"></i>
      CHAT
    </a>
  </li>

  <!--
  
  -->
</ul>

        </nav>
      </div>
      <div class="col-md-3 col-lg-2">
        <ul class="social purple">
          <li>
            <a href="https://github.com/trailblazer" target="_blank"><i class="fab fa-github-square"></i></a>
          </li>
          <li>
            <a href="https://www.facebook.com/trailblazer.to" target="_blank"><i class="fab fa-facebook-square"></i></a>
          </li>
          <li>
            <a href="https://twitter.com/trailblazer_to" target="_blank"><i class="fab fa-twitter-square"></i></a>
          </li>
        </ul>
      </div>
    </div>
  </div>
</footer>

    </div>
  </body>
</html>
